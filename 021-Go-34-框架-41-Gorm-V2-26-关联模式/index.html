

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2488174175014870" crossorigin="anonymous"></script><!-- google 广告 -->
  <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Go">
  <meta name="keywords" content="">
  
    <meta name="description" content="自动创建、更新GORM在创建或更新记录时会自动地保存其关联和引用，主要使用upsert技术来更新现有关联的外键引用。 在创建时自动保存关联当你创建一条新的记录时，GORM会自动保存它的关联数据。 这个过程包括向关联表插入数据以及维护外键引用。 12345678910111213141516171819202122232425user :&#x3D; User&amp;#123;  Name:">
<meta property="og:type" content="article">
<meta property="og:title" content="26-关联模式">
<meta property="og:url" content="https://flepeng.github.io/021-Go-34-%E6%A1%86%E6%9E%B6-41-Gorm-V2-26-%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F/index.html">
<meta property="og:site_name" content="Lepeng">
<meta property="og:description" content="自动创建、更新GORM在创建或更新记录时会自动地保存其关联和引用，主要使用upsert技术来更新现有关联的外键引用。 在创建时自动保存关联当你创建一条新的记录时，GORM会自动保存它的关联数据。 这个过程包括向关联表插入数据以及维护外键引用。 12345678910111213141516171819202122232425user :&#x3D; User&amp;#123;  Name:">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-12-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-03T10:25:30.284Z">
<meta property="article:author" content="Feng Lepeng">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>26-关联模式 - Lepeng</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"flepeng.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f3d259b9efd9ce8655c180fd01bf0045","google":{"measurement_id":"G-LFTE4C7W3W"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f3d259b9efd9ce8655c180fd01bf0045";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-LFTE4C7W3W", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-LFTE4C7W3W');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lepeng 的 blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="26-关联模式"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-04 00:00" pubdate>
          2024年12月4日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          14 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">26-关联模式</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="自动创建、更新"><a href="#自动创建、更新" class="headerlink" title="自动创建、更新"></a>自动创建、更新</h2><p>GORM在创建或更新记录时会自动地保存其关联和引用，主要使用upsert技术来更新现有关联的外键引用。</p>
<h3 id="在创建时自动保存关联"><a href="#在创建时自动保存关联" class="headerlink" title="在创建时自动保存关联"></a>在创建时自动保存关联</h3><p>当你创建一条新的记录时，GORM会自动保存它的关联数据。 这个过程包括向关联表插入数据以及维护外键引用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">user := User&#123;<br>  Name:            <span class="hljs-string">"jinzhu"</span>,<br>  BillingAddress:  Address&#123;Address1: <span class="hljs-string">"Billing Address - Address 1"</span>&#125;,<br>  ShippingAddress: Address&#123;Address1: <span class="hljs-string">"Shipping Address - Address 1"</span>&#125;,<br>  Emails:          []Email&#123;<br>    &#123;Email: <span class="hljs-string">"jinzhu@example.com"</span>&#125;,<br>    &#123;Email: <span class="hljs-string">"jinzhu-2@example.com"</span>&#125;,<br>  &#125;,<br>  Languages:       []Language&#123;<br>    &#123;Name: <span class="hljs-string">"ZH"</span>&#125;,<br>    &#123;Name: <span class="hljs-string">"EN"</span>&#125;,<br>  &#125;,<br>&#125;<br><br><span class="hljs-comment">// 创建用户及其关联的地址、电子邮件和语言</span><br>db.Create(&amp;user)<br><span class="hljs-comment">// BEGIN TRANSACTION;</span><br><span class="hljs-comment">// INSERT INTO "addresses" (address1) VALUES ("Billing Address - Address 1"), ("Shipping Address - Address 1") ON DUPLICATE KEY DO NOTHING;</span><br><span class="hljs-comment">// INSERT INTO "users" (name,billing_address_id,shipping_address_id) VALUES ("jinzhu", 1, 2);</span><br><span class="hljs-comment">// INSERT INTO "emails" (user_id,email) VALUES (111, "jinzhu@example.com"), (111, "jinzhu-2@example.com") ON DUPLICATE KEY DO NOTHING;</span><br><span class="hljs-comment">// INSERT INTO "languages" ("name") VALUES ('ZH'), ('EN') ON DUPLICATE KEY DO NOTHING;</span><br><span class="hljs-comment">// INSERT INTO "user_languages" ("user_id","language_id") VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;</span><br><span class="hljs-comment">// COMMIT;</span><br><br>db.Save(&amp;user)<br></code></pre></td></tr></table></figure>

<h3 id="通过FullSaveAssociations来更新关联"><a href="#通过FullSaveAssociations来更新关联" class="headerlink" title="通过FullSaveAssociations来更新关联"></a>通过<code>FullSaveAssociations</code>来更新关联</h3><p>对于需要全面更新关联数据（不止外键）的情况，就应该使用 <code>FullSaveAssociations</code> 方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 更新用户并完全更新其所有关联</span><br>db.Session(&amp;gorm.Session&#123;FullSaveAssociations: <span class="hljs-literal">true</span>&#125;).Updates(&amp;user)<br><span class="hljs-comment">// SQL：完全更新地址、用户、电子邮件表，包括现有的关联记录</span><br></code></pre></td></tr></table></figure>

<p>使用<code>FullSaveAssociations</code> 方法来确保模型的整体状态，包括其所有关联都反映在了数据库中，从在应用中保持数据的完整性和一致性。</p>
<h2 id="跳过自动创建、更新"><a href="#跳过自动创建、更新" class="headerlink" title="跳过自动创建、更新"></a>跳过自动创建、更新</h2><p>GORM 提供了在创建或更新操作过程中跳过自动保存关联的灵活性。 通过使用<code>Select</code>或者<code>Omit</code>方法可以允许您指定具体哪些字段在操作中被包含或者排除</p>
<h3 id="使用Select-来指定字段范围"><a href="#使用Select-来指定字段范围" class="headerlink" title="使用Select 来指定字段范围"></a>使用<code>Select</code> 来指定字段范围</h3><p><code>Select</code>方法可以让您模型中的哪些字段应该被保存 也就是说只有被选中的字段会被包含在SQL中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">user := User&#123;<br>  <span class="hljs-comment">// 用户及关联的数据</span><br>&#125;<br><br><span class="hljs-comment">// 当插入用户的时候仅包含“Name”字段</span><br>db.Select(<span class="hljs-string">"Name"</span>).Create(&amp;user)<br><span class="hljs-comment">// SQL: INSERT INTO "users" (name) VALUES ("jinzhu");</span><br></code></pre></td></tr></table></figure>

<h3 id="使用Omit来排除字段或关联"><a href="#使用Omit来排除字段或关联" class="headerlink" title="使用Omit来排除字段或关联"></a>使用<code>Omit</code>来排除字段或关联</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 创建用户时跳过字段“BillingAddress”</span><br>db.Omit(<span class="hljs-string">"BillingAddress"</span>).Create(&amp;user)<br><br><span class="hljs-comment">// 创建用户时跳过全部关联关系</span><br>db.Omit(clause.Associations).Create(&amp;user)<br></code></pre></td></tr></table></figure>


<p><strong>注意:</strong> 对于多对多关联关系, GORM 会在创建连接表引用之前更新关联。 要跳过更新，可以使用<code>Omit</code>，参数为关联名后面跟着<code>.*</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 跳过更新"Languages"关联</span><br>db.Omit(<span class="hljs-string">"Languages.*"</span>).Create(&amp;user)<br></code></pre></td></tr></table></figure>

<p>跳过创建关联及其引用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 跳过创建 'Languages' 关联及其引用</span><br>db.Omit(<span class="hljs-string">"Languages"</span>).Create(&amp;user)<br></code></pre></td></tr></table></figure>


<p>通过使用 <code>Select</code> 和 <code>Omit</code>，你能够很好地调整GORM处理创建或更新您的模型的行为，同时让您也能控制关联关系的自动保存行为</p>
<h2 id="Select-x2F-Omit-关联字段"><a href="#Select-x2F-Omit-关联字段" class="headerlink" title="Select&#x2F;Omit 关联字段"></a>Select&#x2F;Omit 关联字段</h2><p>在GORM中创建或者更新记录时，可以使用<code>Select</code>和<code>Omit</code>方法来指定是否包含某个关联的字段</p>
<p>使用<code>Select</code>，你能够指定关联模型中的特定字段在保存主模型的时候是否被包含 在仅保存部分关联时这非常有用</p>
<p>而<code>Omit</code>则能够排除关联模型的特定字段。 这可能会在你想阻止关联模型的特定部分被更新时有用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">user := User&#123;<br>  Name:            <span class="hljs-string">"jinzhu"</span>,<br>  BillingAddress:  Address&#123;Address1: <span class="hljs-string">"Billing Address - Address 1"</span>, Address2: <span class="hljs-string">"addr2"</span>&#125;,<br>  ShippingAddress: Address&#123;Address1: <span class="hljs-string">"Shipping Address - Address 1"</span>, Address2: <span class="hljs-string">"addr2"</span>&#125;,<br>&#125;<br><br><span class="hljs-comment">// 创建用户和他的账单地址,邮寄地址,只包括账单地址指定的字段</span><br>db.Select(<span class="hljs-string">"BillingAddress.Address1"</span>, <span class="hljs-string">"BillingAddress.Address2"</span>).Create(&amp;user)<br><span class="hljs-comment">// SQL: 只使用地址1和地址2来创建用户和账单地址</span><br><br><span class="hljs-comment">// 创建用户和账单地址,邮寄地址,但不包括账单地址的指定字段</span><br>db.Omit(<span class="hljs-string">"BillingAddress.Address2"</span>, <span class="hljs-string">"BillingAddress.CreatedAt"</span>).Create(&amp;user)<br><span class="hljs-comment">// SQL: 创建用户和账单地址,省略'地址2'和创建时间字段</span><br></code></pre></td></tr></table></figure>

<h2 id="删除关联"><a href="#删除关联" class="headerlink" title="删除关联"></a>删除关联</h2><p>GORM 能在删除主模型时使用<code>Select</code>方法来删除关联关系(一对一、一对多、多对多)。 在删除时维护好数据完整性并确保关联数据被妥当管理上，这项特性非常有用。</p>
<p>你可以用<code>Select</code>来指定哪些关联应该随着主模型被删除</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Delete a user's account when deleting the user</span><br>db.Select(<span class="hljs-string">"Account"</span>).Delete(&amp;user)<br><br><span class="hljs-comment">// Delete a user's Orders and CreditCards associations when deleting the user</span><br>db.Select(<span class="hljs-string">"Orders"</span>, <span class="hljs-string">"CreditCards"</span>).Delete(&amp;user)<br><br><span class="hljs-comment">// Delete all of a user's has one, has many, and many2many associations</span><br>db.Select(clause.Associations).Delete(&amp;user)<br><br><span class="hljs-comment">// Delete each user's account when deleting multiple users</span><br>db.Select(<span class="hljs-string">"Account"</span>).Delete(&amp;users)<br></code></pre></td></tr></table></figure>


<p><strong>NOTE:</strong> It’s important to note that associations will be deleted only if the primary key of the deleting record is not zero. GORM uses these primary keys as conditions to delete the selected associations.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// This will not work as intended</span><br>db.Select(<span class="hljs-string">"Account"</span>).Where(<span class="hljs-string">"name = ?"</span>, <span class="hljs-string">"jinzhu"</span>).Delete(&amp;User&#123;&#125;)<br><span class="hljs-comment">// SQL: Deletes all users with name 'jinzhu', but their accounts won't be deleted</span><br><br><span class="hljs-comment">// Correct way to delete a user and their account</span><br>db.Select(<span class="hljs-string">"Account"</span>).Where(<span class="hljs-string">"name = ?"</span>, <span class="hljs-string">"jinzhu"</span>).Delete(&amp;User&#123;ID: <span class="hljs-number">1</span>&#125;)<br><span class="hljs-comment">// SQL: Deletes the user with name 'jinzhu' and ID '1', and the user's account</span><br><br><span class="hljs-comment">// Deleting a user with a specific ID and their account</span><br>db.Select(<span class="hljs-string">"Account"</span>).Delete(&amp;User&#123;ID: <span class="hljs-number">1</span>&#125;)<br><span class="hljs-comment">// SQL: Deletes the user with ID '1', and the user's account</span><br></code></pre></td></tr></table></figure>


<h2 id="关联模式"><a href="#关联模式" class="headerlink" title="关联模式"></a>关联模式</h2><p>Association Mode in GORM offers various helper methods to handle relationships between models, providing an efficient way to manage associated data.</p>
<p>To start Association Mode, specify the source model and the relationship’s field name. The source model must contain a primary key, and the relationship’s field name should match an existing association.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> user User<br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>)<br><span class="hljs-comment">// Check for errors</span><br>error := db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Error<br></code></pre></td></tr></table></figure>

<h3 id="查询关联"><a href="#查询关联" class="headerlink" title="查询关联"></a>查询关联</h3><p>Retrieve associated records with or without additional conditions.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Simple find</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Find(&amp;languages)<br><br><span class="hljs-comment">// Find with conditions</span><br>codes := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"zh-CN"</span>, <span class="hljs-string">"en-US"</span>, <span class="hljs-string">"ja-JP"</span>&#125;<br>db.Model(&amp;user).Where(<span class="hljs-string">"code IN ?"</span>, codes).Association(<span class="hljs-string">"Languages"</span>).Find(&amp;languages)<br></code></pre></td></tr></table></figure>

<h3 id="追加关联"><a href="#追加关联" class="headerlink" title="追加关联"></a>追加关联</h3><p>Add new associations for <code>many to many</code>, <code>has many</code>, or replace the current association for <code>has one</code>, <code>belongs to</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Append new languages</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Append([]Language&#123;languageZH, languageEN&#125;)<br><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Append(&amp;Language&#123;Name: <span class="hljs-string">"DE"</span>&#125;)<br><br>db.Model(&amp;user).Association(<span class="hljs-string">"CreditCard"</span>).Append(&amp;CreditCard&#123;Number: <span class="hljs-string">"411111111111"</span>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="替换关联"><a href="#替换关联" class="headerlink" title="替换关联"></a>替换关联</h3><p>Replace current associations with new ones.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Replace existing languages</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Replace([]Language&#123;languageZH, languageEN&#125;)<br><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Replace(Language&#123;Name: <span class="hljs-string">"DE"</span>&#125;, languageEN)<br></code></pre></td></tr></table></figure>

<h3 id="删除关联-1"><a href="#删除关联-1" class="headerlink" title="删除关联"></a>删除关联</h3><p>Remove the relationship between the source and arguments, only deleting the reference.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Delete specific languages</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Delete([]Language&#123;languageZH, languageEN&#125;)<br><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Delete(languageZH, languageEN)<br></code></pre></td></tr></table></figure>

<h3 id="清空关联"><a href="#清空关联" class="headerlink" title="清空关联"></a>清空关联</h3><p>Remove all references between the source and association.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Clear all languages</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Clear()<br></code></pre></td></tr></table></figure>

<h3 id="关联计数"><a href="#关联计数" class="headerlink" title="关联计数"></a>关联计数</h3><p>Get the count of current associations, with or without conditions.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Count all languages</span><br>db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Count()<br><br><span class="hljs-comment">// Count with conditions</span><br>codes := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"zh-CN"</span>, <span class="hljs-string">"en-US"</span>, <span class="hljs-string">"ja-JP"</span>&#125;<br>db.Model(&amp;user).Where(<span class="hljs-string">"code IN ?"</span>, codes).Association(<span class="hljs-string">"Languages"</span>).Count()<br></code></pre></td></tr></table></figure>

<h3 id="批量数据处理"><a href="#批量数据处理" class="headerlink" title="批量数据处理"></a>批量数据处理</h3><p>Association Mode allows you to handle relationships for multiple records in a batch. This includes finding, appending, replacing, deleting, and counting operations for associated data.</p>
<ul>
<li><strong>Finding Associations</strong>: Retrieve associated data for a collection of records.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;users).Association(<span class="hljs-string">"Role"</span>).Find(&amp;roles)<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>Deleting Associations</strong>: Remove specific associations across multiple records.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;users).Association(<span class="hljs-string">"Team"</span>).Delete(&amp;userA)<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>Counting Associations</strong>: Get the count of associations for a batch of records.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;users).Association(<span class="hljs-string">"Team"</span>).Count()<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>Appending&#x2F;Replacing Associations</strong>: Manage associations for multiple records. Note the need for matching argument lengths with the data.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> users = []User&#123;user1, user2, user3&#125;<br><br><span class="hljs-comment">// Append different teams to different users in a batch</span><br><span class="hljs-comment">// Append userA to user1's team, userB to user2's team, and userA, userB, userC to user3's team</span><br>db.Model(&amp;users).Association(<span class="hljs-string">"Team"</span>).Append(&amp;userA, &amp;userB, &amp;[]User&#123;userA, userB, userC&#125;)<br><br><span class="hljs-comment">// Replace teams for multiple users in a batch</span><br><span class="hljs-comment">// Reset user1's team to userA, user2's team to userB, and user3's team to userA, userB, and userC</span><br>db.Model(&amp;users).Association(<span class="hljs-string">"Team"</span>).Replace(&amp;userA, &amp;userB, &amp;[]User&#123;userA, userB, userC&#125;)<br></code></pre></td></tr></table></figure>

<h2 id="删除关联记录"><a href="#删除关联记录" class="headerlink" title="删除关联记录"></a><span id="delete_association_record">删除关联记录</span></h2><p>In GORM, the <code>Replace</code>, <code>Delete</code>, and <code>Clear</code> methods in Association Mode primarily affect the foreign key references, not the associated records themselves. Understanding and managing this behavior is crucial for data integrity.</p>
<ul>
<li><strong>Reference Update</strong>: These methods update the association’s foreign key to null, effectively removing the link between the source and associated models.</li>
<li><strong>No Physical Record Deletion</strong>: The actual associated records remain untouched in the database.</li>
</ul>
<h3 id="通过Unscoped来变更默认的删除行为"><a href="#通过Unscoped来变更默认的删除行为" class="headerlink" title="通过Unscoped来变更默认的删除行为"></a>通过<code>Unscoped</code>来变更默认的删除行为</h3><p>For scenarios requiring actual deletion of associated records, the <code>Unscoped</code> method alters this behavior.</p>
<ul>
<li><strong>Soft Delete</strong>: Marks associated records as deleted (sets <code>deleted_at</code> field) without removing them from the database.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Unscoped().Clear()<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>Permanent Delete</strong>: Physically deletes the association records from the database.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// db.Unscoped().Model(&amp;user)</span><br>db.Unscoped().Model(&amp;user).Association(<span class="hljs-string">"Languages"</span>).Unscoped().Clear()<br></code></pre></td></tr></table></figure>

<h2 id="关联标签（Association-Tags）"><a href="#关联标签（Association-Tags）" class="headerlink" title="关联标签（Association Tags）"></a><span id="tags">关联标签（Association Tags）</span></h2><p>GORM中的关联标签通常用于指定如何处理模型之间的关联。 这些标签定义了一些关系细节，比如外键，引用和约束。 理解这些标签对于有效地建立和管理模型之间的关系而言至关重要。</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>foreignKey</code></td>
<td>Specifies the column name of the current model used as a foreign key in the join table.</td>
</tr>
<tr>
<td><code>references</code></td>
<td>Indicates the column name in the reference table that the foreign key of the join table maps to.</td>
</tr>
<tr>
<td><code>polymorphic</code></td>
<td>Defines the polymorphic type, typically the model name.</td>
</tr>
<tr>
<td><code>polymorphicValue</code></td>
<td>Sets the polymorphic value, usually the table name, if not specified otherwise.</td>
</tr>
<tr>
<td><code>many2many</code></td>
<td>Names the join table used in a many-to-many relationship.</td>
</tr>
<tr>
<td><code>joinForeignKey</code></td>
<td>Identifies the foreign key column in the join table that maps back to the current model’s table.</td>
</tr>
<tr>
<td><code>joinReferences</code></td>
<td>Points to the foreign key column in the join table that links to the reference model’s table.</td>
</tr>
<tr>
<td><code>constraint</code></td>
<td>Specifies relational constraints like <code>OnUpdate</code>, <code>OnDelete</code> for the association.</td>
</tr>
</tbody></table>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Go/" class="category-chain-item">Go</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Go/" class="print-no-link">#Go</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>26-关联模式</div>
      <div>https://flepeng.github.io/021-Go-34-框架-41-Gorm-V2-26-关联模式/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Go</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/021-Go-34-%E6%A1%86%E6%9E%B6-41-Gorm-V2-25-polymorphism/" title="25-polymorphism">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">25-polymorphism</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/021-Go-34-%E6%A1%86%E6%9E%B6-41-Gorm-V2-27-%E9%A2%84%E5%8A%A0%E8%BD%BD/" title="27-预加载">
                        <span class="hidden-mobile">27-预加载</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"flepeng/hexo-blog-comment","repo-id":"R_kgDOL0qaig","category":"Announcements","category-id":"DIC_kwDOL0qais4CfBIv","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
