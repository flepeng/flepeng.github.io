

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2488174175014870" crossorigin="anonymous"></script><!-- google 广告 -->
  <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lepeng">
  <meta name="keywords" content="">
  
    <meta name="description" content="文档：http:&#x2F;&#x2F;sdiehl.github.io&#x2F;gevent-tutorial&#x2F;#contributors github：https:&#x2F;&#x2F;github.com&#x2F;sdiehl&#x2F;gevent-tutorial github：https:&#x2F;&#x2F;github.com&#x2F;panguangyu&#x2F;gevent-tutorial-chinese   核心Greenletsgevent 中使用的主要模式是 G">
<meta property="og:type" content="article">
<meta property="og:title" content="Python 第三方模块之 Gevent - 协程（官方）">
<meta property="og:url" content="https://flepeng.github.io/021-Python-33-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97-01-%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B-%E7%9B%B8%E5%85%B3-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E4%B9%8B-Gevent-%E5%8D%8F%E7%A8%8B%EF%BC%88%E5%AE%98%E6%96%B9%EF%BC%89/index.html">
<meta property="og:site_name" content="Lepeng">
<meta property="og:description" content="文档：http:&#x2F;&#x2F;sdiehl.github.io&#x2F;gevent-tutorial&#x2F;#contributors github：https:&#x2F;&#x2F;github.com&#x2F;sdiehl&#x2F;gevent-tutorial github：https:&#x2F;&#x2F;github.com&#x2F;panguangyu&#x2F;gevent-tutorial-chinese   核心Greenletsgevent 中使用的主要模式是 G">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flepeng.github.io/img/python/gevent/flow.gif">
<meta property="article:published_time" content="2016-08-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-03T10:25:30.335Z">
<meta property="article:author" content="Feng Lepeng">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Python 第三方模块">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://flepeng.github.io/img/python/gevent/flow.gif">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Python 第三方模块之 Gevent - 协程（官方） - Lepeng</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"flepeng.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f3d259b9efd9ce8655c180fd01bf0045","google":{"measurement_id":"G-LFTE4C7W3W"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f3d259b9efd9ce8655c180fd01bf0045";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-LFTE4C7W3W", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-LFTE4C7W3W');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lepeng 的 blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Python 第三方模块之 Gevent - 协程（官方）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2016-08-03 00:00" pubdate>
          2016年8月3日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          48 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Python 第三方模块之 Gevent - 协程（官方）</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<ul>
<li>文档：<a href="http://sdiehl.github.io/gevent-tutorial/#contributors" target="_blank" rel="noopener">http://sdiehl.github.io/gevent-tutorial/#contributors</a></li>
<li>github：<a href="https://github.com/sdiehl/gevent-tutorial" target="_blank" rel="noopener">https://github.com/sdiehl/gevent-tutorial</a></li>
<li>github：<a href="https://github.com/panguangyu/gevent-tutorial-chinese" target="_blank" rel="noopener">https://github.com/panguangyu/gevent-tutorial-chinese</a></li>
</ul>
</blockquote>
<h2 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h2><h3 id="Greenlets"><a href="#Greenlets" class="headerlink" title="Greenlets"></a>Greenlets</h3><p>gevent 中使用的主要模式是 Greenlet，这是作为 C 扩展模块提供给 Python 的一个轻量级协同程序。所有 greenlet 都在主程序的 OS 进程中运行，但它们是协同调度的。</p>
<p>在任何给定的时间内，只有一个 greenlet 在运行。</p>
<p>这不同于由 multiprocessing 或 threading 库提供的并行结构，它们这些库可以自旋进程和 POSIX 线程，由操作系统调度，并且真正并行的。</p>
<h3 id="异步和同步执行"><a href="#异步和同步执行" class="headerlink" title="异步和同步执行"></a>异步和同步执行</h3><p>并发性的核心思想是，可以将较大的任务分解为多个子任务的集合，这些子任务计划同时或异步运行，而不是一次或同步运行。两个子任务之间的切换称为上下文切换。</p>
<p>gevent 中的上下文切换是通过 yielding 来完成的。在本例中，我们有两个上下文，它们通过调用 gevent.sleep(0) 相互让步。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span>:</span><br>    print(<span class="hljs-string">'Running in foo'</span>)<br>    gevent.sleep(<span class="hljs-number">0</span>)<br>    print(<span class="hljs-string">'Explicit context switch to foo again'</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bar</span><span class="hljs-params">()</span>:</span><br>    print(<span class="hljs-string">'Explicit context to bar'</span>)<br>    gevent.sleep(<span class="hljs-number">0</span>)<br>    print(<span class="hljs-string">'Implicit context switch back to bar'</span>)<br><br>gevent.joinall([<br>    gevent.spawn(foo),<br>    gevent.spawn(bar),<br>])<br></code></pre></td></tr></table></figure>

<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran">Running <span class="hljs-keyword">in</span> foo<br>Explicit context to bar<br>Explicit context switch to foo again<br><span class="hljs-keyword">Implicit</span> context switch back to bar<br></code></pre></td></tr></table></figure>

<p><img src="/img/python/gevent/flow.gif" srcset="/img/loading.gif" lazyload></p>
<p>当我们将 gevent 用于网络和 IO 绑定函数时，它的真正威力就来了，这些函数可以协同调度。Gevent 负责处理所有细节，以确保网络库尽可能隐式地让步出它们的 greenlet 上下文。我再怎么强调这是一个多么有力的成语也不为过。但也许可以举个例子来说明。</p>
<p>在这种情况下，<code>select()</code> 函数通常是一个阻塞调用，它轮询各种文件描述符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> select<br><br>start = time.time()<br>tic = <span class="hljs-keyword">lambda</span>: <span class="hljs-string">'at %1.1f seconds'</span> % (time.time() - start)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gr1</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-comment"># Busy waits for a second, but we don't want to stick around...</span><br>    print(<span class="hljs-string">'Started Polling: %s'</span> % tic())<br>    select.select([], [], [], <span class="hljs-number">2</span>)                 <br>    <span class="hljs-comment"># 可以理解成一个 IO 阻塞的操作，阻塞了2秒，这时 Greenlet 会自动切换到 gr2() 上下文执行 </span><br>    print(<span class="hljs-string">'Ended Polling: %s'</span> % tic())<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gr2</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-comment"># Busy waits for a second, but we don't want to stick around...</span><br>    print(<span class="hljs-string">'Started Polling: %s'</span> % tic())<br>    select.select([], [], [], <span class="hljs-number">2</span>)<br>    print(<span class="hljs-string">'Ended Polling: %s'</span> % tic())<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gr3</span><span class="hljs-params">()</span>:</span><br>    print(<span class="hljs-string">"Hey lets do some stuff while the greenlets poll, %s"</span> % tic())<br>    gevent.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 让当前 Greenlet 休眠1秒，上面 gr1() gr2() 阻塞操作完成后，再切换到 gr1() gr2() 的上下文执行</span><br><br>gevent.joinall([<br>    gevent.spawn(gr1),<br>    gevent.spawn(gr2),<br>    gevent.spawn(gr3),<br>])<br></code></pre></td></tr></table></figure>

<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Started Polling: <span class="hljs-keyword">at</span> <span class="hljs-number">0.0</span> <span class="hljs-built_in">seconds</span><br>Started Polling: <span class="hljs-keyword">at</span> <span class="hljs-number">0.0</span> <span class="hljs-built_in">seconds</span><br>Hey lets <span class="hljs-built_in">do</span> some stuff <span class="hljs-keyword">while</span> <span class="hljs-keyword">the</span> greenlets poll, <span class="hljs-keyword">at</span> <span class="hljs-number">0.0</span> <span class="hljs-built_in">seconds</span><br>Ended Polling: <span class="hljs-keyword">at</span> <span class="hljs-number">2.0</span> <span class="hljs-built_in">seconds</span><br>Ended Polling: <span class="hljs-keyword">at</span> <span class="hljs-number">2.0</span> <span class="hljs-built_in">seconds</span><br></code></pre></td></tr></table></figure>

<p>另一个比较综合的例子定义了一个不确定的任务函数 (它的输出不能保证对相同的输入给出相同的结果) 。在这种情况下，运行该函数的副作用是任务暂停执行的时间是随机的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">task</span><span class="hljs-params">(pid)</span>:</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Some non-deterministic task</span><br><span class="hljs-string">    """</span><br>    gevent.sleep(random.randint(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)*<span class="hljs-number">0.001</span>)<br>    print(<span class="hljs-string">'Task %s done'</span> % pid)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">synchronous</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        task(i)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">asynchronous</span><span class="hljs-params">()</span>:</span><br>    threads = [gevent.spawn(task, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>)]<br>    gevent.joinall(threads)<br><br>print(<span class="hljs-string">'Synchronous:'</span>)<br>synchronous()<br><br>print(<span class="hljs-string">'Asynchronous:'</span>)<br>asynchronous()<br></code></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">Synchronous</span>:<span class="hljs-string"></span><br><span class="hljs-attr">Task</span> <span class="hljs-string">1 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">2 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">3 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">4 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">5 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">6 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">7 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">8 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">9 done</span><br><span class="hljs-attr">Asynchronous</span>:<span class="hljs-string"></span><br><span class="hljs-attr">Task</span> <span class="hljs-string">1 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">5 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">6 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">2 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">4 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">7 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">8 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">9 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">0 done</span><br><span class="hljs-attr">Task</span> <span class="hljs-string">3 done</span><br></code></pre></td></tr></table></figure>

<p>在同步情况下，所有任务都是按顺序运行的，这会导致在执行每个任务时主程序阻塞(即暂停主程序的执行)。</p>
<p>程序的重要部分是 <code>gevent.spawn</code>，它将给定的函数封装在一个 Greenlet 线程中。初始化的 greenlet 列表存储在传递给 gevent 的数组线程中。<code>gevent.joinall</code> 函数，它会阻塞当前程序，来运行所有给定的 greenlet。只有当所有 greenlet 终止时，执行才会继续进行。</p>
<p>需要注意的是，异步情况下的执行顺序本质上是随机的，异步情况下的总执行时间比同步情况下少得多。实际上，同步的例子完成的最大时间是每个任务停顿0.002秒，导致整个队列停顿0.02秒。在异步情况下，最大运行时间大约为0.002秒，因为没有一个任务会阻塞其他任务的执行。</p>
<p>在更常见的用例中，异步地从服务器获取数据，<code>fetch()</code> 的运行时在请求之间会有所不同，这取决于请求时远程服务器上的负载。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent.monkey<br>gevent.monkey.patch_socket()<br><span class="hljs-comment"># 把内置的阻塞的 socket替换成非阻塞的socket</span><br><br><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">import</span> urllib2<br><span class="hljs-keyword">import</span> simplejson <span class="hljs-keyword">as</span> json<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span><span class="hljs-params">(pid)</span>:</span><br>    response = urllib2.urlopen(<span class="hljs-string">'http://json-time.appspot.com/time.json'</span>)<br>    result = response.read()<br>    json_result = json.loads(result)<br>    datetime = json_result[<span class="hljs-string">'datetime'</span>]<br><br>    print(<span class="hljs-string">'Process %s: %s'</span> % (pid, datetime))<br>    <span class="hljs-keyword">return</span> json_result[<span class="hljs-string">'datetime'</span>]<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">synchronous</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        fetch(i)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">asynchronous</span><span class="hljs-params">()</span>:</span><br>    threads = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        threads.append(gevent.spawn(fetch, i))<br>    gevent.joinall(threads)<br><br>print(<span class="hljs-string">'Synchronous:'</span>)<br>synchronous()<br><br>print(<span class="hljs-string">'Asynchronous:'</span>)<br>asynchronous()<br></code></pre></td></tr></table></figure>


<h3 id="确定性"><a href="#确定性" class="headerlink" title="确定性"></a>确定性</h3><p>如前所述，greenlet 是确定的。给定相同的 greenlet 配置和相同的输入集，它们总是产生相同的输出。例如，让我们将一个任务分散到一个多进程（multiprocessing）池中，并将其结果与一个 gevent 池的结果进行比较。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">echo</span><span class="hljs-params">(i)</span>:</span><br>    time.sleep(<span class="hljs-number">0.001</span>)<br>    <span class="hljs-keyword">return</span> i<br><br><span class="hljs-comment"># Non Deterministic Process Pool</span><br><br><span class="hljs-keyword">from</span> multiprocessing.pool <span class="hljs-keyword">import</span> Pool<br><br>p = Pool(<span class="hljs-number">10</span>)<br>run1 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]          <span class="hljs-comment"># imap_unordered 返回一个顺序随机的 iterable 对象</span><br>run2 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]<br>run3 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]<br>run4 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]<br><br>print(run1 == run2 == run3 == run4)<br><br><span class="hljs-comment"># Deterministic Gevent Pool</span><br><br><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Pool<br><br>p = Pool(<span class="hljs-number">10</span>)<br>run1 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]      <span class="hljs-comment"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span><br>run2 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]      <span class="hljs-comment"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span><br>run3 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]      <span class="hljs-comment"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span><br>run4 = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> p.imap_unordered(echo, range(<span class="hljs-number">10</span>))]      <span class="hljs-comment"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span><br><br>print(run1 == run2 == run3 == run4)<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-literal">False</span><br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>

<p>尽管 gevent 通常是确定的，但当您开始与外部服务(如 socket 和文件)进行交互时，非确定性的来源可能会潜入您的程序。因此，即使 green 线程是确定性并发的一种形式，它们仍然会遇到POSIX线程和进程遇到的一些相同的问题。</p>
<p>与并发有关的长期问题称为竞争条件。简而言之，当两个并发线程&#x2F;进程依赖于某些共享资源但还试图修改该值时，就会发生竞争状态。这将导致资源的值变得依赖于执行顺序。这是一个问题，一般来说，应该尽量避免竞态条件，因为它们会导致全局的不确定程序行为。</p>
<p>最好的方法是在任何时候都避免所有全局状态。全局状态和导入时间的副作用总是会回来咬你一口</p>
<h3 id="生成-Greenlets"><a href="#生成-Greenlets" class="headerlink" title="生成 Greenlets"></a>生成 Greenlets</h3><p>gevent 提供了一些关于 Greenlet 初始化的包装器。一些最常见的模式是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> Greenlet<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span><span class="hljs-params">(message, n)</span>:</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Each thread will be passed the message, and n arguments</span><br><span class="hljs-string">    in its initialization.</span><br><span class="hljs-string">    """</span><br>    gevent.sleep(n)<br>    print(message)<br><br><span class="hljs-comment"># Initialize a new Greenlet instance running the named function</span><br><span class="hljs-comment"># foo</span><br>thread1 = Greenlet.spawn(foo, <span class="hljs-string">"Hello"</span>, <span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># Wrapper for creating and running a new Greenlet from the named</span><br><span class="hljs-comment"># function foo, with the passed arguments</span><br>thread2 = gevent.spawn(foo, <span class="hljs-string">"I live!"</span>, <span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Lambda expressions</span><br>thread3 = gevent.spawn(<span class="hljs-keyword">lambda</span> x: (x+<span class="hljs-number">1</span>), <span class="hljs-number">2</span>)<br><br>threads = [thread1, thread2, thread3]<br><br><span class="hljs-comment"># Block until all threads complete.</span><br>gevent.joinall(threads)<br></code></pre></td></tr></table></figure>

<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl">Hello<br>I live!<br></code></pre></td></tr></table></figure>

<p>除了使用基本的Greenlet类，您还可以子类化 Greenlet 类并覆盖 _run 方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> Greenlet<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyGreenlet</span><span class="hljs-params">(Greenlet)</span>:</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, message, n)</span>:</span><br>        Greenlet.__init__(self)<br>        self.message = message<br>        self.n = n<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run</span><span class="hljs-params">(self)</span>:</span><br>        print(self.message)<br>        gevent.sleep(self.n)<br><br>g = MyGreenlet(<span class="hljs-string">"Hi there!"</span>, <span class="hljs-number">3</span>)<br>g.start()<br>g.join()<br></code></pre></td></tr></table></figure>

<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl">Hi there!<br></code></pre></td></tr></table></figure>


<h3 id="Greenlets-状态"><a href="#Greenlets-状态" class="headerlink" title="Greenlets 状态"></a>Greenlets 状态</h3><p>与代码的其他部分一样，greenlet 可能以各种方式失败。greenlet 可能无法抛出异常、无法停止或消耗太多系统资源。</p>
<p>greenlet 的内部状态通常是一个与时间相关的参数。在 greenlets 上有许多标志，它们允许您监视线程的状态：</p>
<ul>
<li><code>started</code> – 布尔值，指示Greenlet是否已启动</li>
<li><code>ready()</code> – 布尔值，指示Greenlet是否已停止</li>
<li><code>successful()</code> – 布尔值，指示Greenlet是否已停止且没有抛出异常</li>
<li><code>value</code> – Greenlet返回的值</li>
<li><code>exception</code> – 异常，在greenlet中抛出的未捕获异常实例</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">win</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">'You win!'</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fail</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">'You fail at failing.'</span>)<br><br>winner = gevent.spawn(win)<br>loser = gevent.spawn(fail)<br><br>print(winner.started) <span class="hljs-comment"># True</span><br>print(loser.started)  <span class="hljs-comment"># True</span><br><br><span class="hljs-comment"># Exceptions raised in the Greenlet, stay inside the Greenlet.</span><br><span class="hljs-keyword">try</span>:<br>    gevent.joinall([winner, loser])<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    print(<span class="hljs-string">'This will never be reached'</span>)<br><br>print(winner.value) <span class="hljs-comment"># 'You win!'</span><br>print(loser.value)  <span class="hljs-comment"># None</span><br><br>print(winner.ready()) <span class="hljs-comment"># True</span><br>print(loser.ready())  <span class="hljs-comment"># True</span><br><br>print(winner.successful()) <span class="hljs-comment"># True</span><br>print(loser.successful())  <span class="hljs-comment"># False</span><br><br><span class="hljs-comment"># The exception raised in fail, will not propagate outside the</span><br><span class="hljs-comment"># greenlet. A stack trace will be printed to stdout but it</span><br><span class="hljs-comment"># will not unwind the stack of the parent.</span><br><br>print(loser.exception)<br><br><span class="hljs-comment"># It is possible though to raise the exception again outside</span><br><span class="hljs-comment"># raise loser.exception</span><br><span class="hljs-comment"># or with</span><br><span class="hljs-comment"># loser.get()</span><br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-literal">True</span><br><span class="hljs-literal">True</span><br><span class="hljs-string">You</span> <span class="hljs-string">win!</span><br><span class="hljs-string">None</span><br><span class="hljs-literal">True</span><br><span class="hljs-literal">True</span><br><span class="hljs-literal">True</span><br><span class="hljs-literal">False</span><br><span class="hljs-string">You</span> <span class="hljs-string">fail</span> <span class="hljs-string">at</span> <span class="hljs-string">failing.</span><br></code></pre></td></tr></table></figure>


<h3 id="程序关闭"><a href="#程序关闭" class="headerlink" title="程序关闭"></a>程序关闭</h3><p>当主程序接收到 SIGQUIT 时，无法生成（yield）的 greenlet 可能会使程序的执行时间比预期的更长。这将导致所谓的“僵尸进程”，需要从 Python 解释器外部杀死这些进程。</p>
<p>一种常见的模式是监听主程序上的 SIGQUIT 事件并在退出前调用 <code>gevent.shutdown</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">import</span> signal<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_forever</span><span class="hljs-params">()</span>:</span><br>    gevent.sleep(<span class="hljs-number">1000</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    gevent.signal(signal.SIGQUIT, gevent.kill)<br>    thread = gevent.spawn(run_forever)<br>    thread.join()<br></code></pre></td></tr></table></figure>

<h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>超时是对代码块或 Greenlet 的运行时的约束。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> Timeout<br><br>seconds = <span class="hljs-number">10</span><br><br>timeout = Timeout(seconds)<br>timeout.start()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wait</span><span class="hljs-params">()</span>:</span><br>    gevent.sleep(<span class="hljs-number">10</span>)<br><br><span class="hljs-keyword">try</span>:<br>    gevent.spawn(wait).join()<br><span class="hljs-keyword">except</span> Timeout:<br>    print(<span class="hljs-string">'Could not complete'</span>)<br></code></pre></td></tr></table></figure>

<p>在 with 语句中，它们还可以与上下文管理器一起使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> Timeout<br><br>time_to_wait = <span class="hljs-number">5</span> <span class="hljs-comment"># seconds</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TooLong</span><span class="hljs-params">(Exception)</span>:</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">with</span> Timeout(time_to_wait, TooLong):<br>    gevent.sleep(<span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure>

<p>此外，gevent 还为各种 Greenlet 和数据结构相关的调用提供超时参数。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> Timeout<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wait</span><span class="hljs-params">()</span>:</span><br>    gevent.sleep(<span class="hljs-number">2</span>)<br><br>timer = Timeout(<span class="hljs-number">1</span>).start()<br>thread1 = gevent.spawn(wait)<br><br><span class="hljs-keyword">try</span>:<br>    thread1.join(timeout=timer)<br><span class="hljs-keyword">except</span> Timeout:<br>    print(<span class="hljs-string">'Thread 1 timed out'</span>)<br><br><span class="hljs-comment"># --</span><br><br>timer = Timeout.start_new(<span class="hljs-number">1</span>)<br>thread2 = gevent.spawn(wait)<br><br><span class="hljs-keyword">try</span>:<br>    thread2.get(timeout=timer)<br><span class="hljs-keyword">except</span> Timeout:<br>    print(<span class="hljs-string">'Thread 2 timed out'</span>)<br><br><span class="hljs-comment"># --</span><br><br><span class="hljs-keyword">try</span>:<br>    gevent.with_timeout(<span class="hljs-number">1</span>, wait)<br><span class="hljs-keyword">except</span> Timeout:<br>    print(<span class="hljs-string">'Thread 3 timed out'</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Thread <span class="hljs-number">1</span> timed <span class="hljs-keyword">out</span><br>Thread <span class="hljs-number">2</span> timed <span class="hljs-keyword">out</span><br>Thread <span class="hljs-number">3</span> timed <span class="hljs-keyword">out</span><br></code></pre></td></tr></table></figure>


<h3 id="猴子补丁"><a href="#猴子补丁" class="headerlink" title="猴子补丁"></a>猴子补丁</h3><p>我们来到了 Gevent 的黑暗角落。到目前为止，我一直避免提到 monkey patching，以尝试和激发强大的协同模式，但是现在是讨论 monkey patching 的黑魔法的时候了。<br>如果您注意到上面我们调用了命令 <code>monkey.patch_socket()</code>，这是一个纯粹用于修改标准库套接字库(socket)的副作用命令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> socket<br>print(socket.socket)<br><br>print(<span class="hljs-string">"After monkey patch"</span>)<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> monkey<br>monkey.patch_socket()<br>print(socket.socket)<br><br><span class="hljs-keyword">import</span> select<br>print(select.select)<br>monkey.patch_select()<br>print(<span class="hljs-string">"After monkey patch"</span>)<br>print(select.select)<br></code></pre></td></tr></table></figure>

<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">class</span> <span class="hljs-string">'socket.socket'</span><br><span class="hljs-keyword">After</span> monkey patch<br><span class="hljs-keyword">class</span> <span class="hljs-string">'gevent.socket.socket'</span><br><br>built-<span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> <span class="hljs-keyword">select</span><br><span class="hljs-keyword">After</span> monkey patch<br><span class="hljs-keyword">function</span> <span class="hljs-keyword">select</span> at <span class="hljs-number">0x1924de8</span><br></code></pre></td></tr></table></figure>

<p>Python 允许在运行时修改大多数对象，包括模块、类甚至函数。这通常是一个令人震惊的坏主意，因为它创建了一个“隐式副作用”，如果出现问题，通常非常难以调试，然而在极端情况下，库需要改变 Python 本身的基本行为，可以使用 monkey 补丁。在这种情况下，gevent 能够修补标准库中的大多数阻塞系统调用，包括 socket、ssl、threading 和 select 模块中的调用。</p>
<p>例如，Redis-python 的绑定通常使用常规 tcp socket 与 Redis-server 实例通信。只需调用 <code>gevent.monkey.patch_all()</code>，我们可以让 Redis 绑定协同调度请求，并与 gevent 堆栈的其他部分一起工作。</p>
<p>这让我们可以在不编写任何代码的情况下集成通常无法与 gevent 一起工作的库。（尽管猴子补丁仍然是邪恶的，但在这种情况下，它是“有用的邪恶”。）</p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="Events-事件"><a href="#Events-事件" class="headerlink" title="Events 事件"></a>Events 事件</h3><p>事件是 greenlet 之间异步通信的一种形式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.event <span class="hljs-keyword">import</span> Event<br><br><span class="hljs-string">'''</span><br><span class="hljs-string">Illustrates the use of events</span><br><span class="hljs-string">'''</span><br><br><br>evt = Event()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setter</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-string">'''After 3 seconds, wake all threads waiting on the value of evt'''</span><br>    print(<span class="hljs-string">'A: Hey wait for me, I have to do something'</span>)<br>    gevent.sleep(<span class="hljs-number">3</span>)<br>    print(<span class="hljs-string">"Ok, I'm done"</span>)<br>    evt.set()   <span class="hljs-comment"># 运行到evt.set()会将flag设置为True，然后另外两个被阻塞的waitter的evt.wait()方法在看到flag已经为True之后不再继续阻塞运行并且结束。</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waiter</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-string">'''After 3 seconds the get call will unblock'''</span><br>    print(<span class="hljs-string">"I'll wait for you"</span>)<br>    evt.wait()  <span class="hljs-comment"># blocking</span><br>    print(<span class="hljs-string">"It's about time"</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span><br>    gevent.joinall([<br>        gevent.spawn(setter),<br>        gevent.spawn(waiter),<br>        gevent.spawn(waiter),<br>        gevent.spawn(waiter),<br>        gevent.spawn(waiter),<br>        gevent.spawn(waiter)<br>    ])<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<p>事件对象的扩展是 AsyncResult，它允许您在唤醒调用时发送一个值。这有时被称为 future 或 deferred，因为它有对 future 值的引用，可以在任意的时间设置该值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.event <span class="hljs-keyword">import</span> AsyncResult<br><br>a = AsyncResult()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setter</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    After 3 seconds set the result of a.</span><br><span class="hljs-string">    """</span><br>    gevent.sleep(<span class="hljs-number">3</span>)<br>    a.set(<span class="hljs-string">'Hello!'</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waiter</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    After 3 seconds the get call will unblock after the setter</span><br><span class="hljs-string">    puts a value into the AsyncResult.</span><br><span class="hljs-string">    """</span><br>    print(a.get())<br><br>gevent.joinall([<br>    gevent.spawn(setter),<br>    gevent.spawn(waiter),<br>])<br></code></pre></td></tr></table></figure>


<h3 id="Queues-队列"><a href="#Queues-队列" class="headerlink" title="Queues 队列"></a>Queues 队列</h3><p>队列是按顺序排列的数据集，它们具有通常的 put &#x2F; get 操作，但可以在 Greenlets 上安全操作的方式编写。</p>
<p>例如，如果一个 Greenlet 从队列中获取一个项目(item)，则同一项目(item)不会被同时执行的另一个 Greenlet 获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.queue <span class="hljs-keyword">import</span> Queue<br><br>tasks = Queue()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span><span class="hljs-params">(n)</span>:</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> tasks.empty():<br>        task = tasks.get()<br>        print(<span class="hljs-string">'Worker %s got task %s'</span> % (n, task))<br>        gevent.sleep(<span class="hljs-number">0</span>)<br><br>    print(<span class="hljs-string">'Quitting time!'</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">boss</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">25</span>):<br>        tasks.put_nowait(i)<br><br>gevent.spawn(boss).join()<br><br>gevent.joinall([<br>    gevent.spawn(worker, <span class="hljs-string">'steve'</span>),<br>    gevent.spawn(worker, <span class="hljs-string">'john'</span>),<br>    gevent.spawn(worker, <span class="hljs-string">'nancy'</span>),<br>])<br></code></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 1</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 2</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 3</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 4</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 5</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 6</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 7</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 8</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 9</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 10</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 11</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 12</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 13</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 14</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 15</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 16</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 17</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 18</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 19</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 20</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 21</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 22</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 23</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">nancy got task 24</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br></code></pre></td></tr></table></figure>

<p>根据需要，队列还可以在 put 或 get 上阻塞。</p>
<p>每个 put 和 get 操作都有一个非阻塞的对应操作，put_nowait 和 get_nowait 不会阻塞。如果操作是不可能的，会引发 gevent.queue.Empty 或 gevent.queue.Full</p>
<p>在这个例子中，我们让 boss 同时和 workers 运行，并且对队列有一个限制，防止它包含三个以上的元素。这个限制意味着put操作将阻塞，直到队列上有空间为止。相反，如果队列上没有要获取的元素，get 操作就会阻塞，它还会接受一个超时参数，如果在超时的时间范围内找不到工作(work)，则允许队列以异常 <code>gevent.queue.Empty</code> 退出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.queue <span class="hljs-keyword">import</span> Queue, Empty<br><br>tasks = Queue(maxsize=<span class="hljs-number">3</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span><span class="hljs-params">(name)</span>:</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            task = tasks.get(timeout=<span class="hljs-number">1</span>) <span class="hljs-comment"># decrements queue size by 1</span><br>            print(<span class="hljs-string">'Worker %s got task %s'</span> % (name, task))<br>            gevent.sleep(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">except</span> Empty:<br>        print(<span class="hljs-string">'Quitting time!'</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">boss</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Boss will wait to hand out work until a individual worker is</span><br><span class="hljs-string">    free since the maxsize of the task queue is 3.</span><br><span class="hljs-string">    """</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        tasks.put(i)                            <span class="hljs-comment"># 输入1，2，3，到4时，队列达到最大值，put方法阻塞，gevent 切换到下一个协程worker（steve）</span><br>    print(<span class="hljs-string">'Assigned all work in iteration 1'</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>):<br>        tasks.put(i)<br>    print(<span class="hljs-string">'Assigned all work in iteration 2'</span>)<br><br>gevent.joinall([<br>    gevent.spawn(boss),<br>    gevent.spawn(worker, <span class="hljs-string">'steve'</span>),<br>    gevent.spawn(worker, <span class="hljs-string">'john'</span>),<br>    gevent.spawn(worker, <span class="hljs-string">'bob'</span>),<br>])<br></code></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 1</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 2</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 3</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 4</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 5</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 6</span><br><span class="hljs-attr">Assigned</span> <span class="hljs-string">all work in iteration 1</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 7</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 8</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 9</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 10</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 11</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 12</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 13</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 14</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 15</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 16</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">john got task 17</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">bob got task 18</span><br><span class="hljs-attr">Assigned</span> <span class="hljs-string">all work in iteration 2</span><br><span class="hljs-attr">Worker</span> <span class="hljs-string">steve got task 19</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br><span class="hljs-attr">Quitting</span> <span class="hljs-string">time!</span><br></code></pre></td></tr></table></figure>


<h3 id="Groups-and-Pools-分组和池"><a href="#Groups-and-Pools-分组和池" class="headerlink" title="Groups and Pools 分组和池"></a>Groups and Pools 分组和池</h3><p>组是运行中的 greenlet 的集合，这些 greenlet 作为组一起管理和调度。它还兼做并行调度程序，借鉴 Python multiprocessing 库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Group<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">talk</span><span class="hljs-params">(msg)</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):<br>        print(msg)<br><br>g1 = gevent.spawn(talk, <span class="hljs-string">'bar'</span>)<br>g2 = gevent.spawn(talk, <span class="hljs-string">'foo'</span>)         <br>g3 = gevent.spawn(talk, <span class="hljs-string">'fizz'</span>)  <br><br>group = Group()<br>group.add(g1)                           <br>group.join()                      <span class="hljs-comment"># 修改了官方的例子，这里join只会让当前线程等待g1，但g2和g3已经被启动，会被继续安排执行</span><br></code></pre></td></tr></table></figure>

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">bar</span><br><span class="hljs-keyword">bar</span><br><span class="hljs-keyword">bar</span><br><span class="hljs-keyword">foo</span><br><span class="hljs-keyword">foo</span><br><span class="hljs-keyword">foo</span><br><span class="hljs-keyword">fizz</span><br><span class="hljs-keyword">fizz</span><br><span class="hljs-keyword">fizz</span><br></code></pre></td></tr></table></figure>

<p>这对于管理异步任务组非常有用。</p>
<p>如上所述，Group 还提供了一个 API，用于将作业分派给分组的 greenlet 并以各种方式收集它们的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> getcurrent<br><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Group<br><br>group = Group()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello_from</span><span class="hljs-params">(n)</span>:</span><br>    print(<span class="hljs-string">'Size of group %s'</span> % len(group))<br>    print(<span class="hljs-string">'Hello from Greenlet %s'</span> % id(getcurrent()))<br><br>group.map(hello_from, range(<span class="hljs-number">3</span>))<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">intensive</span><span class="hljs-params">(n)</span>:</span><br>    gevent.sleep(<span class="hljs-number">3</span> - n)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">'task'</span>, n<br><br>print(<span class="hljs-string">'Ordered'</span>)<br><br>ogroup = Group()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ogroup.imap(intensive, range(<span class="hljs-number">3</span>)):<br>    print(i)<br><br>print(<span class="hljs-string">'Unordered'</span>)<br><br>igroup = Group()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> igroup.imap_unordered(intensive, range(<span class="hljs-number">3</span>)):<br>    print(i)<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Size of<span class="hljs-built_in"> group </span>3<br>Hello <span class="hljs-keyword">from</span> Greenlet 4340152592<br>Size of<span class="hljs-built_in"> group </span>3<br>Hello <span class="hljs-keyword">from</span> Greenlet 4340928912<br>Size of<span class="hljs-built_in"> group </span>3<br>Hello <span class="hljs-keyword">from</span> Greenlet 4340928592<br>Ordered<br>(<span class="hljs-string">'task'</span>, 0)<br>(<span class="hljs-string">'task'</span>, 1)<br>(<span class="hljs-string">'task'</span>, 2)<br>Unordered<br>(<span class="hljs-string">'task'</span>, 2)<br>(<span class="hljs-string">'task'</span>, 1)<br>(<span class="hljs-string">'task'</span>, 0)<br></code></pre></td></tr></table></figure>

<p>池是一种结构，用于处理需要限制并发的动态数量的greenlets。在需要并行执行许多网络或IO绑定任务的情况下，这通常是可取的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Pool<br><br>pool = Pool(<span class="hljs-number">2</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello_from</span><span class="hljs-params">(n)</span>:</span><br>    print(<span class="hljs-string">'Size of pool %s'</span> % len(pool))<br><br>pool.map(hello_from, range(<span class="hljs-number">3</span>))<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Size of<span class="hljs-built_in"> pool </span>2<br>Size of<span class="hljs-built_in"> pool </span>2<br>Size of<span class="hljs-built_in"> pool </span>1<br></code></pre></td></tr></table></figure>

<p>通常在构建 gevent 驱动的服务时，会将整个服务围绕一个池结构进行中心处理。一个例子可能是在各种套接字（socket）上轮询的类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Pool<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketPool</span><span class="hljs-params">(object)</span>:</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br>        self.pool = Pool(<span class="hljs-number">1000</span>)<br>        self.pool.start()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">listen</span><span class="hljs-params">(self, socket)</span>:</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            socket.recv()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_handler</span><span class="hljs-params">(self, socket)</span>:</span><br>        <span class="hljs-keyword">if</span> self.pool.full():<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"At maximum pool size"</span>)<br>        <span class="hljs-keyword">else</span>:<br>            self.pool.spawn(self.listen, socket)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shutdown</span><span class="hljs-params">(self)</span>:</span><br>        self.pool.kill()<br></code></pre></td></tr></table></figure>


<h3 id="locks-and-semaphores，锁和信号量"><a href="#locks-and-semaphores，锁和信号量" class="headerlink" title="locks and semaphores，锁和信号量"></a>locks and semaphores，锁和信号量</h3><p>信号量是一个允许 greenlet 相互合作，限制并发访问或运行的低层次的同步原语。 信号量有两个方法，acquire 和 release。在信号量是否已经被 acquire 或 release，和拥有资源的数量之间不同，被称为此信号量的范围 (the bound of the semaphore)。如果一个信号量的范围已经降低到0，它会 阻塞 acquire 操作直到另一个已经获得信号量的 greenlet 作出释放。</p>
<p>信号量是一种低级同步原语，它允许 greenlet 协调和限制并发访问或执行。信号量公开两种方法，获取和释放信号量被获取和释放的次数之差称为信号量的界限。如果信号量范围达到0，它就会阻塞，直到另一个  greenlet释放它的捕获。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">from</span> gevent.pool <span class="hljs-keyword">import</span> Pool<br><span class="hljs-keyword">from</span> gevent.coros <span class="hljs-keyword">import</span> BoundedSemaphore<br><br>sem = BoundedSemaphore(<span class="hljs-number">2</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker1</span><span class="hljs-params">(n)</span>:</span><br>    sem.acquire()<br>    print(<span class="hljs-string">'Worker %i acquired semaphore'</span> % n)<br>    sleep(<span class="hljs-number">0</span>)<br>    sem.release()<br>    print(<span class="hljs-string">'Worker %i released semaphore'</span> % n)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker2</span><span class="hljs-params">(n)</span>:</span><br>    <span class="hljs-keyword">with</span> sem:<br>        print(<span class="hljs-string">'Worker %i acquired semaphore'</span> % n)<br>        sleep(<span class="hljs-number">0</span>)<br>    print(<span class="hljs-string">'Worker %i released semaphore'</span> % n)<br><br>pool = Pool()<br>pool.map(worker1, range(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>))<br>pool.map(worker2, range(<span class="hljs-number">3</span>,<span class="hljs-number">6</span>))<br></code></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Worker <span class="hljs-number">0</span> acquired semaphore<br>Worker <span class="hljs-number">1</span> acquired semaphore<br>Worker <span class="hljs-number">0</span> released semaphore<br>Worker <span class="hljs-number">1</span> released semaphore<br>Worker <span class="hljs-number">3</span> acquired semaphore<br>Worker <span class="hljs-number">4</span> acquired semaphore<br>Worker <span class="hljs-number">3</span> released semaphore<br>Worker <span class="hljs-number">4</span> released semaphore<br>Worker <span class="hljs-number">5</span> acquired semaphore<br>Worker <span class="hljs-number">5</span> released semaphore<br></code></pre></td></tr></table></figure>

<p>界限为1的信号量称为锁。它提供对一个greenlet的独占执行。它们通常用于确保资源只在程序上下文中使用一次。</p>
<h3 id="Thread-Locals-线程局部变量"><a href="#Thread-Locals-线程局部变量" class="headerlink" title="Thread Locals 线程局部变量"></a>Thread Locals 线程局部变量</h3><p>Gevent 还允许您指定 greenlet 上下文的本地数据。在内部，这是作为全局查找实现的，它寻址一个由 greenlet <code>getcurrent()</code> 的值键控的私有命名空间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.local <span class="hljs-keyword">import</span> local<br> <br>stash = local()<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span>:</span><br>    stash.x = <span class="hljs-number">1</span><br>    print(stash.x)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span>:</span><br>    stash.y = <span class="hljs-number">2</span><br>    print(stash.y)<br> <br>    <span class="hljs-keyword">try</span>:<br>        stash.x<br>    <span class="hljs-keyword">except</span> AttributeError:<br>        print(<span class="hljs-string">"x is not local to f2"</span>)<br><br><br>g1 = gevent.spawn(f1)<br>g2 = gevent.spawn(f2)<br> <br>gevent.joinall([g1, g2])<br></code></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1</span><br><span class="hljs-number">2</span><br>x <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> local to f2<br></code></pre></td></tr></table></figure>

<p>许多使用 gevent 的 Web 框架将 HTTP 会话对象存储在 gevent 线程局部变量中。例如，使用 Werkzeug 实用程序库及其代理对象，我们可以创建 Flask 样式的请求对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gevent.local <span class="hljs-keyword">import</span> local<br><span class="hljs-keyword">from</span> werkzeug.local <span class="hljs-keyword">import</span> LocalProxy<br><span class="hljs-keyword">from</span> werkzeug.wrappers <span class="hljs-keyword">import</span> Request<br><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager<br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br> <br>_requests = local()<br>request = LocalProxy(<span class="hljs-keyword">lambda</span>: _requests.request)<br> <br> <br><span class="hljs-meta">@contextmanager</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sessionmanager</span><span class="hljs-params">(environ)</span>:</span><br>    _requests.request = Request(environ)<br>    <span class="hljs-keyword">yield</span><br>    _requests.request = <span class="hljs-literal">None</span><br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logic</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello <span class="hljs-subst">&#123;request.remote_addr&#125;</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>)<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">application_1</span><span class="hljs-params">(environ, start_response)</span>:</span><br>    status = <span class="hljs-string">'200 OK'</span><br>    headers = [(<span class="hljs-string">'Content-type'</span>, <span class="hljs-string">'text/plain'</span>)]<br>    start_response(status, headers)<br>    <span class="hljs-keyword">return</span> [<span class="hljs-string">b"Hello, World!"</span>]<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">application_2</span><span class="hljs-params">(environ, start_response)</span>:</span><br>    status = <span class="hljs-string">'200 OK'</span><br> <br>    <span class="hljs-keyword">with</span> sessionmanager(environ):<br>        body = logic()<br> <br>    headers = [<br>        (<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>)<br>    ]<br> <br>    start_response(status, headers)<br>    <span class="hljs-keyword">return</span> [body]<br> <br> <br><span class="hljs-comment"># http_server = WSGIServer(('0.0.0.0', 8000), application_1, log=None)</span><br>http_server = WSGIServer((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">8000</span>), application_2, log=<span class="hljs-literal">None</span>)<br>http_server.serve_forever()<br></code></pre></td></tr></table></figure>

<p>Flask 系统比这个例子复杂一点，然而使用线程局部变量作为局部的会话存储，这个思想是相同的。</p>
<h3 id="Subprocess-子进程"><a href="#Subprocess-子进程" class="headerlink" title="Subprocess 子进程"></a>Subprocess 子进程</h3><p>自 gevent 1.0 起，<code>gevent.subprocess</code> 添加了 Python <code>subprocess</code> 模块的修补版本。它支持对子进程进行协作等待。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.subprocess <span class="hljs-keyword">import</span> Popen, PIPE<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cron</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        print(<span class="hljs-string">"cron"</span>)<br>        gevent.sleep(<span class="hljs-number">0.2</span>)<br> <br> <br>g = gevent.spawn(cron)<br>sub = Popen([<span class="hljs-string">'sleep 1; uname'</span>], stdout=PIPE, shell=<span class="hljs-literal">True</span>)<br>out, err = sub.communicate()<br>g.kill()<br>print(out.rstrip())<br></code></pre></td></tr></table></figure>

<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">cron</span><br><span class="hljs-attribute">cron</span><br><span class="hljs-attribute">cron</span><br><span class="hljs-attribute">cron</span><br><span class="hljs-attribute">cron</span><br><span class="hljs-attribute">Linux</span><br></code></pre></td></tr></table></figure>

<p>很多人也想将 gevent 和 multiprocessing 一起使用。最明显的挑战之一就是 multiprocessing 提供的进程间通信默认不是协作式的。由于基于 multiprocessing.Connection 的对象(例如Pipe)暴露了它们下面的 文件描述符(file descriptor)，<code>gevent.socket.wait_read</code> 和 <code>wait_write</code> 可以用来在直接读写之前协作式的等待 ready-to-read&#x2F;ready-to-write 事件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Pipe<br><span class="hljs-keyword">from</span> gevent.socket <span class="hljs-keyword">import</span> wait_read, wait_write<br> <br><span class="hljs-comment"># To Process</span><br>a, b = Pipe()<br> <br><span class="hljs-comment"># From Process</span><br>c, d = Pipe()<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">relay</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>        msg = b.recv()<br>        c.send(msg + <span class="hljs-string">" in "</span> + str(i))<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_msg</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>        wait_write(a.fileno())<br>        a.send(<span class="hljs-string">'hi'</span>)<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_msg</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>        wait_read(d.fileno())<br>        print(d.recv())<br> <br> <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    proc = Process(target=relay)<br>    proc.start()<br> <br>    g1 = gevent.spawn(get_msg)<br>    g2 = gevent.spawn(put_msg)<br>    gevent.joinall([g1, g2], timeout=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>然而要注意，组合 <code>multiprocessing</code> 和 gevent 必定带来 依赖于操作系统(os-dependent)的缺陷，其中有：</p>
<ul>
<li><p>在兼容POSIX的系统<a href="http://linux.die.net/man/2/fork" target="_blank" rel="noopener" title="创建子进程(forking)">创建子进程(forking)</a>之后， 在子进程的gevent的状态是不适定的(ill-posed)。一个副作用就是， <code>multiprocessing.Process</code>创建之前的greenlet创建动作，会在父进程和子进程两 方都运行。</p>
</li>
<li><p>上例的<code>put_msg()</code>中的<code>a.send()</code>可能依然非协作式地阻塞调用的线程：一个 ready-to-write事件只保证写了一个byte。在尝试写完成之前底下的buffer可能是满的。</p>
</li>
<li><p>上面表示的基于<code>wait_write()</code>&#x2F;<code>wait_read()</code>的方法在Windows上不工作 (<code>IOError: 3 is not a socket (files are not supported)</code>)，因为Windows不能监视 pipe事件。</p>
</li>
</ul>
<p>Python包<a href="http://pypi.python.org/pypi/gipc" target="_blank" rel="noopener" title="gipc">gipc</a>以大体上透明的方式在 兼容POSIX系统和Windows上克服了这些挑战。它提供了gevent感知的基于<code>multiprocessing.Process</code>的子进程和gevent基于pipe的协作式进程间通信。</p>
<h3 id="Actors-并发模型"><a href="#Actors-并发模型" class="headerlink" title="Actors 并发模型"></a>Actors 并发模型</h3><p>actor 模型是一个由于 Erlang 变得普及的更高层的并发模型。简单的说它的主要思想就是许多个独立的 Actor，每个 Actor 有一个可以从 其它 Actor 接收消息的收件箱。Actor 内部的主循环遍历它收到的消息，并根据它期望的行为来采取行动。</p>
<p>Gevent 没有原生的 Actor 类型，但在一个子类化的 Greenlet 内使用队列， 我们可以定义一个非常简单的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.queue <span class="hljs-keyword">import</span> Queue<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Actor</span><span class="hljs-params">(gevent.Greenlet)</span>:</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br>        super(Actor, self).__init__()<br>        self.inbox = Queue()<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span><span class="hljs-params">(self, message)</span>:</span><br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        Define in your subclass.</span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>()<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run</span><span class="hljs-params">(self)</span>:</span><br>        self.running = <span class="hljs-literal">True</span><br> <br>        <span class="hljs-keyword">while</span> self.running:<br>            message = self.inbox.get()<br>            self.receive(message)<br></code></pre></td></tr></table></figure>

<p>下面是一个使用的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.queue <span class="hljs-keyword">import</span> Queue<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Actor</span><span class="hljs-params">(gevent.Greenlet)</span>:</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br>        super(Actor, self).__init__()<br>        self.inbox = Queue()<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span><span class="hljs-params">(self, message)</span>:</span><br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        Define in your subclass.</span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>()<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run</span><span class="hljs-params">(self)</span>:</span><br>        self.running = <span class="hljs-literal">True</span><br> <br>        <span class="hljs-keyword">while</span> self.running:<br>            message = self.inbox.get()<br>            self.receive(message)<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pinger</span><span class="hljs-params">(Actor)</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span><span class="hljs-params">(self, message)</span>:</span><br>        print(message)<br>        pong.inbox.put(<span class="hljs-string">'ping'</span>)<br>        gevent.sleep(<span class="hljs-number">0</span>)<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ponger</span><span class="hljs-params">(Actor)</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span><span class="hljs-params">(self, message)</span>:</span><br>        print(message)<br>        ping.inbox.put(<span class="hljs-string">'pong'</span>)<br>        gevent.sleep(<span class="hljs-number">0</span>)<br> <br> <br>ping = Pinger()<br>pong = Ponger()<br> <br>ping.start()<br>pong.start()<br> <br>ping.inbox.put(<span class="hljs-string">'start'</span>)<br>gevent.joinall([ping, pong])<br></code></pre></td></tr></table></figure>

<h2 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h2><h3 id="Gevent-ZeroMQ"><a href="#Gevent-ZeroMQ" class="headerlink" title="Gevent ZeroMQ"></a>Gevent ZeroMQ</h3><p><a href="http://www.zeromq.org/" target="_blank" rel="noopener" title="ZeroMQ">ZeroMQ</a> 被它的作者描述为 “一个表现得像一个并发框架的socket库”。它是一个非常强大的，为构建并发和分布式应用的消息传递层。ZeroMQ 提供了各种各样的 socket 原语。最简单的是请求-应答socket对 (Request-Response socket pair)。一个socket有两个方法<code>send</code>和<code>recv</code>， 两者一般都是阻塞操作。但是<a href="https://github.com/traviscline" target="_blank" rel="noopener" title="Travis Cline">Travis Cline</a> 的一个杰出的库弥补了这一点，这个库使用 <code>gevent.socket</code> 来以非阻塞的方式 轮询 ZereMQ socket。安装 gevent-zeremq 命令：<strong>pip install gevent-zeromq</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">import</span> zmq.green <span class="hljs-keyword">as</span> zmq<br> <br><span class="hljs-comment"># Global Context</span><br>context = zmq.Context()<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server</span><span class="hljs-params">()</span>:</span><br>    server_socket = context.socket(zmq.REQ)<br>    server_socket.bind(<span class="hljs-string">"tcp://127.0.0.1:5000"</span>)<br> <br>    <span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>):<br>        server_socket.send(<span class="hljs-string">"Hello"</span>)<br>        print(<span class="hljs-string">'Switched to Server for %s'</span> % request)<br>        <span class="hljs-comment"># Implicit context switch occurs here</span><br>        server_socket.recv()<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">client</span><span class="hljs-params">()</span>:</span><br>    client_socket = context.socket(zmq.REP)<br>    client_socket.connect(<span class="hljs-string">"tcp://127.0.0.1:5000"</span>)<br> <br>    <span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>):<br>        client_socket.recv()<br>        print(<span class="hljs-string">'Switched to Client for %s'</span> % request)<br>        <span class="hljs-comment"># Implicit context switch occurs here</span><br>        client_socket.send(<span class="hljs-string">"World"</span>)<br> <br> <br>publisher = gevent.spawn(server)<br>client = gevent.spawn(client)<br> <br>gevent.joinall([publisher, client])<br></code></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 1<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 1<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 2<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 2<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 3<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 3<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 4<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 4<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 5<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 5<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 6<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 6<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 7<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 7<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 8<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 8<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Server </span><span class="hljs-keyword">for</span> 9<br>Switched <span class="hljs-keyword">to</span><span class="hljs-built_in"> Client </span><span class="hljs-keyword">for</span> 9<br></code></pre></td></tr></table></figure>

<h3 id="简单-server"><a href="#简单-server" class="headerlink" title="简单 server"></a>简单 server</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># On Unix: Access with ``$ nc 127.0.0.1 5000``</span><br><span class="hljs-comment"># On Window: Access with ``$ telnet 127.0.0.1 5000``</span><br> <br><span class="hljs-keyword">from</span> gevent.server <span class="hljs-keyword">import</span> StreamServer<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle</span><span class="hljs-params">(socket, address)</span>:</span><br>    socket.send(<span class="hljs-string">"Hello from a telnet!\n"</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">5</span>):<br>        socket.send(str(i) + <span class="hljs-string">'\n'</span>)<br>    socket.close()<br> <br> <br>server = StreamServer((<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5000</span>), handle)<br>server.serve_forever()<br></code></pre></td></tr></table></figure>


<h3 id="WSGI-服务器-多进程"><a href="#WSGI-服务器-多进程" class="headerlink" title="WSGI 服务器 ( 多进程 )"></a>WSGI 服务器 ( 多进程 )</h3><p>Gevent 为 HTTP 内容服务提供了两种 WSGI server：</p>
<ul>
<li>gevent.pywsgi.WSGIServer</li>
</ul>
<p><strong>windows 运行报错，linux 可以正常运行</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> monkey<br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br> <br>monkey.patch_all()<br> <br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> cpu_count, Process<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify<br> <br>app = Flask(__name__)<br> <br> <br><span class="hljs-meta">@app.route("/cppla", methods=['GET'])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">function_benchmark</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">return</span> jsonify(<br>        &#123;<br>            <span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>,<br>            <span class="hljs-string">"time"</span>: datetime.datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M'</span>),<br>            <span class="hljs-string">"pid"</span>: os.getpid()<br>        &#125;<br>    ), <span class="hljs-number">200</span><br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(multi_process=None)</span>:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> multi_process:<br>        WSGIServer((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">8080</span>), app).serve_forever()<br>    <span class="hljs-keyword">else</span>:<br>        multi_server = WSGIServer((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">8080</span>), app)<br>        multi_server.start()<br> <br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server_forever</span><span class="hljs-params">()</span>:</span><br>            multi_server.start_accepting()<br>            multi_server._stop_event.wait()<br> <br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(cpu_count()):<br>            p = Process(target=server_forever)<br>            p.start()<br> <br> <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<br>    <span class="hljs-comment"># 单进程 + 协程</span><br>    run(<span class="hljs-literal">False</span>)<br>    <span class="hljs-comment"># 多进程 + 协程</span><br>    <span class="hljs-comment"># run(True)</span><br></code></pre></td></tr></table></figure>


<h3 id="Streaming-服务器"><a href="#Streaming-服务器" class="headerlink" title="Streaming 服务器"></a>Streaming 服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">application</span><span class="hljs-params">(environ, start_response)</span>:</span><br>    status = <span class="hljs-string">'200 OK'</span><br>    body = <span class="hljs-string">b'&lt;p&gt;Hello World&lt;/p&gt;'</span><br> <br>    headers = [<br>        (<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>)<br>    ]<br> <br>    start_response(status, headers)<br>    <span class="hljs-keyword">return</span> [body]<br> <br> <br>WSGIServer((<span class="hljs-string">''</span>, <span class="hljs-number">8000</span>), application).serve_forever()<br></code></pre></td></tr></table></figure>

<p>然而使用 pywsgi 我们可以将 handler 写成 generator，并以块的形式 yield 出结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">application</span><span class="hljs-params">(environ, start_response)</span>:</span><br>    status = <span class="hljs-string">'200 OK'</span><br> <br>    headers = [<br>        (<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>)<br>    ]<br> <br>    start_response(status, headers)<br>    <span class="hljs-keyword">yield</span> <span class="hljs-string">"&lt;p&gt;Hello"</span><br>    <span class="hljs-keyword">yield</span> <span class="hljs-string">"World&lt;/p&gt;"</span><br> <br>WSGIServer((<span class="hljs-string">''</span>, <span class="hljs-number">8000</span>), application).serve_forever()<br></code></pre></td></tr></table></figure>


<h3 id="Long-Polling-长轮询"><a href="#Long-Polling-长轮询" class="headerlink" title="Long Polling 长轮询"></a>Long Polling 长轮询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gevent<br><span class="hljs-keyword">from</span> gevent.queue <span class="hljs-keyword">import</span> Queue, Empty<br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br><span class="hljs-keyword">import</span> simplejson <span class="hljs-keyword">as</span> json<br> <br>data_source = Queue()<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">producer</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        data_source.put_nowait(<span class="hljs-string">'Hello World'</span>)<br>        gevent.sleep(<span class="hljs-number">1</span>)<br> <br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ajax_endpoint</span><span class="hljs-params">(environ, start_response)</span>:</span><br>    status = <span class="hljs-string">'200 OK'</span><br>    headers = [<br>        (<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>)<br>    ]<br> <br>    start_response(status, headers)<br> <br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            datum = data_source.get(timeout=<span class="hljs-number">5</span>)<br>            <span class="hljs-keyword">yield</span> json.dumps(datum) + <span class="hljs-string">'\n'</span><br>        <span class="hljs-keyword">except</span> Empty:<br>            <span class="hljs-keyword">pass</span><br> <br> <br>gevent.spawn(producer)<br>WSGIServer((<span class="hljs-string">''</span>, <span class="hljs-number">8000</span>), ajax_endpoint).serve_forever()<br></code></pre></td></tr></table></figure>


<h3 id="Websockets-网络套接字"><a href="#Websockets-网络套接字" class="headerlink" title="Websockets 网络套接字"></a>Websockets 网络套接字</h3><p>运行Websocket的例子需要<a href="https://bitbucket.org/Jeffrey/gevent-websocket/src" target="_blank" rel="noopener" title="gevent-websocket">gevent-websocket</a>包。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Simple gevent-websocket server</span><br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> random<br> <br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> pywsgi, sleep<br><span class="hljs-keyword">from</span> geventwebsocket.handler <span class="hljs-keyword">import</span> WebSocketHandler<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSocketApp</span><span class="hljs-params">(object)</span>:</span><br>    <span class="hljs-string">'''Send random data to the websocket'''</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, environ, start_response)</span>:</span><br>        ws = environ[<span class="hljs-string">'wsgi.websocket'</span>]<br>        x = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            data = json.dumps(&#123;<span class="hljs-string">'x'</span>: x, <span class="hljs-string">'y'</span>: random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)&#125;)<br>            ws.send(data)<br>            x += <span class="hljs-number">1</span><br>            sleep(<span class="hljs-number">0.5</span>)<br> <br> <br>server = pywsgi.WSGIServer(<br>    (<span class="hljs-string">""</span>, <span class="hljs-number">10000</span>), WebSocketApp(),<br>    handler_class=WebSocketHandler<br>)<br>server.serve_forever()<br></code></pre></td></tr></table></figure>

<p>HTML Page:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cobol">&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;Minimal websocket application&lt;&#x2F;title&gt;<br>        &lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;<br>        &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;<br>        $(function() &#123;<br>            &#x2F;&#x2F; Open up a connection to our server<br>            var ws &#x3D; new WebSocket(&quot;ws:&#x2F;&#x2F;localhost:10000&#x2F;&quot;);<br> <br>            &#x2F;&#x2F; What do we do when we get a message?<br>            ws.onmessage &#x3D; function(evt) &#123;<br>                $(&quot;#placeholder&quot;).append(&#39;&lt;p&gt;&#39; + evt.data + &#39;&lt;&#x2F;p&gt;&#39;)<br>            &#125;<br>            &#x2F;&#x2F; Just update our conn_status field with the connection status<br>            ws.onopen &#x3D; function(evt) &#123;<br>                $(&#39;#conn_status&#39;).html(&#39;&lt;b&gt;Connected&lt;&#x2F;b&gt;&#39;);<br>            &#125;<br>            ws.onerror &#x3D; function(evt) &#123;<br>                $(&#39;#conn_status&#39;).html(&#39;&lt;b&gt;Error&lt;&#x2F;b&gt;&#39;);<br>            &#125;<br>            ws.onclose &#x3D; function(evt) &#123;<br>                $(&#39;#conn_status&#39;).html(&#39;&lt;b&gt;Closed&lt;&#x2F;b&gt;&#39;);<br>            &#125;<br>        &#125;);<br>    &lt;&#x2F;script&gt;<br>    &lt;&#x2F;head&gt;<br>    &lt;body&gt;<br>        &lt;h1&gt;WebSocket Example&lt;&#x2F;h1&gt;<br>        &lt;div id&#x3D;&quot;conn_status&quot;&gt;Not Connected&lt;&#x2F;div&gt;<br>        &lt;div id&#x3D;&quot;placeholder&quot; style&#x3D;&quot;width:600px;height:300px;&quot;&gt;&lt;&#x2F;div&gt;<br>    &lt;&#x2F;body&gt;<br>&lt;&#x2F;html&gt;<br></code></pre></td></tr></table></figure>


<h3 id="Chat-Server-聊天服务器"><a href="#Chat-Server-聊天服务器" class="headerlink" title="Chat Server 聊天服务器"></a>Chat Server 聊天服务器</h3><p>实现一个实时聊天室， 运行这个例子需要 <a href="http://flask.pocoo.org/" target="_blank" rel="noopener" title="Flask">Flask</a> (你可以使用Django, Pyramid等，但不是必须的)。 对应的Javascript和HTML文件可以在 <a href="https://github.com/sdiehl/minichat" target="_blank" rel="noopener" title="这里">这里</a>找到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request<br><span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> queue<br><span class="hljs-keyword">from</span> gevent.pywsgi <span class="hljs-keyword">import</span> WSGIServer<br> <br><span class="hljs-keyword">import</span> simplejson <span class="hljs-keyword">as</span> json<br> <br>app = Flask(__name__)<br>app.debug = <span class="hljs-literal">True</span><br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span><span class="hljs-params">(object)</span>:</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br>        self.users = set()<br>        self.messages = []<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">backlog</span><span class="hljs-params">(self, size=<span class="hljs-number">25</span>)</span>:</span><br>        <span class="hljs-keyword">return</span> self.messages[-size:]<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe</span><span class="hljs-params">(self, user)</span>:</span><br>        self.users.add(user)<br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(self, message)</span>:</span><br>        <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> self.users:<br>            print(user)<br>            user.queue.put_nowait(message)<br>        self.messages.append(message)<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(object)</span>:</span><br> <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br>        self.queue = queue.Queue()<br> <br> <br>rooms = &#123;<br>    <span class="hljs-string">'topic1'</span>: Room(),<br>    <span class="hljs-string">'topic2'</span>: Room(),<br>&#125;<br>users = &#123;&#125;<br> <br> <br><span class="hljs-meta">@app.route('/')</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">choose_name</span><span class="hljs-params">()</span>:</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'choose.html'</span>)<br> <br> <br><span class="hljs-meta">@app.route('/&lt;uid&gt;')</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(uid)</span>:</span><br>    <span class="hljs-keyword">return</span> render_template(<br>        <span class="hljs-string">'main.html'</span>,<br>        uid=uid,<br>        rooms=rooms.keys()<br>    )<br> <br> <br><span class="hljs-meta">@app.route('/&lt;room&gt;/&lt;uid&gt;')</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">join</span><span class="hljs-params">(room, uid)</span>:</span><br>    user = users.get(uid, <span class="hljs-literal">None</span>)<br> <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:<br>        users[uid] = user = User()<br> <br>    active_room = rooms[room]<br>    active_room.subscribe(user)<br>    print(<span class="hljs-string">'subscribe %s %s'</span> % (active_room, user))<br> <br>    messages = active_room.backlog()<br> <br>    <span class="hljs-keyword">return</span> render_template(<br>        <span class="hljs-string">'room.html'</span>,<br>        room=room, uid=uid, messages=messages<br>    )<br> <br> <br><span class="hljs-meta">@app.route("/put/&lt;room&gt;/&lt;uid&gt;", methods=["POST"])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put</span><span class="hljs-params">(room, uid)</span>:</span><br>    user = users[uid]<br>    room = rooms[room]<br> <br>    message = request.form[<span class="hljs-string">'message'</span>]<br>    room.add(<span class="hljs-string">':'</span>.join([uid, message]))<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span><br> <br> <br><span class="hljs-meta">@app.route("/poll/&lt;uid&gt;", methods=["POST"])</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">poll</span><span class="hljs-params">(uid)</span>:</span><br>    <span class="hljs-keyword">try</span>:<br>        msg = users[uid].queue.get(timeout=<span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">except</span> queue.Empty:<br>        msg = []<br>    <span class="hljs-keyword">return</span> json.dumps(msg)<br> <br> <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<br>    http = WSGIServer((<span class="hljs-string">''</span>, <span class="hljs-number">5000</span>), app)<br>    http.serve_forever()<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Python/" class="category-chain-item">Python</a>
  
  
    <span>></span>
    
  <a href="/categories/Python/Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97/" class="category-chain-item">Python 第三方模块</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Python/" class="print-no-link">#Python</a>
      
        <a href="/tags/Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97/" class="print-no-link">#Python 第三方模块</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Python 第三方模块之 Gevent - 协程（官方）</div>
      <div>https://flepeng.github.io/021-Python-33-Python-第三方模块-01-进程、线程、协程-相关-Python-第三方模块之-Gevent-协程（官方）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lepeng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2016年8月3日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/021-Python-33-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97-01-windows-%E7%9B%B8%E5%85%B3-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E4%B9%8B-win32gui/" title="Python 第三方模块之 win32gui">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Python 第三方模块之 win32gui</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/021-Python-33-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97-01-%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B-%E7%9B%B8%E5%85%B3-Python-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E4%B9%8B-greenlet-%E5%8D%8F%E7%A8%8B/" title="Python 第三方模块之 greenlet - 协程">
                        <span class="hidden-mobile">Python 第三方模块之 greenlet - 协程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"flepeng/hexo-blog-comment","repo-id":"R_kgDOL0qaig","category":"Announcements","category-id":"DIC_kwDOL0qais4CfBIv","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
