

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2488174175014870" crossorigin="anonymous"></script><!-- google 广告 -->
  <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lepeng">
  <meta name="keywords" content="">
  
    <meta name="description" content="添加表记录普通字段1234567891011121314151617# 方式1publish_obj&#x3D;Publish(name&#x3D;&quot;人民出版社&quot;,city&#x3D;&quot;北京&quot;,email&#x3D;&quot;renMin@163.com&quot;)publish_obj.save() # 将数据保存到数据库# 方式2 # 返回值publish_obj是添加的记录对象publish_obj&#x3D;Publish.objects.create(">
<meta property="og:type" content="article">
<meta property="og:title" content="Django 入门之 ORM 增删改查，F Q 原生sql">
<meta property="og:url" content="https://flepeng.github.io/021-Python-34-%E6%A1%86%E6%9E%B6-Django-Django-%E5%85%A5%E9%97%A8%E4%B9%8B-ORM-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%EF%BC%8CF-Q-%E5%8E%9F%E7%94%9Fsql/index.html">
<meta property="og:site_name" content="Lepeng">
<meta property="og:description" content="添加表记录普通字段1234567891011121314151617# 方式1publish_obj&#x3D;Publish(name&#x3D;&quot;人民出版社&quot;,city&#x3D;&quot;北京&quot;,email&#x3D;&quot;renMin@163.com&quot;)publish_obj.save() # 将数据保存到数据库# 方式2 # 返回值publish_obj是添加的记录对象publish_obj&#x3D;Publish.objects.create(">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flepeng.github.io/picture/1629200162-c106f19cb59d6a9d084ec90831199160.png">
<meta property="og:image" content="https://flepeng.github.io/picture/1629200162-398a24c50b617a7111f59b600f2149cf.png">
<meta property="og:image" content="https://flepeng.github.io/picture/1629200162-5ea5d8f4de11648140c1748b1f295e36.png">
<meta property="article:published_time" content="2016-08-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-03T10:25:30.339Z">
<meta property="article:author" content="Feng Lepeng">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Django">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://flepeng.github.io/picture/1629200162-c106f19cb59d6a9d084ec90831199160.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Django 入门之 ORM 增删改查，F Q 原生sql - Lepeng</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"flepeng.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f3d259b9efd9ce8655c180fd01bf0045","google":{"measurement_id":"G-LFTE4C7W3W"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f3d259b9efd9ce8655c180fd01bf0045";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-LFTE4C7W3W", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-LFTE4C7W3W');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lepeng 的 blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Django 入门之 ORM 增删改查，F Q 原生sql"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2016-08-04 00:00" pubdate>
          2016年8月4日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          58 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Django 入门之 ORM 增删改查，F Q 原生sql</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="添加表记录"><a href="#添加表记录" class="headerlink" title="添加表记录"></a>添加表记录</h2><h3 id="普通字段"><a href="#普通字段" class="headerlink" title="普通字段"></a>普通字段</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"># 方式<span class="hljs-number">1</span><br>publish_obj=<span class="hljs-constructor">Publish(<span class="hljs-params">name</span>=<span class="hljs-string">"人民出版社"</span>,<span class="hljs-params">city</span>=<span class="hljs-string">"北京"</span>,<span class="hljs-params">email</span>=<span class="hljs-string">"renMin@163.com"</span>)</span><br>publish_obj.save<span class="hljs-literal">()</span> # 将数据保存到数据库<br><br># 方式<span class="hljs-number">2</span> <br># 返回值publish_obj是添加的记录对象<br>publish_obj=<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Publish</span>.</span></span>objects.create(name=<span class="hljs-string">"人民出版社"</span>,city=<span class="hljs-string">"北京"</span>,email=<span class="hljs-string">"renMin@163.com"</span>)<br><br># 方式<span class="hljs-number">3</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Publish</span>.</span></span>objects.create(**request.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">POST</span>.</span></span>dict<span class="hljs-literal">()</span>)<br><br># 批量插入<br>objs = <span class="hljs-literal">[</span><br><span class="hljs-literal">    <span class="hljs-identifier">models</span>.DDD(<span class="hljs-identifier">name</span>='<span class="hljs-identifier">r11</span>'),</span><br><span class="hljs-literal">    <span class="hljs-identifier">models</span>.DDD(<span class="hljs-identifier">name</span>='<span class="hljs-identifier">r22</span>')</span><br><span class="hljs-literal">]</span><br>models.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DDD</span>.</span></span>objects.bulk<span class="hljs-constructor">_create(<span class="hljs-params">objs</span>, 10)</span><br></code></pre></td></tr></table></figure>

<h3 id="外键字段"><a href="#外键字段" class="headerlink" title="外键字段"></a>外键字段</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 方式1:</span><br>publish_obj=Publish.objects.get<span class="hljs-params">(<span class="hljs-attr">nid</span>=1)</span><br>Book.objects.create<span class="hljs-params">(<span class="hljs-attr">title</span>="金瓶眉",<span class="hljs-attr">publishDate</span>="2012-12-12",<span class="hljs-attr">price</span>=665,<span class="hljs-attr">pageNum</span>=334,<span class="hljs-attr">publish</span>=publish_obj)</span><br><br><span class="hljs-comment"># 方式2:</span><br>Book.objects.create<span class="hljs-params">(<span class="hljs-attr">title</span>="金瓶眉",<span class="hljs-attr">publishDate</span>="2012-12-12",<span class="hljs-attr">price</span>=665,<span class="hljs-attr">pageNum</span>=334,<span class="hljs-attr">publish_id</span>=1)</span><br></code></pre></td></tr></table></figure>

<h3 id="多对多字段"><a href="#多对多字段" class="headerlink" title="多对多字段"></a>多对多字段</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">book_obj=Book.objects.create<span class="hljs-params">(<span class="hljs-attr">title</span>="追风筝的人",<span class="hljs-attr">publishDate</span>="2012-11-12",<span class="hljs-attr">price</span>=69,<span class="hljs-attr">pageNum</span>=314,<span class="hljs-attr">publish_id</span>=1)</span><br><br>author_yuan=Author.objects.create<span class="hljs-params">(<span class="hljs-attr">name</span>="yuan",<span class="hljs-attr">age</span>=23,<span class="hljs-attr">authorDetail_id</span>=1)</span><br>author_egon=Author.objects.create<span class="hljs-params">(<span class="hljs-attr">name</span>="egon",<span class="hljs-attr">age</span>=32,<span class="hljs-attr">authorDetail_id</span>=2)</span><br><br><span class="hljs-comment"># 方式1 add多个obj对象</span><br><span class="hljs-comment"># 将某个特定的 model对象添加到被关联对象集合中。 =======  book_obj.authors.add(*[])</span><br>book_obj.authors.add<span class="hljs-params">(author_egon,author_yuan)</span><br><br><span class="hljs-comment"># 方式2 直接create关联对象</span><br><span class="hljs-comment"># 创建并保存一个新对象，然后将这个对象加被关联对象的集合中，然后返回这个新对象。</span><br>book_obj.authors.create<span class="hljs-params">()</span><br></code></pre></td></tr></table></figure>

<p>解除关系：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 将某个特定的对象从被关联对象集合中去除。 ====== book_obj.authors.remove(*[])</span><br>book_obj.authors.<span class="hljs-built_in">remove</span>()<br><br><span class="hljs-meta"># 清空被关联对象集合。  </span><br>book_obj.authors.<span class="hljs-keyword">clear</span>()<br></code></pre></td></tr></table></figure>

<h2 id="class-RelatedManager"><a href="#class-RelatedManager" class="headerlink" title="class RelatedManager"></a>class RelatedManager</h2><p>“关联管理器”是在一对多或者多对多的关联上下文中使用的管理器。</p>
<p>它存在于下面两种情况：</p>
<ol>
<li>外键关系的反向查询，例如publish_obj.book_set</li>
<li>多对多关联关系，例如book_obj.authors和author_obj.book_set</li>
</ol>
<p>简单来说就是当 <strong>点后面的对象 可能存在多个的时候就可以使用以下的方法</strong>。</p>
<p><strong>create()</strong> 创建一个新的对象，保存对象，并将它添加到关联对象集之中，返回新创建的对象。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import datetime<br>models.Author.objects.first().book_set.create(<span class="hljs-attribute">title</span>=<span class="hljs-string">"番茄物语"</span>, <span class="hljs-attribute">publish_date</span>=datetime.date.today())<br></code></pre></td></tr></table></figure>

<p><strong>add()</strong> 把指定的model对象添加到关联对象集中。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 添加对象</span><br>author_objs = models.Author.objects.filter(<span class="hljs-attribute">id__lt</span>=3)<br>models.Book.objects.first().authors.<span class="hljs-builtin-name">add</span>(<span class="hljs-number">*a</span>uthor_objs)<br><br><span class="hljs-comment"># 添加id</span><br>models.Book.objects.first().authors.<span class="hljs-builtin-name">add</span>(*[1, 2])<br><br>注：在上面的例子中，对于ForeignKey关系，e.save()由关联管理器调用，执行更新操作。<br>然而，在多对多关系中使用<span class="hljs-builtin-name">add</span>()并不会调用任何 save()方法，而是由QuerySet.bulk_create()创建关系。<br></code></pre></td></tr></table></figure>

<p><strong>set()</strong> 更新model对象的关联对象。先清空再添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">book_obj &#x3D; models.Book.objects.first()<br>book_obj.authors.set([2, 3])<br></code></pre></td></tr></table></figure>

<p><strong>remove()</strong> 从关联对象集中移除执行的model对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">book_obj &#x3D; models.Book.objects.first()<br>book_obj.authors.remove(3) # 可以是主键值也可以是具体对象<br></code></pre></td></tr></table></figure>

<p><strong>clear()</strong> 从关联对象集中移除一切对象。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">book_obj = models<span class="hljs-selector-class">.Book</span><span class="hljs-selector-class">.objects</span>.first()<br>book_obj<span class="hljs-selector-class">.authors</span>.<span class="hljs-attribute">clear</span>()<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：对于ForeignKey对象，clear()和remove()方法仅在null&#x3D;True时存在。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-meta"># ForeignKey字段 没 设置null=True时，没有clear()和remove()方法，运行会报错：</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Book</span>(<span class="hljs-title">models</span>.<span class="hljs-type">Model</span>):</span><br><span class="hljs-class">    title = models.<span class="hljs-type">CharField</span>(<span class="hljs-title">max_length</span>=32)</span><br><span class="hljs-class">    publisher = models.<span class="hljs-type">ForeignKey</span>(<span class="hljs-title">to</span>=<span class="hljs-type">Publisher</span>)</span><br><span class="hljs-class"></span><br><span class="hljs-class">models.<span class="hljs-type">Publisher</span>.objects.first().book_set.clear()</span><br><span class="hljs-class"><span class="hljs-type">Traceback</span> (<span class="hljs-title">most</span> <span class="hljs-title">recent</span> <span class="hljs-title">call</span> <span class="hljs-title">last</span>):</span><br><span class="hljs-class">  <span class="hljs-type">File</span> "&lt;input&gt;", line 1, in &lt;module&gt;</span><br><span class="hljs-class"><span class="hljs-type">AttributeError</span>: '<span class="hljs-type">RelatedManager'</span> object has no attribute 'clear'</span><br><span class="hljs-class"></span><br><span class="hljs-class"># 当<span class="hljs-type">ForeignKey</span>字段设置null=<span class="hljs-type">True</span>时，此时就有clear()和remove()方法：</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Book</span>(<span class="hljs-title">models</span>.<span class="hljs-type">Model</span>): </span><br><span class="hljs-class">    name = models.<span class="hljs-type">CharField</span>(<span class="hljs-title">max_length</span>=32) </span><br><span class="hljs-class">    publisher = models.<span class="hljs-type">ForeignKey</span>(<span class="hljs-title">to</span>=<span class="hljs-type">Class</span>, <span class="hljs-title">null</span>=<span class="hljs-type">True</span>)</span><br><span class="hljs-class"></span><br><span class="hljs-class">models.<span class="hljs-type">Publisher</span>.objects.first().book_set.clear()</span><br></code></pre></td></tr></table></figure>

<p>注意：对于所有类型的关联字段，add()、create()、remove()和clear(),set()都会马上更新数据库。换句话说，在关联的任何一端，都不需要再调用save()方法。</p>
<h2 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a><strong>查询操作</strong></h2><p><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/" target="_blank" rel="noopener">看专业的官网文档，做专业的程序员！</a></p>
<h3 id="必知必会13条"><a href="#必知必会13条" class="headerlink" title="必知必会13条"></a>必知必会13条</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-symbol">&lt;1&gt;</span> <span class="hljs-keyword">all</span>():                 查询所有结果<br><span class="hljs-symbol">&lt;2&gt;</span> <span class="hljs-built_in">filter</span>(**kwargs):      它包含了与所给筛选条件相匹配的对象<br><span class="hljs-symbol">&lt;3&gt;</span> <span class="hljs-built_in">get</span>(**kwargs):         返回与所给筛选条件相匹配的对象，返回结果有且只有一个，如果符合筛选条件的对象超过一个或者没有都会抛出错误。<br><span class="hljs-symbol">&lt;4&gt;</span> exclude(**kwargs):     它包含了与所给筛选条件不匹配的对象<br><span class="hljs-symbol">&lt;5&gt;</span> <span class="hljs-built_in">values</span>(*field):        返回一个ValueQuerySet——一个特殊的QuerySet，运行后得到的并不是一系列model的实例化对象，而是一个可迭代的字典序列<br><span class="hljs-symbol">&lt;6&gt;</span> values_list(*field):   它与<span class="hljs-built_in">values</span>()非常相似，它返回的是一个元组序列，<span class="hljs-built_in">values</span>返回的是一个字典序列<br><span class="hljs-symbol">&lt;7&gt;</span> order_by(*field):      对查询结果排序<br><span class="hljs-symbol">&lt;8&gt;</span> <span class="hljs-built_in">reverse</span>():             对查询结果反向排序，请注意<span class="hljs-built_in">reverse</span>()通常只能在具有已定义顺序的QuerySet上调用(在model类的Meta中指定ordering或调用order_by()方法)。<br><span class="hljs-symbol">&lt;9&gt;</span> distinct():            从返回结果中剔除重复纪录(如果你查询跨越多个表，可能在计算QuerySet时得到重复的结果。此时可以使用distinct()，注意只有在PostgreSQL中支持按字段去重。)<br><span class="hljs-symbol">&lt;10&gt;</span> <span class="hljs-built_in">count</span>():              返回数据库中匹配查询(QuerySet)的对象数量。<br><span class="hljs-symbol">&lt;11&gt;</span> <span class="hljs-keyword">first</span>():              返回第一条记录<br><span class="hljs-symbol">&lt;12&gt;</span> <span class="hljs-keyword">last</span>():               返回最后一条记录<br><span class="hljs-symbol">&lt;13&gt;</span> <span class="hljs-built_in">exists</span>():             如果QuerySet包含数据，就返回True，否则返回False<br></code></pre></td></tr></table></figure>

<p><strong>返回QuerySet对象的方法有</strong></p>
<ul>
<li>all()</li>
<li>filter()</li>
<li>exclude()</li>
<li>order_by()</li>
<li>reverse()</li>
<li>distinct()</li>
</ul>
<p>特殊的QuerySet</p>
<ul>
<li>values()            返回一个可迭代的字典序列</li>
<li>values_list()       返回一个可迭代的元祖序列</li>
</ul>
<p><strong>返回具体对象的</strong></p>
<ul>
<li>get()</li>
<li>first()</li>
<li>last()</li>
</ul>
<p><strong>返回布尔值的方法有：</strong></p>
<ul>
<li>exists()</li>
</ul>
<p><strong>返回数字的方法有</strong></p>
<ul>
<li>count()</li>
</ul>
<h3 id="单表查询之神奇的双下划线"><a href="#单表查询之神奇的双下划线" class="headerlink" title="单表查询之神奇的双下划线"></a>单表查询之神奇的双下划线</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">models.Tb1.objects.<span class="hljs-keyword">filter</span>(id__lt=<span class="hljs-number">10</span>, id__gt=<span class="hljs-number">1</span>)   # 获取id大于<span class="hljs-number">1</span>且小于<span class="hljs-number">10</span>的值（gt大于，gte大于等于，lt小于，lte小于等于）<br> <br>models.Tb1.objects.<span class="hljs-keyword">filter</span>(id__in=[<span class="hljs-number">11</span>, <span class="hljs-number">22</span>, <span class="hljs-number">33</span>])   # 获取id等于<span class="hljs-number">11</span>、<span class="hljs-number">22</span>、<span class="hljs-number">33</span>的数据<br>models.Tb1.objects.<span class="hljs-keyword">exclude</span>(id__in=[<span class="hljs-number">11</span>, <span class="hljs-number">22</span>, <span class="hljs-number">33</span>])  # <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span><br> <br>models.Tb1.objects.<span class="hljs-keyword">filter</span>(name__contains="ven")  # 获取<span class="hljs-type">name</span>字段包含"ven"的<br>models.Tb1.objects.<span class="hljs-keyword">filter</span>(name__icontains="ven") # icontains大小写不敏感<br> <br>models.Tb1.objects.<span class="hljs-keyword">filter</span>(id__range=[<span class="hljs-number">1</span>, <span class="hljs-number">3</span>])      # range范围，等价于<span class="hljs-keyword">SQL</span>的bettwen <span class="hljs-keyword">and</span><br> <br># 类似的还有：startswith，istartswith, endswith, iendswith<br><br>Entry.objects.<span class="hljs-keyword">get</span>(title__regex=r<span class="hljs-string">'^(An?|The) +'</span>)  # regex正则匹配<br>Entry.objects.<span class="hljs-keyword">get</span>(title__iregex=r<span class="hljs-string">'^(an?|the) +'</span>) # iregex正则匹配，不区分大小写<br><br># <span class="hljs-type">date</span>字段还可以：<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__date=datetime.date(<span class="hljs-number">2005</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__year=<span class="hljs-number">2017</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__mouse=<span class="hljs-number">2</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__week=<span class="hljs-number">2</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__date=<span class="hljs-number">2</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__hour=<span class="hljs-number">2</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__minute_gte=<span class="hljs-number">2</span>)<br>models.<span class="hljs-keyword">Class</span>.objects.<span class="hljs-keyword">filter</span>(first_day__second_gte=<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<h3 id="基于对象的跨表查询"><a href="#基于对象的跨表查询" class="headerlink" title="基于对象的跨表查询"></a><strong>基于对象的跨表查询</strong></h3><h4 id="一对多查询（Publish-与-Book），同多对多查询"><a href="#一对多查询（Publish-与-Book），同多对多查询" class="headerlink" title="一对多查询（Publish 与 Book），同多对多查询"></a>一对多查询（Publish 与 Book），同多对多查询</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 正向查询(按字段,如：publish)：</span><br><span class="hljs-comment"># 查询nid=1的书籍的出版社所在的城市</span><br><span class="hljs-attribute">book_obj</span>=Book.objects.get(nid=1)<br><span class="hljs-builtin-name">print</span>(book_obj.publish.city) # book_obj.publish 是<span class="hljs-attribute">nid</span>=1的书籍对象关联的出版社对象<br><br><span class="hljs-comment"># 反向查询(按表名_set,如：book_set)：</span><br><span class="hljs-comment"># 查询 人民出版社出版过的所有书籍</span><br><span class="hljs-attribute">publish</span>=Publish.objects.get(name="人民出版社")<br><span class="hljs-attribute">book_list</span>=publish.book_set.all()  # 与人民出版社关联的所有书籍对象集合<br><span class="hljs-keyword">for</span> book_obj <span class="hljs-keyword">in</span> book_list:<br>    <span class="hljs-builtin-name">print</span>(book_obj.title)<br></code></pre></td></tr></table></figure>

<h4 id="一对一查询-Author-与-AuthorDetail"><a href="#一对一查询-Author-与-AuthorDetail" class="headerlink" title="一对一查询(Author 与 AuthorDetail)"></a>一对一查询(Author 与 AuthorDetail)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 正向查询(按字段,如：authorDetail)：<br># 查询egon作者的手机号<br>author_egon&#x3D;Author.objects.get(name&#x3D;&quot;egon&quot;)<br>print(author_egon.authorDetail.telephone)<br><br># 反向查询(按表名,如：author)：<br># 查询所有住址在北京的作者的姓名<br>authorDetail_list&#x3D;AuthorDetail.objects.filter(addr&#x3D;&quot;beijing&quot;)<br>for obj in authorDetail_list:<br>   print(obj.author.name)<br></code></pre></td></tr></table></figure>

<h4 id="多对多查询-Author-与-Book-，同一对多查询"><a href="#多对多查询-Author-与-Book-，同一对多查询" class="headerlink" title="多对多查询 (Author 与 Book)，同一对多查询"></a>多对多查询 (Author 与 Book)，同一对多查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 正向查询(按字段,如：authors)：<br># 金瓶眉所有作者的名字以及手机号<br>book_obj&#x3D;Book.objects.filter(title&#x3D;&quot;金瓶眉&quot;).first()<br>authors&#x3D;book_obj.authors.all()<br>for author_obj in authors:<br>    print(author_obj.name,author_obj.authorDetail.telephone)<br><br># 反向查询(按表名_set,如：book_set)：<br># 查询egon出过的所有书籍的名字<br>author_obj&#x3D;Author.objects.get(name&#x3D;&quot;egon&quot;)<br>book_list&#x3D;author_obj.book_set.all() #与egon作者相关的所有书籍<br>for book_obj in book_list:<br>    print(book_obj.title)<br></code></pre></td></tr></table></figure>

<p><strong>注意：</strong>你可以通过在 ForeignKey() 和ManyToManyField的定义中设置 related_name 的值来覆写 FOO_set 的名称。例如，如果 Article model 中做一下更改： publish &#x3D; ForeignKey(Blog, related_name&#x3D;’bookList’)，那么接下来就会如我们看到这般：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 查询 人民出版社出版过的所有书籍<br>publish&#x3D;Publish.objects.get(name&#x3D;&quot;人民出版社&quot;)<br>book_list&#x3D;publish.bookList.all()  # 与人民出版社关联的所有书籍对象集合<br></code></pre></td></tr></table></figure>

<h3 id="基于双下划线的跨表查询"><a href="#基于双下划线的跨表查询" class="headerlink" title="基于双下划线的跨表查询"></a><strong>基于双下划线的跨表查询</strong></h3><p>Django 还提供了一种直观而高效的方式在查询(lookups)中表示关联关系，它能自动确认 SQL JOIN 联系。要做跨关系查询，就使用两个下划线来链接模型(model)间关联字段的名称，直到最终链接到你想要的 model 为止。</p>
<p>关键点：正向查询按字段，反向查询按表名小写。通常用在 <strong>filter 和 value</strong> 中</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 练习1:  查询人民出版社出版过的所有书籍的名字与价格(一对多)</span><br><span class="hljs-comment"># 正向查询 按字段:publish</span><br><span class="hljs-attribute">queryResult</span>=Book.objects<br>    .filter(<span class="hljs-attribute">publish__name</span>=<span class="hljs-string">"人民出版社"</span>)<br>    .values_list(<span class="hljs-string">"title"</span>,<span class="hljs-string">"price"</span>)<br><span class="hljs-comment"># 反向查询 按表名小写:book</span><br><span class="hljs-attribute">queryResult</span>=Publish.objects<br>    .filter(<span class="hljs-attribute">name</span>=<span class="hljs-string">"人民出版社"</span>)<br>    .values_list(<span class="hljs-string">"book__title"</span>,<span class="hljs-string">"book__price"</span>)<br><br><br><span class="hljs-comment"># 练习2: 查询egon出过的所有书籍的名字(多对多)</span><br><span class="hljs-comment"># 正向查询 按字段:authors:</span><br><span class="hljs-attribute">queryResult</span>=Book.objects<br>    .filter(<span class="hljs-attribute">authors__name</span>=<span class="hljs-string">"yuan"</span>)<br>    .values_list(<span class="hljs-string">"title"</span>)<br><span class="hljs-comment"># 反向查询 按表名小写:book</span><br><span class="hljs-attribute">queryResult</span>=Author.objects<br>    .filter(<span class="hljs-attribute">name</span>=<span class="hljs-string">"yuan"</span>)<br>    .values_list(<span class="hljs-string">"book__title"</span>,<span class="hljs-string">"book__price"</span>)<br><br><br><span class="hljs-comment"># 练习3: 查询人民出版社出版过的所有书籍的名字以及作者的姓名</span><br><span class="hljs-comment"># 正向查询 按字段</span><br><span class="hljs-attribute">queryResult</span>=Book.objects<br>    .filter(<span class="hljs-attribute">publish__name</span>=<span class="hljs-string">"人民出版社"</span>)<br>    .values_list(<span class="hljs-string">"title"</span>,<span class="hljs-string">"authors__name"</span>)<br><span class="hljs-comment"># 反向查询 按表名小写</span><br><span class="hljs-attribute">queryResult</span>=Publish.objects<br>    .filter(<span class="hljs-attribute">name</span>=<span class="hljs-string">"人民出版社"</span>)<br>    .values_list(<span class="hljs-string">"book__title"</span>,<span class="hljs-string">"book__authors__age"</span>,<span class="hljs-string">"book__authors__name"</span>)<br><br><br><span class="hljs-comment"># 练习4: 手机号以151开头的作者出版过的所有书籍名称以及出版社名称</span><br><span class="hljs-attribute">queryResult</span>=Book.objects<br>    .filter(<span class="hljs-attribute">authors__authorDetail__telephone__regex</span>=<span class="hljs-string">"151"</span>)<br>    .values_list(<span class="hljs-string">"title"</span>,<span class="hljs-string">"publish__name"</span>)<br></code></pre></td></tr></table></figure>

<p>注意：反向查询时，如果定义了related_name ，则用related_name替换表名，例如： publish &#x3D; ForeignKey(Blog, related_name&#x3D;’bookList’)：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 练习1: 查询人民出版社出版过的所有书籍的名字与价格(一对多)</span><br><span class="hljs-comment"># 反向查询 不再按表名:book,而是related_name:bookList</span><br><span class="hljs-attribute">queryResult</span>=Publish.objects<br>    .filter(<span class="hljs-attribute">name</span>=<span class="hljs-string">"人民出版社"</span>)<br>    .values_list(<span class="hljs-string">"bookList__title"</span>,<span class="hljs-string">"bookList__price"</span>)<br></code></pre></td></tr></table></figure>

<h3 id="聚合查询和分组查询"><a href="#聚合查询和分组查询" class="headerlink" title="聚合查询和分组查询"></a>聚合查询和分组查询</h3><h4 id="聚合-aggregate-args-kwargs"><a href="#聚合-aggregate-args-kwargs" class="headerlink" title="聚合 aggregate(*args, **kwargs)"></a>聚合 aggregate(*args, **kwargs)</h4><p>aggregate() 是 QuerySet 的一个终止子句，意思是说，它返回一个包含一些键值对的字典。</p>
<p>键的名称是聚合值的标识符，值是计算出来的聚合值。键的名称是按照字段和聚合函数的名称自动生成出来的。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 用到的内置函数<br><span class="hljs-keyword">from</span> django.db.models <span class="hljs-keyword">import</span> Avg, Sum, Max, Min, Count<br>models.Book.objects.<span class="hljs-keyword">all</span>().<span class="hljs-keyword">aggregate</span>(Avg("price"))  # &#123;<span class="hljs-string">'price__avg'</span>: <span class="hljs-number">13.233333</span>&#125;<br><br># 如果你想要为聚合值指定一个名称，可以向聚合子句提供它。<br>models.Book.objects.<span class="hljs-keyword">aggregate</span>(average_price=Avg(<span class="hljs-string">'price'</span>))  # &#123;<span class="hljs-string">'average_price'</span>: <span class="hljs-number">13.233333</span>&#125;<br><br># 如果你希望生成多个聚合，可以向<span class="hljs-keyword">aggregate</span>()子句中添加另一个参数。所以，如果你也想知道所有图书价格的最大值和最小值，可以：<br>models.Book.objects.<span class="hljs-keyword">all</span>().<span class="hljs-keyword">aggregate</span>(Avg("price"), Max("price"), Min("price"))<br># &#123;<span class="hljs-string">'price__avg'</span>: <span class="hljs-number">13.233333</span>, <span class="hljs-string">'price__max'</span>: <span class="hljs-type">Decimal</span>(<span class="hljs-string">'19.90'</span>), <span class="hljs-string">'price__min'</span>: <span class="hljs-type">Decimal</span>(<span class="hljs-string">'9.90'</span>)&#125;<br></code></pre></td></tr></table></figure>

<h3 id="分组-annotate"><a href="#分组-annotate" class="headerlink" title="分组 annotate"></a>分组 annotate</h3><p>我们在这里先复习一下SQL语句的分组。假设现在有一张公司职员表：</p>
<p><img src="/picture/1629200162-c106f19cb59d6a9d084ec90831199160.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 我们使用原生SQL语句，按照部分分组求平均工资：</span><br>select dept,AVG(salary) <span class="hljs-keyword">from</span> employee<span class="hljs-built_in"> group </span>by dept;<br><br><span class="hljs-comment"># ORM查询:</span><br><span class="hljs-keyword">from</span> django.db.models import Avg <br>models.Employee.objects.values(<span class="hljs-string">"dept"</span>).annotate(<span class="hljs-attribute">avg</span>=Avg("salary")).values(dept, <span class="hljs-string">"avg"</span>)<br></code></pre></td></tr></table></figure>

<p>连表查询的分组：</p>
<p><img src="/picture/1629200162-398a24c50b617a7111f59b600f2149cf.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># SQL查询：</span><br>select dept.name,AVG(salary) <span class="hljs-keyword">from</span> employee inner join dept on (employee.<span class="hljs-attribute">dept_id</span>=dept.id)<span class="hljs-built_in"> group </span>by dept.id;<br><br><span class="hljs-comment"># ORM查询：</span><br><span class="hljs-keyword">from</span> django.db.models import Avg <br>models.Dept.objects.annotate(<span class="hljs-attribute">avg</span>=Avg("employee__salary")).values("name", <span class="hljs-string">"avg"</span>)<br></code></pre></td></tr></table></figure>

<h3 id="更多示例："><a href="#更多示例：" class="headerlink" title="更多示例："></a>更多示例：</h3><p>只要记住，前面的value的字段，就是要分组的字段，默认是id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 示例1：统计每一本书的作者个数<br>book_list &#x3D; models.Book.objects.all().annotate(author_num&#x3D;Count(&quot;author&quot;))<br>for obj in book_list:<br>     print(obj.author_num)<br>2<br>1<br>1<br><br># 示例2：统计出每个出版社买的最便宜的书的价格<br>publisher_list &#x3D; models.Publisher.objects.annotate(min_price&#x3D;Min(&quot;book__price&quot;))<br>for obj in publisher_list:<br>    print(obj.min_price)     <br>9.90<br>19.90<br><br># 方法二：<br>models.Book.objects.values(&quot;publisher__name&quot;).annotate(min_price&#x3D;Min(&quot;price&quot;))<br># &lt;QuerySet [&#123;&#39;publisher__name&#39;: &#39;沙河出版社&#39;, &#39;min_price&#39;: Decimal(&#39;9.90&#39;)&#125;,<br>             &#123;&#39;publisher__name&#39;: &#39;人民出版社&#39;, &#39;min_price&#39;: Decimal(&#39;19.90&#39;)&#125;]&gt;<br><br><br># 示例3：统计不止一个作者的图书<br>models.Book.objects.annotate(author_num&#x3D;Count(&quot;author&quot;)).filter(author_num__gt&#x3D;1)<br># &lt;QuerySet [&lt;Book: 番茄物语&gt;]&gt;<br><br># 示例4：根据一本图书作者数量的多少对查询集 QuerySet进行排序<br>models.Book.objects.annotate(author_num&#x3D;Count(&quot;author&quot;)).order_by(&quot;author_num&quot;)<br># &lt;QuerySet [&lt;Book: 香蕉物语&gt;, &lt;Book: 橘子物语&gt;, &lt;Book: 番茄物语&gt;]&gt;<br><br># 示例5：查询各个作者出的书的总价格<br>models.Author.objects.annotate(sum_price&#x3D;Sum(&quot;book__price&quot;)).values(&quot;name&quot;, &quot;sum_price&quot;)<br># &lt;QuerySet [&#123;&#39;name&#39;: &#39;小精灵&#39;, &#39;sum_price&#39;: Decimal(&#39;9.90&#39;)&#125;,<br>             &#123;&#39;name&#39;: &#39;小仙女&#39;, &#39;sum_price&#39;: Decimal(&#39;29.80&#39;)&#125;, <br>             &#123;&#39;name&#39;: &#39;小魔女&#39;, &#39;sum_price&#39;: Decimal(&#39;9.90&#39;)&#125;]&gt;<br></code></pre></td></tr></table></figure>

<h3 id="F查询和Q查询"><a href="#F查询和Q查询" class="headerlink" title="F查询和Q查询"></a>F查询和Q查询</h3><h4 id="F查询"><a href="#F查询" class="headerlink" title="F查询"></a>F查询</h4><p>在上面所有的例子中，我们构造的过滤器都只是将字段值与某个常量做比较。如果我们要对两个字段的值做比较，那该怎么做呢？</p>
<p>F() 的实例可以在查询中引用字段，来比较同一个 model 实例中两个不同字段的值。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"># 示例<span class="hljs-number">1</span>：查询评论数大于收藏数的书籍<br>from django.db.models import F<br>models.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Book</span>.</span></span>objects.filter(commnet_num__gt=<span class="hljs-constructor">F('<span class="hljs-params">keep_num</span>')</span>)  # keep_num是book的字段<br><br>Django 支持 <span class="hljs-constructor">F()</span> 对象之间 以及 <span class="hljs-constructor">F()</span> 对象和常数之间的加减乘除和取模的操作。<br>models.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Book</span>.</span></span>objects.filter(commnet_num__lt=<span class="hljs-constructor">F('<span class="hljs-params">keep_num</span>')</span>*<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p><strong>修改操作</strong>也可以使用F函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 比如将每一本书的价格提高30元<br>models.Book.objects.all().update(price&#x3D;F(&quot;price&quot;)+30)<br></code></pre></td></tr></table></figure>

<p><strong>引申：</strong>如果要修改char字段咋办？如：把所有书名后面加上(第一版)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">from django.db.models.functions import Concat<br>from django.db.models import Value<br>models.Book.objects.all().update(title&#x3D;Concat(F(&quot;title&quot;), Value(&quot;(&quot;), Value(&quot;第一版&quot;), Value(&quot;)&quot;)))<br></code></pre></td></tr></table></figure>

<h4 id="Q查询"><a href="#Q查询" class="headerlink" title="Q查询"></a>Q查询</h4><p><strong>filter() 等方法中的关键字参数查询都是一起进行“AND” 的</strong>。 如果你需要执行更复杂的查询（例如OR语句），你可以使用Q对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 示例1：查询作者名是小仙女或小魔女的<br>from django.db.models import Q<br>models.Book.objects.filter(Q(authors__name&#x3D;&quot;小仙女&quot;)|Q(authors__name&#x3D;&quot;小魔女&quot;))<br></code></pre></td></tr></table></figure>

<p>你可以组合&amp; 和|  操作符以及使用括号进行分组来编写任意复杂的Q 对象。同时，Q 对象可以使用~ 操作符取反，这允许组合正常的查询和取反(NOT) 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 示例：查询作者名字是小仙女并且不是2018年出版的书的书名。<br>models.Book.objects.filter(Q(author__name&#x3D;&quot;小仙女&quot;) &amp; ~Q(publish_date__year&#x3D;2018)).values_list(&quot;title&quot;)<br>&lt;QuerySet [(&#39;番茄物语&#39;,)]&gt;<br></code></pre></td></tr></table></figure>

<p>查询函数可以混合使用Q 对象和关键字参数。所有提供给查询函数的参数（关键字参数或Q 对象）都将”AND”在一起。但是，如果出现Q 对象，它必须位于所有关键字参数的前面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 例如：查询出版年份是2017或2018，书名中带物语的所有书。<br>models.Book.objects.filter(Q(publish_date__year&#x3D;2018)|Q(publish_date__year&#x3D;2017),title__icontains&#x3D;&quot;物语&quot;)<br># &lt;QuerySet [&lt;Book: 番茄物语&gt;, &lt;Book: 香蕉物语&gt;, &lt;Book: 橘子物语&gt;]&gt;<br># | 是或操作，后面的title__icontains是且操作<br></code></pre></td></tr></table></figure>

<p>Q还有一种写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 方式二：<br>from django.db.models import Q<br>con &#x3D; Q()<br>q1 &#x3D; Q()<br>q1.connector &#x3D; &#39;OR&#39;<br>q1.children.append((&#39;id&#39;, 1))<br>q1.children.append((&#39;id__gt&#39;, 10))<br>q1.children.append((&#39;id&#39;, 9))<br>q2 &#x3D; Q()<br>q2.connector &#x3D; &#39;OR&#39;<br>q2.children.append((&#39;c1&#39;, 1))<br>q2.children.append((&#39;c1&#39;, 10))<br>q2.children.append((&#39;c1__gt&#39;, 9))<br>con.add(q1, &#39;AND&#39;)<br>con.add(q2, &#39;AND&#39;)<br><br>models.Tb1.objects.filter(con)<br></code></pre></td></tr></table></figure>

<h2 id="修改表记录"><a href="#修改表记录" class="headerlink" title="修改表记录"></a><strong>修改表记录</strong></h2><p><img src="/picture/1629200162-5ea5d8f4de11648140c1748b1f295e36.png" srcset="/img/loading.gif" lazyload></p>
<p>注意：</p>
<p>&lt;1&gt; 第二种方式修改不能用get的原因是：update是QuerySet对象的方法，get返回的是一个model对象，它没有update方法，而filter返回的是一个QuerySet对象(filter里面的条件可能有多个条件符合，比如name＝’alvin’,可能有两个name＝’alvin’的行数据)。</p>
<p>&lt;2&gt;在“插入和更新数据”小节中，我们有提到模型的save()方法，这个方法会更新一行里的所有列。 而某些情况下，我们只需要更新行里的某几列。</p>
<p>此外，<strong>update()方法对于任何结果集（QuerySet）均有效</strong>，这意味着你可以同时更新多条记录update()方法会返回一个整型数值，表示受影响的记录条数。</p>
<p>注意，这里因为update返回的是一个整形，所以没法用query属性；对于每次创建一个对象，想显示对应的raw sql，需要在settings加上日志记录部分</p>
<h2 id="删除表记录"><a href="#删除表记录" class="headerlink" title="删除表记录"></a><strong>删除表记录</strong></h2><p>queryset 和 modelobject 都有delete方法，它运行时立即删除对象而不返回任何值。</p>
<p>你也可以一次性删除多个对象。每个 QuerySet 都有一个 delete() 方法，它一次性删除 QuerySet 中所有的对象。</p>
<p>例如，下面的代码将删除 pub_date 是2005年的 Entry 对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">Entry.objects.filter(pub_date__year&#x3D;2005).delete()<br></code></pre></td></tr></table></figure>

<p>要牢记这一点：无论在什么情况下，QuerySet 中的 delete() 方法都只使用一条 SQL 语句一次性删除所有对象，而并不是分别删除每个对象。如果你想使用在 model 中自定义的 delete() 方法，就要自行调用每个对象的delete 方法。(例如，遍历 QuerySet，在每个对象上调用 delete()方法)，而不是使用 QuerySet 中的 delete()方法。</p>
<p>在 Django 删除对象时，会模仿 SQL 约束 ON DELETE CASCADE 的行为，换句话说，删除一个对象时也会删除与它相关联的外键对象。例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">b = Blog.objects.<span class="hljs-builtin-name">get</span>(<span class="hljs-attribute">pk</span>=1)<br><span class="hljs-comment"># This will delete the Blog and all of its Entry objects.</span><br>b.delete()<br></code></pre></td></tr></table></figure>

<p>要注意的是： delete() 方法是 QuerySet 上的方法，但并不适用于 Manager 本身。这是一种保护机制，是为了避免意外地调用 Entry.objects.delete() 方法导致 所有的 记录被误删除。如果你确认要删除所有的对象，那么你必须显式地调用：</p>
<p>Entry.objects.all().delete()</p>
<p>如果不想级联删除，可以设置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">pubHouse &#x3D; models.ForeignKey(to&#x3D;&#39;Publisher&#39;, on_delete&#x3D;models.SET_NULL, blank&#x3D;True, null&#x3D;True)<br></code></pre></td></tr></table></figure>

<h3 id="锁和事务"><a href="#锁和事务" class="headerlink" title="锁和事务"></a>锁和事务</h3><h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p>select_for_update(nowait&#x3D;False, skip_locked&#x3D;False)</p>
<p>返回一个锁住行直到事务结束的查询集，如果数据库支持，它将生成一个 SELECT … FOR UPDATE 语句。</p>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">entries &#x3D; Entry.objects.select_for_update().filter(author&#x3D;request.user)<br></code></pre></td></tr></table></figure>

<p>所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。</p>
<p>一般情况下如果其他事务锁定了相关行，那么本查询将被阻塞，直到锁被释放。 如果这不想要使查询阻塞的话，使用select_for_update(nowait&#x3D;True)。 如果其它事务持有冲突的锁, 那么查询将引发 DatabaseError 异常。你也可以使用select_for_update(skip_locked&#x3D;True)忽略锁定的行。 nowait和skip_locked是互斥的，同时设置会导致ValueError。</p>
<p>目前，postgresql，oracle和mysql数据库后端支持select_for_update()。 但是，MySQL不支持nowait和skip_locked参数。</p>
<p>使用不支持这些选项的数据库后端（如MySQL）将nowait&#x3D;True或skip_locked&#x3D;True转换为select_for_update()将导致抛出DatabaseError异常，这可以防止代码意外终止。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain">import os<br><br>if __name__ &#x3D;&#x3D; &#39;__main__&#39;:<br>    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;BMS.settings&quot;)<br>    import django<br>    django.setup()<br><br>    import datetime<br>    from app01 import models<br><br>    try:<br>        from django.db import transaction<br>        with transaction.atomic():<br>            new_publisher &#x3D; models.Publisher.objects.create(name&#x3D;&quot;火星出版社&quot;)<br>            models.Book.objects.create(title&#x3D;&quot;橘子物语&quot;, publish_date&#x3D;datetime.date.today(), publisher_id&#x3D;10)  # 指定一个不存在的出版社id<br>    except Exception as e:<br>        print(str(e))<br></code></pre></td></tr></table></figure>

<h1 id="其他鲜为人知的操作（有个印象即可）"><a href="#其他鲜为人知的操作（有个印象即可）" class="headerlink" title="其他鲜为人知的操作（有个印象即可）"></a>其他鲜为人知的操作（有个印象即可）</h1><h2 id="Django-ORM执行原生SQL"><a href="#Django-ORM执行原生SQL" class="headerlink" title="Django ORM执行原生SQL"></a>Django ORM执行原生SQL</h2><p>在模型查询API不够用的情况下，我们还可以使用原始的SQL语句进行查询。Django 提供两种方法使用原始SQL进行查询：</p>
<ul>
<li>一种是使用raw()方法，进行原始SQL查询并返回模型实例；</li>
<li>另一种是完全避开模型层，直接执行自定义的SQL语句。</li>
</ul>
<h3 id="执行原生查询"><a href="#执行原生查询" class="headerlink" title="执行原生查询"></a>执行原生查询</h3><p>raw()管理器方法用于原始的SQL查询，并返回模型的实例：</p>
<p><em>注意：raw()语法查询必须包含主键。</em></p>
<p>这个方法执行原始的SQL查询，并返回一个django.db.models.query.RawQuerySet 实例。 这个RawQuerySet 实例可以像一般的QuerySet那样，通过迭代来提供对象实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain">class Person(models.Model):<br>    first_name &#x3D; models.CharField(...)<br>    last_name &#x3D; models.CharField(...)<br>    birth_date &#x3D; models.DateField(...)<br><br># 可以像下面这样执行原生SQL语句<br>for p in Person.objects.raw(&#39;SELECT * FROM myapp_person&#39;):<br>    print(p)<br></code></pre></td></tr></table></figure>

<p>raw()查询可以查询其他表的数据。但是查询到的数据要和模型表的定义的字段一一对应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">ret &#x3D; models.Student.objects.raw(&#39;select id, tname as hehe from app02_teacher&#39;)<br>for i in ret:<br>    print(i.id, i.hehe)<br></code></pre></td></tr></table></figure>

<p>raw()方法自动将查询字段映射到模型字段。还可以通过translations参数指定一个把查询的字段名和ORM对象实例的字段名互相对应的字典</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">d &#x3D; &#123;&#39;tname&#39;: &#39;haha&#39;&#125;<br>ret &#x3D; models.Student.objects.raw(&#39;select * from app02_teacher&#39;, translations&#x3D;d)<br>for i in ret:<br>    print(i.id, i.sname, i.haha)<br></code></pre></td></tr></table></figure>

<p>原生SQL还可以使用参数，注意不要自己使用字符串格式化拼接SQL语句，防止SQL注入！参数 params</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">d &#x3D; &#123;&#39;tname&#39;: &#39;haha&#39;&#125;<br>ret &#x3D; models.Student.objects.raw(&#39;select * from app02_teacher where id &gt; %s&#39;, translations&#x3D;d, params&#x3D;[1,])<br>for i in ret:<br>    print(i.id, i.sname, i.haha)<br></code></pre></td></tr></table></figure>

<h3 id="直接执行自定义SQL"><a href="#直接执行自定义SQL" class="headerlink" title="直接执行自定义SQL"></a>直接执行自定义SQL</h3><p>有时候raw()方法并不十分好用，很多情况下我们不需要将查询结果映射成模型，或者我们需要执行DELETE、 INSERT以及UPDATE操作。在这些情况下，我们可以直接访问数据库，完全避开模型层。</p>
<p>我们可以直接从django提供的接口中获取数据库连接，然后像使用pymysql模块一样操作数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">from django.db import connection, connections<br>cursor &#x3D; connection.cursor()  # cursor &#x3D; connections[&#39;default&#39;].cursor()<br>cursor.execute(&quot;&quot;&quot;SELECT * from auth_user where id &#x3D; %s&quot;&quot;&quot;, [1])<br>ret &#x3D; cursor.fetchone()<br></code></pre></td></tr></table></figure>

<h2 id="QuerySet方法大全"><a href="#QuerySet方法大全" class="headerlink" title="QuerySet方法大全"></a><strong>QuerySet方法大全</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs plain">def all(self)<br>    # 获取所有的数据对象<br><br>def filter(self, *args, **kwargs)<br>    # 条件查询，过滤，条件可以是：参数，字典，Q<br><br>def exclude(self, *args, **kwargs)<br>    # 条件查询，除了，条件可以是：参数，字典，Q<br><br>def select_related(self, *fields)<br>    性能相关：表之间进行join连表操作，一次性获取关联的数据。<br>    总结：<br>    1. select_related主要针一对一和多对一关系进行优化。<br>    2. select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。<br><br>def prefetch_related(self, *lookups)<br>    性能相关：多表连表操作时速度会慢，使用其执行多次SQL查询在Python代码中实现连表操作。<br>    总结：<br>    1. 对于多对多字段（ManyToManyField）和一对多字段，可以使用prefetch_related()来进行优化。<br>    2. prefetch_related()的优化方式是分别查询每个表，然后用Python处理他们之间的关系。<br><br>def annotate(self, *args, **kwargs)<br>    # 用于实现聚合group by查询<br>    from django.db.models import Count, Avg, Max, Min, Sum<br><br>    v &#x3D; models.UserInfo.objects.values(&#39;u_id&#39;).annotate(uid&#x3D;Count(&#39;u_id&#39;))<br>    # SELECT u_id, COUNT(ui) AS &#96;uid&#96; FROM UserInfo GROUP BY u_id<br><br>    v &#x3D; models.UserInfo.objects.values(&#39;u_id&#39;).annotate(uid&#x3D;Count(&#39;u_id&#39;)).filter(uid__gt&#x3D;1)<br>    # SELECT u_id, COUNT(ui_id) AS &#96;uid&#96; FROM UserInfo GROUP BY u_id having count(u_id) &gt; 1<br><br>    v &#x3D; models.UserInfo.objects.values(&#39;u_id&#39;).annotate(uid&#x3D;Count(&#39;u_id&#39;,distinct&#x3D;True)).filter(uid__gt&#x3D;1)<br>    # SELECT u_id, COUNT( DISTINCT ui_id) AS &#96;uid&#96; FROM UserInfo GROUP BY u_id having count(u_id) &gt; 1<br><br>def distinct(self, *field_names)<br>    # 用于distinct去重<br>    models.UserInfo.objects.values(&#39;nid&#39;).distinct()<br>    # select distinct nid from userinfo<br><br>    注：只有在PostgreSQL中才能使用distinct进行去重<br><br>def order_by(self, *field_names)<br>    # 用于排序<br>    models.UserInfo.objects.all().order_by(&#39;-id&#39;,&#39;age&#39;)<br><br>def extra(self, select&#x3D;None, where&#x3D;None, params&#x3D;None, tables&#x3D;None, order_by&#x3D;None, select_params&#x3D;None)<br>    # 构造额外的查询条件或者映射，如：子查询<br><br>    Entry.objects.extra(select&#x3D;&#123;&#39;new_id&#39;: &quot;select col from sometable where othercol &gt; %s&quot;&#125;, select_params&#x3D;(1,))<br>    Entry.objects.extra(where&#x3D;[&#39;headline&#x3D;%s&#39;], params&#x3D;[&#39;Lennon&#39;])<br>    Entry.objects.extra(where&#x3D;[&quot;foo&#x3D;&#39;a&#39; OR bar &#x3D; &#39;a&#39;&quot;, &quot;baz &#x3D; &#39;a&#39;&quot;])<br>    Entry.objects.extra(select&#x3D;&#123;&#39;new_id&#39;: &quot;select id from tb where id &gt; %s&quot;&#125;, select_params&#x3D;(1,), order_by&#x3D;[&#39;-nid&#39;])<br><br>def reverse(self):<br>    # 倒序<br>    models.UserInfo.objects.all().order_by(&#39;-nid&#39;).reverse()<br>    # 注：如果存在order_by，reverse则是倒序，如果多个排序则一一倒序<br><br><br>def defer(self, *fields):<br>    models.UserInfo.objects.defer(&#39;username&#39;,&#39;id&#39;)<br>    或<br>    models.UserInfo.objects.filter(...).defer(&#39;username&#39;,&#39;id&#39;)<br>    #映射中排除某列数据<br><br>def only(self, *fields):<br>    # 仅取某个表中的数据<br>    models.UserInfo.objects.only(&#39;username&#39;,&#39;id&#39;)<br>    # 或<br>    models.UserInfo.objects.filter(...).only(&#39;username&#39;,&#39;id&#39;)<br><br>def using(self, alias):<br>     指定使用的数据库，参数为别名（setting中的设置）<br><br><br>##################################################<br># PUBLIC METHODS THAT RETURN A QUERYSET SUBCLASS #<br>##################################################<br>def raw(self, raw_query, params&#x3D;None, translations&#x3D;None, using&#x3D;None):<br>    # 执行原生SQL<br>    models.UserInfo.objects.raw(&#39;select * from userinfo&#39;)<br><br>    # 如果SQL是其他表时，必须将名字设置为当前UserInfo对象的主键列名<br>    models.UserInfo.objects.raw(&#39;select id as nid from 其他表&#39;)<br><br>    # 为原生SQL设置参数<br>    models.UserInfo.objects.raw(&#39;select id as nid from userinfo where nid&gt;%s&#39;, params&#x3D;[12,])<br><br>    # 将获取的到列名转换为指定列名<br>    name_map &#x3D; &#123;&#39;first&#39;: &#39;first_name&#39;, &#39;last&#39;: &#39;last_name&#39;, &#39;bd&#39;: &#39;birth_date&#39;, &#39;pk&#39;: &#39;id&#39;&#125;<br>    Person.objects.raw(&#39;SELECT * FROM some_other_table&#39;, translations&#x3D;name_map)<br><br>    # 指定数据库<br>    models.UserInfo.objects.raw(&#39;select * from userinfo&#39;, using&#x3D;&quot;default&quot;)<br><br>    ################### 原生SQL ###################<br>    from django.db import connection, connections<br>    cursor &#x3D; connection.cursor()  # cursor &#x3D; connections[&#39;default&#39;].cursor()<br>    cursor.execute(&quot;&quot;&quot;SELECT * from auth_user where id &#x3D; %s&quot;&quot;&quot;, [1])<br>    row &#x3D; cursor.fetchone() # fetchall()&#x2F;fetchmany(..)<br><br><br>def values(self, *fields):<br>    # 获取每行数据为字典格式<br><br>def values_list(self, *fields, **kwargs):<br>    # 获取每行数据为元祖<br><br>def dates(self, field_name, kind, order&#x3D;&#39;ASC&#39;):<br>    # 根据时间进行某一部分进行去重查找并截取指定内容<br>    # kind只能是：&quot;year&quot;（年）, &quot;month&quot;（年-月）, &quot;day&quot;（年-月-日）<br>    # order只能是：&quot;ASC&quot;  &quot;DESC&quot;<br>    # 并获取转换后的时间<br>        - year : 年-01-01<br>        - month: 年-月-01<br>        - day  : 年-月-日<br><br>    models.DatePlus.objects.dates(&#39;ctime&#39;,&#39;day&#39;,&#39;DESC&#39;)<br><br>def datetimes(self, field_name, kind, order&#x3D;&#39;ASC&#39;, tzinfo&#x3D;None):<br>    # 根据时间进行某一部分进行去重查找并截取指定内容，将时间转换为指定时区时间<br>    # kind只能是 &quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;hour&quot;, &quot;minute&quot;, &quot;second&quot;<br>    # order只能是：&quot;ASC&quot;  &quot;DESC&quot;<br>    # tzinfo时区对象<br>    models.DDD.objects.datetimes(&#39;ctime&#39;,&#39;hour&#39;,tzinfo&#x3D;pytz.UTC)<br>    models.DDD.objects.datetimes(&#39;ctime&#39;,&#39;hour&#39;,tzinfo&#x3D;pytz.timezone(&#39;Asia&#x2F;Shanghai&#39;))<br><br>    &quot;&quot;&quot;<br>    pip3 install pytz<br>    import pytz<br>    pytz.all_timezones<br>    pytz.timezone(‘Asia&#x2F;Shanghai’)<br>    &quot;&quot;&quot;<br><br>def none(self):<br>    # 空QuerySet对象<br><br><br>####################################<br># METHODS THAT DO DATABASE QUERIES #<br>####################################<br><br>def aggregate(self, *args, **kwargs):<br>   # 聚合函数，获取字典类型聚合结果<br>   from django.db.models import Count, Avg, Max, Min, Sum<br>   result &#x3D; models.UserInfo.objects.aggregate(k&#x3D;Count(&#39;u_id&#39;, distinct&#x3D;True), n&#x3D;Count(&#39;nid&#39;))<br>   &#x3D;&#x3D;&#x3D;&gt; &#123;&#39;k&#39;: 3, &#39;n&#39;: 4&#125;<br><br>def count(self):<br>   # 获取个数<br><br>def get(self, *args, **kwargs):<br>   # 获取单个对象<br><br>def create(self, **kwargs):<br>   # 创建对象<br><br>def bulk_create(self, objs, batch_size&#x3D;None):<br>    # 批量插入<br>    # batch_size表示一次插入的个数<br>    objs &#x3D; [<br>        models.DDD(name&#x3D;&#39;r11&#39;),<br>        models.DDD(name&#x3D;&#39;r22&#39;)<br>    ]<br>    models.DDD.objects.bulk_create(objs, 10)<br><br>def get_or_create(self, defaults&#x3D;None, **kwargs):<br>    # 如果存在，则获取，否则，创建<br>    # defaults 指定创建时，其他字段的值<br>    obj, created &#x3D; models.UserInfo.objects.get_or_create(username&#x3D;&#39;root1&#39;, defaults&#x3D;&#123;&#39;email&#39;: &#39;1111111&#39;,&#39;u_id&#39;: 2, &#39;t_id&#39;: 2&#125;)<br><br>def update_or_create(self, defaults&#x3D;None, **kwargs):<br>    # 如果存在，则更新，否则，创建<br>    # defaults 指定创建时或更新时的其他字段<br>    obj, created &#x3D; models.UserInfo.objects.update_or_create(username&#x3D;&#39;root1&#39;, defaults&#x3D;&#123;&#39;email&#39;: &#39;1111111&#39;,&#39;u_id&#39;: 2, &#39;t_id&#39;: 1&#125;)<br><br>def first(self):<br>   # 获取第一个<br><br>def last(self):<br>   # 获取最后一个<br><br>def in_bulk(self, id_list&#x3D;None):<br>   # 根据主键ID进行查找<br>   id_list &#x3D; [11,21,31]<br>   models.DDD.objects.in_bulk(id_list)<br><br>def delete(self):<br>   # 删除<br><br>def update(self, **kwargs):<br>    # 更新<br><br>def exists(self):<br>   # 是否有结果<br></code></pre></td></tr></table></figure>

<h1 id="Django终端打印SQL语句"><a href="#Django终端打印SQL语句" class="headerlink" title="Django终端打印SQL语句"></a>Django终端打印SQL语句</h1><p>在Django项目的settings.py文件中，在最后复制粘贴如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain">LOGGING &#x3D; &#123;<br>    &#39;version&#39;: 1,<br>    &#39;disable_existing_loggers&#39;: False,<br>    &#39;handlers&#39;: &#123;<br>        &#39;console&#39;:&#123;<br>            &#39;level&#39;:&#39;DEBUG&#39;,<br>            &#39;class&#39;:&#39;logging.StreamHandler&#39;,<br>        &#125;,<br>    &#125;,<br>    &#39;loggers&#39;: &#123;<br>        &#39;django.db.backends&#39;: &#123;<br>            &#39;handlers&#39;: [&#39;console&#39;],<br>            &#39;propagate&#39;: True,<br>            &#39;level&#39;:&#39;DEBUG&#39;,<br>        &#125;,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>即为你的Django项目配置上一个名为_django.db.backends_的logger实例即可查看翻译后的SQL语句。</p>
<h1 id="在Python脚本中调用Django环境"><a href="#在Python脚本中调用Django环境" class="headerlink" title="在Python脚本中调用Django环境"></a>在Python脚本中调用Django环境</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plain">import os<br><br>if __name__ &#x3D;&#x3D; &#39;__main__&#39;:<br>    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;BMS.settings&quot;)<br>    import django<br>    django.setup()<br><br>    from app01 import models<br><br>    books &#x3D; models.Book.objects.all()<br>    print(books)<br></code></pre></td></tr></table></figure>


<h2 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h2><p>没外键的话，没办法联表查询。</p>
<p>Django ORM有硬性规定，不论是已有表做ORM映射还是用ORM创建的表，都必须满足以下条件</p>
<blockquote>
<p>外键字段必须以 xxx_id 的格式命名</p>
</blockquote>
<p>另外，如表之间确实有关联，请务必使用ForeignKey，请勿道听途说不使用外键。</p>
<p>不使用外键是指数据库层面的外键约束，而Django ORM所使用的是查询引擎的查询逻辑。所以要关闭数据库层面的外键约束，只需要使用db_constraint参数设置为False即可。但建议再按照业务需求，设置上索引和联合索引即可。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Python/" class="category-chain-item">Python</a>
  
  
    <span>></span>
    
  <a href="/categories/Python/Django/" class="category-chain-item">Django</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Python/" class="print-no-link">#Python</a>
      
        <a href="/tags/Django/" class="print-no-link">#Django</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Django 入门之 ORM 增删改查，F Q 原生sql</div>
      <div>https://flepeng.github.io/021-Python-34-框架-Django-Django-入门之-ORM-增删改查，F-Q-原生sql/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lepeng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2016年8月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/021-Python-34-%E6%A1%86%E6%9E%B6-Django-Django-%E5%85%A5%E9%97%A8%E4%B9%8B-ORM-%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99/" title="Django 入门之 ORM 区分大小写">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Django 入门之 ORM 区分大小写</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/021-Python-34-%E6%A1%86%E6%9E%B6-Django-Django-%E5%85%A5%E9%97%A8%E4%B9%8B-ORM-%E7%BC%93%E5%AD%98-%E4%B8%AD%E4%BB%8B%E6%A8%A1%E5%9E%8B-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" title="Django 入门之 ORM 缓存 中介模型 查询优化">
                        <span class="hidden-mobile">Django 入门之 ORM 缓存 中介模型 查询优化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"flepeng/hexo-blog-comment","repo-id":"R_kgDOL0qaig","category":"Announcements","category-id":"DIC_kwDOL0qais4CfBIv","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
