

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2488174175014870" crossorigin="anonymous"></script><!-- google 广告 -->
  <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lepeng">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、系统架构演变之路(回顾) 1.1 单一应用架构当网站流量很小时，只需要一个应用，所有功能部署在一起，减少部署节点成本的框架称之为集中式框架。此时，用于简化增删改查工作量的数据访问框架(ORM)是影响项目开发的关键。 1.2 垂直应用架构当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。 1.">
<meta property="og:type" content="article">
<meta property="og:title" content="107-SpringCloud">
<meta property="og:url" content="https://flepeng.github.io/021-Java-01-course-107-SpringCloud/index.html">
<meta property="og:site_name" content="Lepeng">
<meta property="og:description" content="一、系统架构演变之路(回顾) 1.1 单一应用架构当网站流量很小时，只需要一个应用，所有功能部署在一起，减少部署节点成本的框架称之为集中式框架。此时，用于简化增删改查工作量的数据访问框架(ORM)是影响项目开发的关键。 1.2 垂直应用架构当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。 1.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98%E4%B9%8B%E8%B7%AF.jpg">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/icon-spring-cloud.svg">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/image-20191220074545237.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557971730121.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564724624018.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564760940122.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557987811610.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557988231880.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564784551870.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/image-20191031013135509.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1561653396022.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1561653583141.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1561653748123.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557994266301.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557995896939.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564786319994.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1557988231880.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558056004897.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564761498131.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558056614463.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558056672192.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558056769410.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558056924137.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1562968167562.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558059731124.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558059973068.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558060049703.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/hystrix-logo-tagline-640.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1564761547269.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558063933774.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1558063351797.png">
<meta property="og:image" content="https://flepeng.github.io/img/java/course/107/1561680726566.png">
<meta property="article:published_time" content="2020-02-01T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-03T10:25:30.294Z">
<meta property="article:author" content="Feng Lepeng">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://flepeng.github.io/img/java/course/107/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98%E4%B9%8B%E8%B7%AF.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>107-SpringCloud - Lepeng</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"flepeng.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f3d259b9efd9ce8655c180fd01bf0045","google":{"measurement_id":"G-LFTE4C7W3W"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f3d259b9efd9ce8655c180fd01bf0045";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-LFTE4C7W3W", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-LFTE4C7W3W');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lepeng 的 blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="107-SpringCloud"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-02-02 00:00" pubdate>
          2020年2月2日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          78 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">107-SpringCloud</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一、系统架构演变之路-回顾"><a href="#一、系统架构演变之路-回顾" class="headerlink" title="一、系统架构演变之路(回顾)"></a>一、系统架构演变之路(回顾)</h1><p><img src="/img/java/course/107/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98%E4%B9%8B%E8%B7%AF.jpg" srcset="/img/loading.gif" lazyload alt="系统架构演变之路"></p>
<h2 id="1-1-单一应用架构"><a href="#1-1-单一应用架构" class="headerlink" title="1.1 单一应用架构"></a><strong>1.1 单一应用架构</strong></h2><p>当网站流量很小时，只需要一个应用，所有功能部署在一起，减少部署节点成本的框架称之为集中式框架。此时，用于简化增删改查工作量的数据访问框架(ORM)是影响项目开发的关键。</p>
<h2 id="1-2-垂直应用架构"><a href="#1-2-垂直应用架构" class="headerlink" title="1.2 垂直应用架构"></a><strong>1.2 垂直应用架构</strong></h2><p>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。</p>
<h2 id="1-3-分布式服务架构"><a href="#1-3-分布式服务架构" class="headerlink" title="1.3 分布式服务架构"></a><strong>1.3 分布式服务架构</strong></h2><p>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。</p>
<h2 id="1-4-面向服务架构"><a href="#1-4-面向服务架构" class="headerlink" title="1.4 面向服务架构"></a>1.4 面向服务架构</h2><p>典型代表有两个：流动计算架构和微服务架构；</p>
<p><strong>流动计算架构：</strong></p>
<p>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。流动计算架构的最佳实践阿里的Dubbo。</p>
<p><strong>微服务架构</strong></p>
<p>与流动计算架构很相似，除了具备流动计算架构优势外，微服务架构中的微服务可以独立部署，独立发展。且微服务的开发不会限制于任何技术栈。微服务架构的最佳实践是SpringCloud。</p>
<h1 id="二、初识Spring-Cloud"><a href="#二、初识Spring-Cloud" class="headerlink" title="二、初识Spring Cloud"></a>二、初识Spring Cloud</h1><p><img src="/img/java/course/107/icon-spring-cloud.svg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>大家谈起的微服务，大多来讲说的只不过是种架构方式。其实现方式很多种：Spring Cloud，Dubbo，华为的Service Combo，Istio……。那么这么多的微服务架构产品中，我们为什么要用Spring Cloud？</p>
<ul>
<li>后台硬：作为Spring家族的一员，有整个Spring全家桶靠山，背景十分强大。</li>
<li>技术强：Spring作为Java领域的前辈，可以说是功力深厚。有强力的技术团队支撑，一般人还真比不了</li>
<li>群众基础好：可以说大多数程序员的成长都伴随着Spring框架，试问：现在有几家公司开发不用Spring？Spring Cloud与Spring的各个框架无缝整合，对大家来说一切都是熟悉的配方，熟悉的味道。</li>
<li>使用方便：相信大家都体会到了SpringBoot给我们开发带来的便利，而Spring Cloud完全支持Spring Boot的开发，用很少的配置就能完成微服务框架的搭建</li>
</ul>
<h2 id="2-1-Spring-Cloud简介"><a href="#2-1-Spring-Cloud简介" class="headerlink" title="2.1 Spring Cloud简介"></a>2.1 Spring Cloud简介</h2><p>Spring Cloud是Spring旗下的项目之一，官网地址：<a href="http://projects.spring.io/spring-cloud/" target="_blank" rel="noopener">http://projects.spring.io/spring-cloud/</a></p>
<p>Spring最擅长的就是集成，把世界上最好的框架拿过来，集成到自己的项目中。Spring Cloud并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<p>Spring Cloud也是一样，它将现在非常流行的一些技术整合到一起，实现了诸如：配置管理，服务发现，智能路由，负载均衡，熔断器，控制总线，集群状态等功能；协调分布式环境中各个系统，为各类服务提供模板性配置。其主要涉及的组件包括：</p>
<ul>
<li>Eureka：注册中心</li>
<li>Zuul、Gateway：服务网关</li>
<li>Ribbon：负载均衡</li>
<li>Feign：服务调用</li>
<li>Hystrix或Resilience4j：熔断器</li>
</ul>
<p>**&#x3D;&#x3D;Spring Cloud从技术架构上降低了对大型系统构建的要求和难度&#x3D;&#x3D;**，使我们以非常低的成本（技术或者硬件）搭建一套高效、分布式、容错的平台，但Spring Cloud也不是没有缺点，小型独立的项目不适合使用。</p>
<p><img src="/img/java/course/107/image-20191220074545237.png" srcset="/img/loading.gif" lazyload alt="image-20191220074545237"></p>
<h2 id="2-2-Spring-Cloud的版本"><a href="#2-2-Spring-Cloud的版本" class="headerlink" title="2.2 Spring Cloud的版本"></a>2.2 Spring Cloud的版本</h2><p><img src="/img/java/course/107/1557971730121.png" srcset="/img/loading.gif" lazyload alt="1557971730121"></p>
<ul>
<li>SpringCloud是一系列框架组合，为了避免与框架版本产生混淆，采用新的版本命名方式，形式为大版本名+子版本名称</li>
<li>大版本名用伦敦地铁站名：</li>
<li>子版本名称三种<ul>
<li>SNAPSHOT：快照版本，尝鲜版，随时可能修改</li>
<li>M版本，MileStone，M1表示第一个里程碑版本，一般同时标注PRE，表示预览版</li>
<li>SR，Service Release，SR1表示第一个正式版本，同时标注GA(Generally Available)，稳定版</li>
</ul>
</li>
</ul>
<h2 id="2-3-SpringCloud与SpringBoot版本匹配关系"><a href="#2-3-SpringCloud与SpringBoot版本匹配关系" class="headerlink" title="2.3 SpringCloud与SpringBoot版本匹配关系"></a>2.3 SpringCloud与SpringBoot版本匹配关系</h2><table>
<thead>
<tr>
<th>SpringBoot</th>
<th>SpringCloud</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.x</td>
<td>Angel版本</td>
</tr>
<tr>
<td>1.3.x</td>
<td>Brixton版本</td>
</tr>
<tr>
<td>1.4.x</td>
<td>Camden版本</td>
</tr>
<tr>
<td>1.5.x</td>
<td>Dalston版本、Edgware</td>
</tr>
<tr>
<td>2.0.x</td>
<td>Finchley版本</td>
</tr>
<tr>
<td>2.1.x</td>
<td>Greenwich GA版本 (2019年2月发布)</td>
</tr>
</tbody></table>
<p>鉴于SpringBoot与SpringCloud关系，SpringBoot建议采用2.1.x版本</p>
<h1 id="三、模拟微服务业务场景"><a href="#三、模拟微服务业务场景" class="headerlink" title="三、模拟微服务业务场景"></a>三、模拟微服务业务场景</h1><p>**目标：模拟一个最简单的服务调用场景，场景中包含微服务提供者(Producer)和微服务调用者(Consumer)**，方便后面学习微服务架构</p>
<p><strong>注意：实际开发中，每个微服务为一个独立的SpringBoot工程。</strong></p>
<h2 id="3-1-创建父工程"><a href="#3-1-创建父工程" class="headerlink" title="3.1 创建父工程"></a>3.1 创建父工程</h2><p>微服务中需要同时创建多个项目，为了方便，先创建一个父工程，然后后续的工程都以这个工程为父，实现maven的聚合。这样可以在一个窗口看到所有工程。在实际开发中，每个微服务可独立一个工程</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-tag"><span class="hljs-string">    http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Greenwich.SR1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper.starter.version</span>&gt;</span>2.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">mapper.starter.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.46<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- springCloud --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 通用Mapper启动器 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tk.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mapper.starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- mysql驱动 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="3-2-创建服务提供者-provider-工程"><a href="#3-2-创建服务提供者-provider-工程" class="headerlink" title="3.2 创建服务提供者(provider)工程"></a>3.2 创建服务提供者(provider)工程</h2><p><strong>目标：</strong>新建一个项目provider_service，对外提供查询用户的服务</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>创建SpringBoot工程，勾选依赖坐标</li>
<li>创建User表、创建实体User</li>
<li>编写三层架构：Mapper、Service、controller</li>
<li>编写查询方法，基于注解编写查询语句</li>
<li>在application.properties中添加配置：端口，数据库连接信息</li>
<li>访问测试地址</li>
</ol>
<p><strong>实现过程：</strong></p>
<ol>
<li><p>创建SpringBoot工程<img src="/img/java/course/107/1564724624018.png" srcset="/img/loading.gif" lazyload alt="1564724624018"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-tag"><span class="hljs-string">    http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tk.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在application.properties中添加配置：端口，数据库连接配置信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 端口</span><br><span class="hljs-attr">server.port:</span> <span class="hljs-number">9091</span><br><span class="hljs-comment"># 数据库连接配置信息</span><br><span class="hljs-attr">spring.datasource.driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/springcloud?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br><span class="hljs-attr">spring.datasource.password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.username:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">mybatis.type-aliases-package:</span> <span class="hljs-string">com.itheima.user.pojo</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>编写 <code>UserApplication.java</code> 启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.user;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> tk.mybatis.spring.annotation.MapperScan;<br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.itheima.user.mapper"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(UserApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建User表、创建实体User</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建数据库</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">database</span> springcloud <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci;<br><span class="hljs-comment">-- 使用springcloud数据库</span><br><span class="hljs-keyword">USE</span> springcloud;<br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for tb_user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`tb_user`</span> (<br> <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br> <span class="hljs-string">`username`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户名'</span>,<br> <span class="hljs-string">`password`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'密码'</span>,<br> <span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'姓名'</span>,<br> <span class="hljs-string">`age`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'年龄'</span>,<br> <span class="hljs-string">`sex`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'性别，1男，2女'</span>,<br> <span class="hljs-string">`birthday`</span> <span class="hljs-built_in">date</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'出生日期'</span>,<br> <span class="hljs-string">`created`</span> <span class="hljs-built_in">date</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'创建时间'</span>,<br> <span class="hljs-string">`updated`</span> <span class="hljs-built_in">date</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'更新时间'</span>,<br> <span class="hljs-string">`note`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1000</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'备注'</span>,<br> PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'用户信息表'</span>;<br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of tb_user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`tb_user`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'1'</span>, <span class="hljs-string">'zhangsan'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'13'</span>, <span class="hljs-string">'1'</span>, <span class="hljs-string">'2006-08-01'</span>, <span class="hljs-string">'2019-05-16'</span>, <span class="hljs-string">'2019-05-16'</span>, <span class="hljs-string">'张三'</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`tb_user`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'2'</span>, <span class="hljs-string">'lisi'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'13'</span>, <span class="hljs-string">'1'</span>, <span class="hljs-string">'2006-08-01'</span>, <span class="hljs-string">'2019-05-16'</span>, <span class="hljs-string">'2019-05-16'</span>, <span class="hljs-string">'李四'</span>);<br></code></pre></td></tr></table></figure>

<p>实体bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.user.pojo;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> tk.mybatis.mapper.annotation.KeySql;<br><span class="hljs-keyword">import</span> javax.persistence.Id;<br><span class="hljs-keyword">import</span> javax.persistence.Table;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-meta">@Table</span>(name = <span class="hljs-string">"tb_user"</span>)<br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Integer id;<span class="hljs-comment">//主键id</span><br>    <span class="hljs-keyword">private</span> String username;<span class="hljs-comment">//用户名</span><br>    <span class="hljs-keyword">private</span> String password;<span class="hljs-comment">//密码</span><br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//姓名</span><br>    <span class="hljs-keyword">private</span> Integer age;<span class="hljs-comment">//年龄</span><br>    <span class="hljs-keyword">private</span> Integer sex;<span class="hljs-comment">//性别 1男性，2女性</span><br>    <span class="hljs-keyword">private</span> Date birthday; <span class="hljs-comment">//出生日期</span><br>    <span class="hljs-keyword">private</span> Date created; <span class="hljs-comment">//创建时间</span><br>    <span class="hljs-keyword">private</span> Date updated; <span class="hljs-comment">//更新时间</span><br>    <span class="hljs-keyword">private</span> String note;<span class="hljs-comment">//备注</span><br>    <span class="hljs-comment">//getter setter</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写三层架构：Mapper、Service、controller，编写查询所有的方法</p>
<p>service类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findById</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userMapper.findById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/user"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;<br><br>    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/findById"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findById</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userService.findById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写查询方法，基于注解编写查询语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;<br>    <span class="hljs-comment">//根据id查询用户信息</span><br>    <span class="hljs-meta">@Select</span>(<span class="hljs-string">"select * from tb_user where id=#&#123;id&#125; ;"</span>)<br>    <span class="hljs-function">User <span class="hljs-title">findById</span><span class="hljs-params">(Integer id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>访问测试地址: <a href="http://localhost:9091/user/findById?id=1" target="_blank" rel="noopener">http://localhost:9091/user/findById?id=1</a></p>
</li>
</ol>
<h2 id="3-3-创建服务消费者-consumer-工程"><a href="#3-3-创建服务消费者-consumer-工程" class="headerlink" title="3.3 创建服务消费者(consumer)工程"></a>3.3 创建服务消费者(consumer)工程</h2><p><strong>目标：</strong>新建一个项目consumer_service，调用用户微服务提供的查询用户服务</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>创建消费者SpringBoot工程consumer_service</li>
<li>勾选starter：开发者工具devtools、web</li>
<li>注册http请求客户端对象RestTemplate</li>
<li>编写Controller，用RestTemplate访问服务提供者</li>
<li>启动服务并测试</li>
</ol>
<p><strong>实现过程：</strong></p>
<ol>
<li><p>创建consumer_service的SpringBoot工程<img src="/img/java/course/107/1564760940122.png" srcset="/img/loading.gif" lazyload alt="1564760940122"></p>
</li>
<li><p>pom.xml 文件如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-tag"><span class="hljs-string">    http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>consumer-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在启动类中注册RestTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br>    <span class="hljs-comment">//配置RestTemplate对象，注入spring容器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写ConsumerController，在Controller中直接调用RestTemplate，远程访问用户服务提供者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>   <br>    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/consumer/&#123;id&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findById</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Integer id)</span>&#123;<br>        String url = <span class="hljs-string">"http://localhost:9091/user/findById?id="</span>+id;<br>        <span class="hljs-comment">//将请求返回值反序列化为User对象，打印到控制台，同时输出到浏览器</span><br>        User user = restTemplate.getForObject(url, User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        System.out.println(user);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>启动并测试，访问：<a href="http://localhost:8080/consumer/1" target="_blank" rel="noopener">http://localhost:8080/consumer/1</a><img src="/img/java/course/107/1557987811610.png" srcset="/img/loading.gif" lazyload alt="1557987811610"></p>
</li>
</ol>
<h2 id="3-4-思考问题"><a href="#3-4-思考问题" class="headerlink" title="3.4 思考问题"></a>3.4 思考问题</h2><p>简单回顾一下，刚才我们写了什么：</p>
<ul>
<li>provider_service：对外提供用户查询接口</li>
<li>consumer_service：通过RestTemplate访问接口查询用户数据</li>
</ul>
<p>存在的问题：</p>
<ol>
<li>在消费者服务中，访问提供者服务URL地址硬编码，万一地址端口变化了怎么办？提供者服务死掉了消费者怎么才能知道？<br>在消费者服务中，是不清楚服务提供者状态的！</li>
<li>为了增加服务并发访问量，我们搭建集群，集群的负载均衡怎么实现？</li>
<li>服务提供者如果出现故障，会不会向用户抛出异常页面，该不该抛出错误页面？</li>
<li>RestTemplate这种请求调用方式是否还有优化空间？复用，管理，可读性角度来思考</li>
<li>多服务权限拦截如何实现？怎么保证所有微服务服务的安全性？</li>
<li>众多微服务的配置文件，每次都修改很多个，是不是很麻烦！？</li>
</ol>
<p>其实上面说的部分问题，概括一下就是微服务架构必然面临的一些问题。</p>
<ul>
<li>服务管理：自动注册与发现、状态监管</li>
<li>服务负载均衡</li>
<li>熔断</li>
<li>面向接口的远程调用</li>
<li>网关拦截、路由转发</li>
<li>统一配置修改</li>
</ul>
<h1 id="四、注册中心-Spring-Cloud-Eureka"><a href="#四、注册中心-Spring-Cloud-Eureka" class="headerlink" title="四、注册中心 Spring Cloud Eureka"></a>四、注册中心 Spring Cloud Eureka</h1><blockquote>
<p>在消费者服务中，访问url地址硬编码了，url地址端口变化了怎么办？服务死掉了才能知道？</p>
</blockquote>
<h2 id="4-1-Eureka-简介"><a href="#4-1-Eureka-简介" class="headerlink" title="4.1 Eureka 简介"></a>4.1 Eureka 简介</h2><p><strong>Spirng Cloud Eureka使用Netflix Eureka来实现服务注册与发现（服务治理）。</strong> 它既包含了服务端组件，也包含了客户端组件，并且服务端与客户端均采用java编写，所以Eureka主要适用于通过java实现的分布式系统，或是JVM兼容语言构建的系统。</p>
<p><strong>Eureka服务端组件：</strong> 即服务注册中心。它同其他服务注册中心一样，支持高可用配置。依托于强一致性提供良好的服务实例可用性，可以应对多种不同的故障场景。</p>
<p><strong>Eureka客户端组件：</strong> 主要处理服务的注册和发现。客户端服务通过注册和参数配置的方式，嵌入在客户端应用程序的代码中。在应用程序启动时，Eureka客户端向服务注册中心注册自身提供的服务，并周期性的发送心跳来更新它的服务租约。同时，他也能从服务端查询当前注册的服务信息并把它们缓存到本地，并周期性的刷新服务状态。</p>
<h2 id="4-2-架构图"><a href="#4-2-架构图" class="headerlink" title="4.2 架构图"></a>4.2 架构图</h2><p>基本架构图</p>
<p><img src="/img/java/course/107/1557988231880.png" srcset="/img/loading.gif" lazyload alt="1557988231880"></p>
<ul>
<li>Eureka：就是服务注册中心（可以是一个集群），对外暴露自己的地址</li>
<li>提供者：启动后向Eureka注册自己信息（地址，提供什么服务）</li>
<li>消费者：向Eureka订阅服务，Eureka会将对应服务的所有提供者地址列表发送给消费者，并且定期更新</li>
<li>心跳(续约)：提供者定期通过http方式向Eureka刷新自己的状态</li>
</ul>
<h2 id="4-3-整合注册中心Eureka"><a href="#4-3-整合注册中心Eureka" class="headerlink" title="4.3 整合注册中心Eureka"></a>4.3 整合注册中心Eureka</h2><p><strong>步骤分三步：</strong></p>
<ul>
<li>第一步：搭建eureka服务，创建eureka_server工程</li>
<li>第二步：服务提供者provider_service，注册到eureka注册中心</li>
<li>第三步：服务消费者consumer_service，注册到eureka注册中心</li>
</ul>
<h3 id="4-3-1-搭建eureka-server工程"><a href="#4-3-1-搭建eureka-server工程" class="headerlink" title="4.3.1 搭建eureka-server工程"></a>4.3.1 搭建eureka-server工程</h3><ol>
<li><p>创建eureka_server的springboot工程。<img src="/img/java/course/107/1564784551870.png" srcset="/img/loading.gif" lazyload alt="1564784551870"></p>
</li>
<li><p>勾选坐标<img src="/img/java/course/107/image-20191031013135509.png" srcset="/img/loading.gif" lazyload alt="image-20191031013135509"></p>
</li>
<li><p>在启动类EurekaServerApplication声明当前应用为Eureka服务使用<code>@EnableEurekaServer</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;<br><span class="hljs-comment">//声明当前应用为eureka服务</span><br><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(EurekaServerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写配置文件application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10086</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span> <span class="hljs-comment"># 应用名称，会在Eureka中作为服务的id标识（serviceId）</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer的地址，现在是自己的地址，如果是集群，需要写其它Server的地址。</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 不注册自己</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否抓取注册列表,不拉取</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>启动EurekaServerApplication</p>
</li>
<li><p>测试访问地址<a href="http://127.0.0.1:10086，如下信息代表访问成功">http://127.0.0.1:10086，如下信息代表访问成功</a></p>
<ul>
<li><img src="/img/java/course/107/1561653396022.png" srcset="/img/loading.gif" lazyload alt="1561653396022"></li>
<li><img src="/img/java/course/107/1561653583141.png" srcset="/img/loading.gif" lazyload alt="1561653583141"></li>
<li><img src="/img/java/course/107/1561653748123.png" srcset="/img/loading.gif" lazyload alt="1561653748123"></li>
</ul>
</li>
</ol>
<h3 id="4-3-2-服务提供者-注册到eureka"><a href="#4-3-2-服务提供者-注册到eureka" class="headerlink" title="4.3.2 服务提供者-注册到eureka"></a>4.3.2 服务提供者-注册到eureka</h3><ol>
<li><p>在服务提供者provider_service工程中添加Eureka客户端依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--eureka客户端starter--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在启动类上开启Eureka客户端发现功能<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// 开启Eureka客户端发现功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserApplication</span> </span>&#123;   <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(UserApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件：spring.application.name指定应用名称，作为服务ID使用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9091</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springcloud</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-comment">#应用名</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">cn.itcast.user.pojo</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:10086/eureka</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>完成之后重启项目</p>
</li>
<li><p>客户端代码会自动把服务注册到EurekaServer中，在Eureka监控页面可以看到服务注册成功信息</p>
<ul>
<li><img src="/img/java/course/107/1557994266301.png" srcset="/img/loading.gif" lazyload alt="1557994266301"></li>
</ul>
</li>
</ol>
<h3 id="4-3-3-服务消费者-注册到eureka"><a href="#4-3-3-服务消费者-注册到eureka" class="headerlink" title="4.3.3 服务消费者-注册到eureka"></a>4.3.3 服务消费者-注册到eureka</h3><p>步骤同上一小节</p>
<ol>
<li><p>在服务消费者consumer_service工程中添加Eureka客户端依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--eureka客户端starter--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在启动类开启Eureka客户端<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><span class="hljs-comment">//开启服务发现</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件：加入EurekaServer地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">consumer-demo</span> <span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer地址</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>启动服务，在服务中心查看是否注册成功</p>
</li>
<li><p>使用RestTemplate发送请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/consumer"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"&#123;id&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(@PathVariable Long id)</span></span>&#123;<br>        String url = String.format(<span class="hljs-string">"http://localhost:9091/user/%d"</span>, id);<br><br>        <span class="hljs-comment">//1、通过注册中心客户端对象DiscoveryClient，获取Eureka中注册的user-service实例列表</span><br>        List&lt;ServiceInstance&gt; serviceInstanceList = discoveryClient.getInstances(<span class="hljs-string">"user-service"</span>);<br>        <span class="hljs-comment">//2、获取user-service服务实例对象</span><br>        ServiceInstance serviceInstance = serviceInstanceList.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">//3、从实例对象中获取host地址和端口，拼接请求地址</span><br>        url = String.format(<span class="hljs-string">"http://%s:%s/user/%d"</span>, serviceInstance.getHost(), serviceInstance.getPort(), id);<br>        <span class="hljs-comment">//4.使用RestTemplate发送请求</span><br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(url,User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Debug跟踪运行<br>服务提供者地址拼接成功<img src="/img/java/course/107/1557995896939.png" srcset="/img/loading.gif" lazyload alt="1557995896939"></p>
<p>这里服务的host地址如果使用ip，则进行如下设置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 默认注册时使用的是主机名，想用ip进行注册添加如下配置</span><br><span class="hljs-comment"># ip地址</span><br><span class="hljs-attr">eureka.instance.ip-address:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br><span class="hljs-comment"># 更倾向于使用ip，而不是host名</span><br><span class="hljs-attr">eureka.instance.prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>修改配置之后<img src="/img/java/course/107/1564786319994.png" srcset="/img/loading.gif" lazyload alt="1564786319994"></p>
</li>
</ol>
<h2 id="4-4-高可用的Eureka-Server"><a href="#4-4-高可用的Eureka-Server" class="headerlink" title="4.4 高可用的Eureka Server"></a>4.4 高可用的Eureka Server</h2><p>Eureka Server即服务的注册中心，在刚才的案例中，我们只有一个EurekaServer，事实上EurekaServer也可以是一个集群，形成高可用的Eureka中心。</p>
<p>服务同步：多个Eureka Server之间也会互相注册为服务，当服务提供者注册到Eureka Server集群中的某个节点时，该节点会把服务的信息同步给集群中的每个节点，从而实现数据同步。因此，无论客户端访问到Eureka Server集群中的任意一个节点，都可以获取到完整的服务列表信息</p>
<p>而作为客户端，需要把信息注册到每个Eureka中：</p>
<p>如果有三个Eureka，则每一个EurekaServer都需要注册到其它几个Eureka服务中，例如：有三个分别为10086、10087、10088，则：</p>
<ul>
<li>10086要注册到10087和10088上</li>
<li>10087要注册到10086和10088上</li>
<li>10088要注册到10086和10087上</li>
</ul>
<h3 id="4-4-1-动手搭建高可用的EurekaServer"><a href="#4-4-1-动手搭建高可用的EurekaServer" class="headerlink" title="4.4.1 动手搭建高可用的EurekaServer"></a>4.4.1 动手搭建高可用的EurekaServer</h3><p>我们假设要搭建两台EurekaServer的集群，端口分别为：10086和10087</p>
<ol>
<li><p>修改原来的EurekaServer配置；修改 eureka-server\src\main\resources\application.yml 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-comment"># $&#123;&#125;表示在jvm启动时候若能找到对应port或者defaultZone参数则使用，若无则使用后面的默认值</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:10086&#125;</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>  <span class="hljs-comment"># 应用名称，会在eureka中作为服务的id(serviceId)</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>  <span class="hljs-attr">service-url:</span><br>    <span class="hljs-comment"># eureka服务地址；如果是集群则是其它服务器地址，后面要加/eureka</span><br>  <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;defaultZone:http://127.0.0.1:10086/eureka&#125;</span><br>  <span class="hljs-comment"># 是否注册自己，自身不提供服务所以不注册</span><br>  <span class="hljs-comment">#register-with-eureka: false</span><br>  <span class="hljs-comment"># 是否拉取服务</span><br>  <span class="hljs-comment">#fetch-registry: false</span><br></code></pre></td></tr></table></figure>

<p>所谓的高可用注册中心，其实就是把EurekaServer自己也作为一个服务，注册到其它EurekaServer上，这样多个EurekaServer之间就能互相发现对方，从而形成集群。因此我们做了以下修改：<strong>把register-with-eureka和fetch-registry修改为true或者注释掉</strong></p>
</li>
<li><p>先启动一个实例</p>
</li>
<li><p>另外一台在启动的时候指定端口port和defaultZone配置： VM options 中设置 <code>-DdefaultZone=http:127.0.0.1:10087/eureka</code></p>
</li>
<li><p>界面查看注册信息</p>
</li>
<li><p>客户端注册服务到集群<br>因为EurekaServer不止一个，因此 user-service 项目注册服务或者 consumer-demo 获取服务的时候，service-url参数需要修改为如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer地址,多个地址以','隔开</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-4-Eureka详解"><a href="#4-4-Eureka详解" class="headerlink" title="4.4 Eureka详解"></a>4.4 Eureka详解</h2><p><img src="/img/java/course/107/1557988231880.png" srcset="/img/loading.gif" lazyload alt="1557988231880"></p>
<h3 id="4-4-1-基础架构"><a href="#4-4-1-基础架构" class="headerlink" title="4.4.1 基础架构"></a>4.4.1 基础架构</h3><p>Eureka架构中的三个核心角色</p>
<ul>
<li>服务注册中心：Eureka服务端应用，提供服务管理(注册发现)功能</li>
<li>服务提供者：对外发布服务，供消费者调用<br>可以是SpringBoot应用，也可以是其它任意技术实现，只要对外提供的是Rest风格服务即可</li>
<li>服务消费者：服务提供者的调用方。从注册中心获取服务列表，通过列表调用服务提供者。</li>
</ul>
<h3 id="4-4-2-Eureka客户端与服务端交互过程"><a href="#4-4-2-Eureka客户端与服务端交互过程" class="headerlink" title="4.4.2 Eureka客户端与服务端交互过程"></a>4.4.2 Eureka客户端与服务端交互过程</h3><h4 id="服务注册（register）："><a href="#服务注册（register）：" class="headerlink" title="服务注册（register）："></a>服务注册（register）：</h4><p>Eureka Client会通过发送REST请求的方式，向Eureka Server注册自己的服务。注册时，提供自身的元数据，比如ip地址、端口、运行状况指标、主页地址等信息。Eureka Server接收到注册请求后，就会把这些元数据信息存储在一个双层的Map中。 </p>
<h4 id="服务续约（renew）："><a href="#服务续约（renew）：" class="headerlink" title="服务续约（renew）："></a>服务续约（renew）：</h4><p>在服务注册后，Eureka Client会维护一个心跳来持续通知Eureka Server，说明服务一直处于可用状态，防止被剔除。默认每隔30秒<code>eureka.instance.lease-renewal-interval-in-seconds</code>发送一次心跳来进行服务续约。</p>
<p><strong>配置消费者或服务提供者</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">90</span>  <span class="hljs-comment"># 服务失效时间，默认值90秒</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">30</span>     <span class="hljs-comment"># 租约续约间隔时间，默认30秒</span><br></code></pre></td></tr></table></figure>

<p>默认情况下每隔30秒服务会向注册中心发送一次心跳，证明自己还活着。如果超过90秒没有发送心跳，EurekaServer就会认为该服务宕机，会定时（eureka.server.eviction-interval-timer-in-ms设定的时间）从服务列表中移除，这两个值在生产环境不要修改，默认即可。</p>
<h4 id="获取服务列表（get-registry）："><a href="#获取服务列表（get-registry）：" class="headerlink" title="获取服务列表（get registry）："></a>获取服务列表（get registry）：</h4><p>服务消费者（Eureka Client）在启动的时候，会发送一个REST请求给Eureka Server，获取注册中心的服务清单，并且缓存在客户端本地。同时，为了性能及安全性考虑，Eureka Server会每隔30秒更新一次缓存中的服务清单。 </p>
<p><strong>配置消费者或服务提供者</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 每隔多久获取服务中心列表，(只读备份)</span><br><span class="hljs-attr">eureka.client.registry-fetch-interval-seconds:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>

<h4 id="服务调用："><a href="#服务调用：" class="headerlink" title="服务调用："></a>服务调用：</h4><p>服务消费者在获取到服务清单后，可以根据清单中的服务信息，查找到该服务的地址，从而进行访问(远程调用)。</p>
<h4 id="服务下线（cancel）："><a href="#服务下线（cancel）：" class="headerlink" title="服务下线（cancel）："></a>服务下线（cancel）：</h4><p>当Eureka Client需要关闭或重启时，就不希望在这个时间段内再有请求进来，所以，就需要提前先发送REST请求给Eureka Server，告诉Eureka Server自己要下线了，Eureka Server在收到请求后，就会把该服务状态置为下线（DOWN），并把该下线事件传播出去。 </p>
<h4 id="失效剔除（evict）："><a href="#失效剔除（evict）：" class="headerlink" title="失效剔除（evict）："></a>失效剔除（evict）：</h4><p>服务实例可能会因为网络故障等原因，导致不能提供服务，而此时该实例也没有发送请求给Eureka Server来进行服务下线。所以，还需要有服务剔除的机制。Eureka Server在启动的时候会创建一个定时任务，每隔一段时间（默认60秒），从当前服务清单中把超时没有续约（默认90秒<code>eureka.instance.lease-expiration-duration-in-seconds</code>）的服务剔除。</p>
<p><strong>配置消费者或服务提供者</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 租约到期，服务时效时间，默认值90秒</span><br><span class="hljs-attr">eureka.instance.lease-expiration-duration-in-seconds:</span> <span class="hljs-number">90</span><br></code></pre></td></tr></table></figure>

<h4 id="自我保护："><a href="#自我保护：" class="headerlink" title="自我保护："></a>自我保护：</h4><p>既然Eureka Server会定时剔除超时没有续约的服务，那就有可能出现一种场景，网络一段时间内发生了异常，所有的服务都没能够进行续约，Eureka Server就把所有的服务都剔除了，这样显然不太合理。所以，就有了自我保护机制。自我保护机制是，当在短时间内，统计续约失败的比例，如果达到一定阈值，则会触发自我保护的机制，在该机制下，Eureka Server不会剔除任何的微服务，等到正常后，再退出自我保护机制。自我保护开关(eureka.server.enable-self-preservation: false)</p>
<p><strong>配置到注册中心去</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#向Eureka服务中心集群注册服务</span><br><span class="hljs-attr">eureka.server.enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 关闭自我保护模式（默认值是打开）</span><br></code></pre></td></tr></table></figure>

<p><strong>Eureka会统计服务实例最近15分钟心跳续约的比例是否低于85%，如果低于则会触发自我保护机制。</strong></p>
<p>服务中心页面会显示如下提示信息</p>
<p><img src="/img/java/course/107/1558056004897.png" srcset="/img/loading.gif" lazyload alt="1558056004897"></p>
<p>含义：紧急情况！Eureka可能错误地声称实例已经启动，而事实并非如此。续约低于阈值，因此实例不会为了安全而过期。</p>
<ul>
<li>自我保护模式下，不会剔除任何服务实例</li>
<li>自我保护模式能够保证绝大多数服务的可用性</li>
</ul>
<h1 id="五、负载均衡-Spring-Cloud-Ribbon"><a href="#五、负载均衡-Spring-Cloud-Ribbon" class="headerlink" title="五、负载均衡 Spring Cloud Ribbon"></a>五、负载均衡 Spring Cloud Ribbon</h1><blockquote>
<p>为了增加服务并发访问量，我们搭建集群，集群的负载均衡怎么实现？</p>
</blockquote>
<h2 id="5-1-Ribbon-简介"><a href="#5-1-Ribbon-简介" class="headerlink" title="5.1 Ribbon 简介"></a>5.1 Ribbon 简介</h2><p>Ribbon是一个工具框架，实现了HTTP和TCP的客户端负载均衡的工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。它不是一个微服务需要独立部署，但是它 <strong>几乎存在于每一个Spring Cloud构建的微服务和基础设施中</strong>。因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括明天我们将要介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。</p>
<p>Ribbon默认提供的负载均衡算法：轮询，随机其他….。当然，我们可用自己定义负载均衡算法</p>
<p><img src="/img/java/course/107/1564761498131.png" srcset="/img/loading.gif" lazyload alt="1564761498131"></p>
<p><strong>除此之外的其他算法，了解一下就行：</strong></p>
<ul>
<li><p>RoundRobinRule：轮询算法</p>
</li>
<li><p>AvailabilityFilteringRule：根据当前服务是否熔断及并发情况进行负载均衡的算法</p>
</li>
<li><p>WeightedResponseTimeRule：根据服务响应时间来负载均衡的算法</p>
</li>
</ul>
<h2 id="5-2-入门案例"><a href="#5-2-入门案例" class="headerlink" title="5.2 入门案例"></a>5.2 入门案例</h2><p><strong>实现负载均衡访问用户服务</strong>。</p>
<p>如果想要做负载均衡，我们的服务至少2个以上。</p>
<p><strong>实现步骤：</strong></p>
<p>第一步：启动多个user_service服务</p>
<ol>
<li>修改配置文件端口获取方式</li>
<li>编辑应用启动配置</li>
<li>启动两个提供者服务</li>
<li>在注册中心查询是否启动成功</li>
</ol>
<p>第二步：开启消费者负载均衡</p>
<ol>
<li>在RestTemplate的注入方法上加入@LoadBalanced注解</li>
<li>修改调用请求的Url地址，改为服务名称调用</li>
<li>访问页面查看效果</li>
</ol>
<p><strong>实现过程：</strong></p>
<p>第一步：启动两个user_service应用</p>
<ol>
<li>修改UserServiceApplication的application.yml配置文件<ul>
<li>端口9091改为，<code>${port:9091}</code></li>
<li><img src="/img/java/course/107/1558056614463.png" srcset="/img/loading.gif" lazyload alt="1558056614463"></li>
</ul>
</li>
<li>编辑应用启动配置<ul>
<li><img src="/img/java/course/107/1558056672192.png" srcset="/img/loading.gif" lazyload alt="1558056672192"></li>
<li><img src="/img/java/course/107/1558056769410.png" srcset="/img/loading.gif" lazyload alt="1558056769410"></li>
</ul>
</li>
<li>复制一份UserServiceApplication<ul>
<li><img src="/img/java/course/107/1558056924137.png" srcset="/img/loading.gif" lazyload alt="1558056924137"></li>
</ul>
</li>
<li>启动两个UserServiceApplication应用</li>
<li>Eureka服务中心可查看，注册成功<img src="/img/java/course/107/1562968167562.png" srcset="/img/loading.gif" lazyload alt="1562968167562"></li>
</ol>
<p>第二步：开启消费者调用负载均衡</p>
<p>Eureka已经集成Ribbon，所以无需引入依赖。</p>
<ol>
<li><p>在RestTemplate的配置方法上添加 <code>@LoadBalanced</code> 注解即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@LoadBalanced</span><span class="hljs-comment">//开启负载均衡</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改ConsumerController调用方式，不再手动获取ip和端口，而是直接通过服务名称调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/&#123;id&#125;"</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryByIdByRibbon</span><span class="hljs-params">(@PathVariable Integer id)</span></span>&#123;<br>    String url = <span class="hljs-string">"http://user-service/user/findById?id="</span>+id;<br>    String user = restTemplate.getForObject(url, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>访问页面查看结果；并在9091和9092的控制台查看执行情况</p>
</li>
<li><p>Ribbon默认的负载均衡策略是轮询。SpringBoot也帮提供了修改负载均衡规则的配置入口在consumerdemo的配置文件中添加如下，就变成随机的了</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 修改服务地址轮询策略，默认是轮询，配置之后变随机,RoundRobinRule</span><br><span class="hljs-attr">user-service:</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="5-3-负载均衡源码跟踪探究-了解"><a href="#5-3-负载均衡源码跟踪探究-了解" class="headerlink" title="5.3 负载均衡源码跟踪探究(了解)"></a>5.3 负载均衡源码跟踪探究(了解)</h2><p>为什么只输入了Service名称就可以访问了呢？不应该需要获取ip和端口吗？</p>
<p>负载均衡器动态访问的本质，是从服务注册中心中获取服务提供者的访问地址(host、port)。这个过程显然是有某个组件，根据Service名称去获取了服务实例ip和端口。那么这个组件经过源码分析就是LoadBalancerInterceptor</p>
<p>这个负载均衡拦截器的类，会对RestTemplate的请求进行拦截，然后从服务清单中，获取服务集群的所有地址，随后利用负载均衡算法得到真正服务地址信息进行访问。</p>
<p>源码跟踪步骤：</p>
<ol>
<li><p>打开LoadBalancerInterceptor类，断点打入intercept方法中<br><img src="/img/java/course/107/1558059731124.png" srcset="/img/loading.gif" lazyload alt="1558059731124"></p>
</li>
<li><p>继续跟入execute方法：发现获取了9092发端口的服务<br><img src="/img/java/course/107/1558059973068.png" srcset="/img/loading.gif" lazyload alt="1558059973068"></p>
<ul>
<li>获取负载均衡器</li>
<li>使用负载均衡器从服务列表获取服务</li>
</ul>
</li>
<li><p>再跟下一次，发现获取的是9091和9092之间切换</p>
<ul>
<li><img src="/img/java/course/107/1558060049703.png" srcset="/img/loading.gif" lazyload alt="1558060049703"></li>
</ul>
</li>
<li><p>通过代码断点内容判断，果然是实现了负载均衡</p>
</li>
</ol>
<h1 id="六、熔断器-Spring-Cloud-Hystrix"><a href="#六、熔断器-Spring-Cloud-Hystrix" class="headerlink" title="六、熔断器 Spring Cloud Hystrix"></a>六、熔断器 Spring Cloud Hystrix</h1><blockquote>
<p>服务提供者如果出现故障，会不会向用户抛出异常页面，该不该抛出错误页面？</p>
</blockquote>
<h2 id="6-1-Hystrix-简介"><a href="#6-1-Hystrix-简介" class="headerlink" title="6.1 Hystrix 简介"></a>6.1 Hystrix 简介</h2><p><img src="/img/java/course/107/hystrix-logo-tagline-640.png" srcset="/img/loading.gif" lazyload alt="hystrix-logo-tagline-640"></p>
<p>Hystrix 在英文里面的意思是 豪猪，它的logo 看下面的图是一头豪猪，它在微服务系统中是一款提供保护机制的组件，和eureka一样也是由netflix公司开发。</p>
<p>主页：<a href="https://github.com/Netflix/Hystrix/" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/</a></p>
<p>Hystrix作用是什么?</p>
<p>在分布式环境中，许多服务依赖项中的部分服务必然有概率出现失败。Hystrix是一个库，通过添加延迟和容错逻辑，来帮助你控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点阻止级联失败，通过提供回退选项来实现防止级联出错。提高了系统的整体弹性。与Ribbon并列，也几乎存在于每个Spring Cloud构建的微服务和基础设施中。</p>
<p>Hystrix被设计的目标是：</p>
<ul>
<li>对通过第三方客户端库访问的依赖项（通常是通过网络）的延迟和故障进行保护和控制。</li>
<li>在复杂的分布式系统中阻止雪崩效应。</li>
<li>快速失败，快速恢复。</li>
<li>回退，尽可能优雅地降级。</li>
</ul>
<p><img src="/img/java/course/107/1564761547269.png" srcset="/img/loading.gif" lazyload alt="1564761547269"></p>
<h2 id="6-2-雪崩效应"><a href="#6-2-雪崩效应" class="headerlink" title="6.2 雪崩效应"></a>6.2 雪崩效应</h2><ul>
<li>微服务中，一个请求可能需要多个微服务接口才能实现，会形成复杂的调用链路。</li>
<li>如果某服务出现异常，请求阻塞，用户得不到响应，容器中线程不会释放，于是越来越多用户请求堆积，越来越多线程阻塞。</li>
<li>单服务器支持线程和并发数有限，请求如果一直阻塞，会导致服务器资源耗尽，从而导致所有其他服务都不可用，从而形成雪崩效应；</li>
</ul>
<p>Hystrix解决雪崩问题的手段，主要是 服务降级**(兜底)**，线程隔离；</p>
<h3 id="6-2-1-线程隔离-amp-服务降级"><a href="#6-2-1-线程隔离-amp-服务降级" class="headerlink" title="6.2.1 线程隔离 &amp; 服务降级"></a>6.2.1 线程隔离 &amp; 服务降级</h3><p>Hystrix为每个依赖服务调用分配一个小的线程池，如果线程池已满调用将被立即拒绝，默认不采用排队，加速失败判定时间。</p>
<p>用户的请求将不再直接访问服务，而是通过线程池中的空闲线程来访问服务，如果线程池已满，或者请求超时，则会进行降级处理，什么是服务降级？</p>
<p>服务降级：优先保证核心服务，而非核心服务不可用或弱可用。</p>
<p>用户的请求故障时，不会被阻塞，更不会无休止的等待或者看到系统崩溃，至少可以看到一个执行结果（例如返回友好的提示信息） 。</p>
<p>服务降级虽然会导致请求失败，但是不会导致阻塞，而且最多会影响这个依赖服务对应的线程池中的资源，对其它服务没有响应。</p>
<p>触发Hystrix服务降级的情况：</p>
<ul>
<li>线程池已满</li>
<li>请求超时</li>
</ul>
<h2 id="6-3-熔断案例"><a href="#6-3-熔断案例" class="headerlink" title="6.3 熔断案例"></a>6.3 熔断案例</h2><p><strong>目标：服务提供者的服务出现了故障，服务消费者快速失败给用户友好提示。体验服务降级</strong></p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>引入熔断的starter依赖坐标</li>
<li>开启熔断的注解@EnableCircuitBreaker</li>
<li>编写服务降级处理的方法</li>
<li>配置熔断的策略</li>
<li>模拟异常代码</li>
<li>测试熔断服务效果</li>
</ol>
<p><strong>实现过程：</strong></p>
<ol>
<li><p>引入熔断的依赖坐标：consumer_service中加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--熔断Hystrix starter--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>开启熔断的注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//注解简化写法：微服务中，注解往往引入多个，简化注解可以使用组合注解。@SpringCloudApplication 等同于 @SpringBootApplication+@EnableDiscoveryClient+@EnableCircuitBreaker</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><span class="hljs-comment">//开启服务发现</span><br><span class="hljs-meta">@EnableCircuitBreaker</span><span class="hljs-comment">//开启熔断</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><span class="hljs-comment">//开启负载均衡</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>编写服务降级处理方法：使用 <code>@HystrixCommand</code> 定义 fallback 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/&#123;id&#125;"</span>)<br><span class="hljs-meta">@HystrixCommand</span>(fallbackMethod =<span class="hljs-string">"queryByIdFallback"</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryById</span><span class="hljs-params">(@PathVariable Long id)</span></span>&#123;<br>    String url = String.format(<span class="hljs-string">"http://user-service/user/%d"</span>, id);<br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(url,String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>&#125;<br>   <br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryByIdFallback</span><span class="hljs-params">(Long id)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"对不起，网络太拥挤了！"</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>要注意；因为熔断的降级逻辑方法必须跟正常逻辑方法保证：相同的参数列表和返回值声明。<br>失败逻辑中返回User对象没有太大意义，一般会返回友好提示。所以把queryById的方法改造为返回String，反正也是Json数据。这样失败逻辑中返回一个错误说明，会比较方便。</p>
</li>
<li><p>测试<br><img src="/img/java/course/107/1558063933774.png" srcset="/img/loading.gif" lazyload alt="1558063933774"></p>
</li>
<li><p>刚才把fallback写在了某个业务方法上，如果方法很多，可以将FallBack配置加在类上，实现默认FallBack</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/consumer"</span>)<br><span class="hljs-meta">@DefaultProperties</span>(defaultFallback = <span class="hljs-string">"defaultFallback"</span>)<span class="hljs-comment">//开启默认的FallBack，统一失败降级方法(兜底)，该类中所有方法返回类型要与处理失败的方法的返回类型一致。</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"&#123;id&#125;"</span>)<br>    <span class="hljs-meta">@HystrixCommand</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryById</span><span class="hljs-params">(@PathVariable Long id)</span></span>&#123;<br>        <span class="hljs-comment">//如果参数为1抛出异常，否则 执行REST请求返回user对象</span><br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"too busy!!!"</span>);<br>        &#125;<br>        String url = String.format(<span class="hljs-string">"http://user-service/user/%d"</span>, id);<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(url,String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * queryById的降级方法</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryByIdFallback</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"对不起，网络太拥挤了！"</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 默认降级方法</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">defaultFallback</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"默认提示：对不起，网络太拥挤了！"</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>配置熔断策略，常见熔断策略配置：</p>
<ol>
<li>熔断后休眠时间：sleepWindowInMilliseconds</li>
<li>熔断触发最小请求次数：requestVolumeThreshold</li>
<li>熔断触发错误比例阈值：errorThresholdPercentage</li>
<li>熔断超时时间：timeoutInMilliseconds</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 配置熔断策略：</span><br><span class="hljs-comment"># 强制打开熔断器 默认false关闭的。测试配置是否生效</span><br><span class="hljs-attr">hystrix.command.default.circuitBreaker.forceOpen:</span> <span class="hljs-literal">false</span><br><span class="hljs-comment"># 触发熔断错误比例阈值，默认值50%</span><br><span class="hljs-attr">hystrix.command.default.circuitBreaker.errorThresholdPercentage:</span> <span class="hljs-number">20</span><br><span class="hljs-comment"># 熔断后休眠时长，默认值5秒</span><br><span class="hljs-attr">hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds:</span> <span class="hljs-number">60000</span><br><span class="hljs-comment"># 熔断触发最小请求次数，默认值是20</span><br><span class="hljs-attr">hystrix.command.default.circuitBreaker.requestVolumeThreshold:</span> <span class="hljs-number">5</span><br><span class="hljs-comment"># 熔断超时设置，默认为1秒</span><br><span class="hljs-attr">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds:</span> <span class="hljs-number">2000</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>测试熔断的情况(&#x3D;&#x3D;模拟请求超时&#x3D;&#x3D;)：</p>
<ol>
<li><p>访问超时：服务提供者线程休眠超过2秒，访问消费者触发fallback方法。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>   <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> userMapper.selectByPrimaryKey(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>服务不可用：停止user-service服务提供者。访问消费者触发fallback方法。</p>
</li>
<li><p><img src="/img/java/course/107/1558063351797.png" srcset="/img/loading.gif" lazyload alt="1558063351797"></p>
</li>
</ol>
</li>
</ol>
<h2 id="6-4-熔断原理分析"><a href="#6-4-熔断原理分析" class="headerlink" title="6.4 熔断原理分析"></a>6.4 熔断原理分析</h2><p>在服务熔断中，使用的熔断器，也叫断路器，其英文单词为：Circuit Breaker。</p>
<p>熔断机制与家里使用的电路熔断原理类似；当如果电路发生短路的时候能立刻熔断电路，避免发生灾难。在分布式系统中应用服务熔断后；服务调用方可以自己进行判断哪些服务反应慢或存在大量超时，可以针对这些服务进行主动熔断，防止整个系统被拖垮。</p>
<p>Hystrix的服务熔断机制，可以实现弹性容错；当服务请求情况好转之后，可以自动重连。通过断路的方式，将后续请求直接拒绝，一段时间（默认5秒）之后允许部分请求通过，如果调用成功则回到断路器关闭状态，否则继续打开，拒绝请求的服务。</p>
<p>熔断器状态机有3个状态：</p>
<ul>
<li>关闭状态，所有请求正常访问</li>
<li>打开状态，所有请求都会被降级。<ul>
<li>Hystrix会对请求情况计数，当一定时间失败请求百分比达到阈值，则触发熔断，断路器完全关闭</li>
<li>默认失败比例的阈值是50%，请求次数最低不少于20次</li>
</ul>
</li>
<li>半开状态<ul>
<li>打开状态不是永久的，打开一会后会进入休眠时间(默认5秒)。休眠时间过后会进入半开状态。</li>
<li>半开状态：熔断器会判断下一次请求的返回状况，如果成功，熔断器切回关闭状态。如果失败，熔断器切回打开状态。</li>
</ul>
</li>
</ul>
<p><img src="/img/java/course/107/1561680726566.png" srcset="/img/loading.gif" lazyload alt="1561680726566"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>107-SpringCloud</div>
      <div>https://flepeng.github.io/021-Java-01-course-107-SpringCloud/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lepeng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年2月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/021-Java-01-course-104-SpringBoot%E5%9F%BA%E7%A1%803-%E9%85%8D%E7%BD%AE/" title="104-SpringBoot基础3-配置">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">104-SpringBoot基础3-配置</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/021-Java-01-course-106-RabbitMQ%E9%AB%98%E7%BA%A7/" title="106-RabbitMQ高级">
                        <span class="hidden-mobile">106-RabbitMQ高级</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"flepeng/hexo-blog-comment","repo-id":"R_kgDOL0qaig","category":"Announcements","category-id":"DIC_kwDOL0qais4CfBIv","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
