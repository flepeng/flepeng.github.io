

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2488174175014870" crossorigin="anonymous"></script><!-- google 广告 -->
  <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lepeng">
  <meta name="keywords" content="">
  
    <meta name="description" content="多字节分隔符Hive中的分隔符Hive中默认使用单字节分隔符来加载文本数据，例如逗号、制表符、空格等等，默认的分隔符为\001。根据不同文件的不同分隔符，可以通过在创建表时使用 row format delimited fields terminated by ‘单字节分隔符’ 来指定文件中的分割符，确保正确将表中的每一列与文件中的每一列实现一一对应的关系。  特殊数据情况一：每一行数据的分隔符是">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive 应用案列">
<meta property="og:url" content="https://flepeng.github.io/045-Hive-24-%E6%A1%88%E4%BE%8B-Hive-%E5%BA%94%E7%94%A8%E6%A1%88%E5%88%97/index.html">
<meta property="og:site_name" content="Lepeng">
<meta property="og:description" content="多字节分隔符Hive中的分隔符Hive中默认使用单字节分隔符来加载文本数据，例如逗号、制表符、空格等等，默认的分隔符为\001。根据不同文件的不同分隔符，可以通过在创建表时使用 row format delimited fields terminated by ‘单字节分隔符’ 来指定文件中的分割符，确保正确将表中的每一列与文件中的每一列实现一一对应的关系。  特殊数据情况一：每一行数据的分隔符是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223541315.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223555988.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223611998.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223634552.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223702314.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223716318.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223729261.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223740391.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223802469.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223811975.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114211105077.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223834053.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114211321911.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223848070.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223923045.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223939747.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223952228.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224006000.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224022517.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224033397.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224046036.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224056780.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224107944.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224124584.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224142342.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224152430.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224201944.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224216134.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224228411.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224240158.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213423112.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213514117.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213527319.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213653388.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213723616.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213808120.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213831290.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213912266.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114213924878.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224259624.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214447675.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214459904.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214558885.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214659330.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214744245.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214816790.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214826353.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114214910809.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114215000062.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114215115525.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224350878.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224420611.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224431358.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114215458862.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224444747.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224457855.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224517816.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114224530257.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220003409.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220150130.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220333750.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220407806.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220522834.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220600373.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220711717.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220730880.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220923993.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114220950286.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221040025.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221125763.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221158312.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221241877.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221350344.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221547744.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221652051.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221718697.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221748307.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221926040.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221908152.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114221944404.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222036829.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222108551.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222134103.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222202952.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222244363.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222254888.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222306581.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222325013.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222351004.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222513160.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114222952774.png">
<meta property="og:image" content="https://flepeng.github.io/Images/image-20211114223041730.png">
<meta property="article:published_time" content="2025-01-23T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-03T10:25:30.407Z">
<meta property="article:author" content="Feng Lepeng">
<meta property="article:tag" content="Hive">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://flepeng.github.io/Images/image-20211114223541315.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Hive 应用案列 - Lepeng</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"flepeng.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f3d259b9efd9ce8655c180fd01bf0045","google":{"measurement_id":"G-LFTE4C7W3W"},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f3d259b9efd9ce8655c180fd01bf0045";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-LFTE4C7W3W", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'G-LFTE4C7W3W');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lepeng 的 blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Hive 应用案列"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-24 00:00" pubdate>
          2025年1月24日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          90 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Hive 应用案列</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="多字节分隔符"><a href="#多字节分隔符" class="headerlink" title="多字节分隔符"></a>多字节分隔符</h2><h3 id="Hive中的分隔符"><a href="#Hive中的分隔符" class="headerlink" title="Hive中的分隔符"></a>Hive中的分隔符</h3><p>Hive中默认使用<strong>单字节分隔符</strong>来加载文本数据，例如逗号、制表符、空格等等，默认的分隔符为\001。根据不同文件的不同分隔符，可以通过在创建表时使用 <strong>row format delimited fields terminated by ‘单字节分隔符’</strong> 来指定文件中的分割符，确保正确将表中的每一列与文件中的每一列实现一一对应的关系。</p>
<p><img src="/Images/image-20211114223541315.png" srcset="/img/loading.gif" lazyload alt="image-20211114223541315"></p>
<h3 id="特殊数据"><a href="#特殊数据" class="headerlink" title="特殊数据"></a>特殊数据</h3><p><strong>情况一：每一行数据的分隔符是多字节分隔符，例如：”||”、“–”等</strong></p>
<p><img src="/Images/image-20211114223555988.png" srcset="/img/loading.gif" lazyload alt="image-20211114223555988"></p>
<p><strong>上图中每列的分隔符为||，为多字节分隔符</strong></p>
<p><strong>情况二：数据的字段中包含了分隔符</strong></p>
<p><img src="/Images/image-20211114223611998.png" srcset="/img/loading.gif" lazyload alt="image-20211114223611998"></p>
<p>上图中每列的分隔符为空格，但是数据中包含了分割符，<strong>时间字段中也有空格</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">192.168.88.134 [08/Nov/2020:10:44:32 +0800] "GET / HTTP/1.1" 404 951<br></code></pre></td></tr></table></figure>


<h2 id="问题与需求"><a href="#问题与需求" class="headerlink" title="问题与需求"></a>问题与需求</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>基于上述的两种特殊数据，我们如果使用正常的加载数据的方式将数据加载到表中，就会出以下两种错误：</p>
<p><strong>情况一：加载数据的分隔符为多字节分隔符</strong></p>
<p>创建表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表已存在就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> singer;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> singer(<br> <span class="hljs-keyword">id</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手id</span><br> <span class="hljs-keyword">name</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手名称</span><br> country <span class="hljs-keyword">string</span>,<span class="hljs-comment">--国家</span><br> province <span class="hljs-keyword">string</span>,<span class="hljs-comment">--省份</span><br> gender <span class="hljs-keyword">string</span>,<span class="hljs-comment">--性别</span><br> works <span class="hljs-keyword">string</span><span class="hljs-comment">--作品</span><br>)<br><span class="hljs-comment">--指定列的分隔符为||</span><br><span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'||'</span>;<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/test01.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> singer;<br></code></pre></td></tr></table></figure>

<p>查看结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> singer;<br></code></pre></td></tr></table></figure>

<p>问题:数据发生了错位，没有正确的加载每一列的数据</p>
<p>原因:Hive中默认只支持单字节分隔符，无法识别多字节分隔符</p>
<p><strong>情况二：数据中包含了分隔符</strong></p>
<p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表存在，就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> apachelog;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> apachelog(<br> ip <span class="hljs-keyword">string</span>,      <span class="hljs-comment">--IP地址</span><br> stime <span class="hljs-keyword">string</span>,    <span class="hljs-comment">--时间</span><br> mothed <span class="hljs-keyword">string</span>,  <span class="hljs-comment">--请求方式</span><br> <span class="hljs-keyword">url</span> <span class="hljs-keyword">string</span>,     <span class="hljs-comment">--请求地址</span><br> <span class="hljs-keyword">policy</span> <span class="hljs-keyword">string</span>,  <span class="hljs-comment">--请求协议</span><br> stat <span class="hljs-keyword">string</span>,    <span class="hljs-comment">--请求状态</span><br> <span class="hljs-keyword">body</span> <span class="hljs-keyword">string</span>     <span class="hljs-comment">--字节大小</span><br>)<br><span class="hljs-comment">--指定列的分隔符为空格</span><br><span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">' '</span>;<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/apache_web_access.log'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> apachelog;<br></code></pre></td></tr></table></figure>

<p>查看结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> apachelog;<br></code></pre></td></tr></table></figure>

<p>问题:时间字段被切分成了两个字段，后面所有的字段出现了错位</p>
<p>原因:时间数据中包含了分隔符，导致Hive认为这是两个字段，但实际业务需求中，为一个字段</p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>基于上面两种情况的测试发现，当数据中出现了多字节分隔符或者数据中的某个字段包含了分隔符，就会导致数据加载错位的问题。基于出现的问题，我们需要通过特殊的方法来解决该问题，即使当数据中出现多字节分隔符等情况时，Hive也能正确的加载数据，实现列与数据的一一对应。</p>
<h3 id="解决方案一：替换分隔符"><a href="#解决方案一：替换分隔符" class="headerlink" title="解决方案一：替换分隔符"></a>解决方案一：替换分隔符</h3><h4 id="方案概述"><a href="#方案概述" class="headerlink" title="方案概述"></a>方案概述</h4><p>面对情况一，如果数据中的分隔符是多字节分隔符，可以使用程序提前将数据中的多字节分隔符替换为单字节分隔符，然后使用Hive加载，就可以实现正确加载对应的数据。</p>
<p>例如：原始数据中的分隔符为“||”</p>
<p><img src="/Images/image-20211114223634552.png" srcset="/img/loading.gif" lazyload alt="image-20211114223634552"></p>
<h4 id="程序开发"><a href="#程序开发" class="headerlink" title="程序开发"></a>程序开发</h4><p><strong>可以在ETL阶段通过一个MapReduce程序，将“||”替换为单字节的分隔符“|”，示例程序如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.hadoop.conf.Configuration;<br><span class="hljs-keyword">import</span> org.apache.hadoop.conf.Configured;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.Path;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.LongWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.NullWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.Text;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.Job;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.Mapper;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;<br><span class="hljs-keyword">import</span> org.apache.hadoop.util.Tool;<br><span class="hljs-keyword">import</span> org.apache.hadoop.util.ToolRunner;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ChangeSplitCharMR</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO MapReduce实现将多字节分隔符转换为单字节符</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Create</span> By  itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChangeSplitCharMR</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Configured</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Tool</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">run</span><span class="hljs-params">(String[] arg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 构建Job</span><br><span class="hljs-comment">         */</span><br>        Job job = Job.getInstance(<span class="hljs-keyword">this</span>.getConf(),<span class="hljs-string">"changeSplit"</span>);<br>        job.setJarByClass(ChangeSplitCharMR<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 配置Job</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//input：读取需要转换的文件</span><br>        job.setInputFormatClass(TextInputFormat<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        Path inputPath = <span class="hljs-keyword">new</span> Path(<span class="hljs-string">"datas/split/test01.txt"</span>);<br>        FileInputFormat.setInputPaths(job,inputPath);<br><br>        <span class="hljs-comment">//map：调用Mapper</span><br>        job.setMapperClass(ChangeSplitMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setMapOutputKeyClass(Text<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setMapOutputValueClass(NullWritable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        <span class="hljs-comment">//reduce：不需要Reduce过程</span><br>        job.setNumReduceTasks(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//output</span><br>        job.setOutputFormatClass(TextOutputFormat<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        Path outputPath = <span class="hljs-keyword">new</span> Path(<span class="hljs-string">"datas/output/changeSplit"</span>);<br>        TextOutputFormat.setOutputPath(job,outputPath);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 提交Job</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">return</span> job.waitForCompletion(<span class="hljs-keyword">true</span>) ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//程序入口</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//调用run</span><br>        Configuration conf = <span class="hljs-keyword">new</span> Configuration();<br>        <span class="hljs-keyword">int</span> status = ToolRunner.run(conf, <span class="hljs-keyword">new</span> ChangeSplitCharMR(), args);<br>        System.exit(status);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChangeSplitMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">LongWritable</span>,<span class="hljs-title">Text</span>,<span class="hljs-title">Text</span>,<span class="hljs-title">NullWritable</span>&gt;</span>&#123;<br>        <span class="hljs-comment">//定义输出的Key</span><br>        <span class="hljs-keyword">private</span> Text outputKey = <span class="hljs-keyword">new</span> Text();<br>        <span class="hljs-comment">//定义输出的Value</span><br>        <span class="hljs-keyword">private</span> NullWritable outputValue = NullWritable.get();<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map</span><span class="hljs-params">(LongWritable key, Text value, Context context)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException </span>&#123;<br>            <span class="hljs-comment">//获取每条数据</span><br>            String line = value.toString();<br>            <span class="hljs-comment">//将里面的||转换为|</span><br>            String newLine = line.replaceAll(<span class="hljs-string">"\\|\\|"</span>, <span class="hljs-string">"|"</span>);<br>            <span class="hljs-comment">//替换后的内容作为Key</span><br>            <span class="hljs-keyword">this</span>.outputKey.set(newLine);<br>            <span class="hljs-comment">//输出结果</span><br>            context.write(<span class="hljs-keyword">this</span>.outputKey,<span class="hljs-keyword">this</span>.outputValue);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>程序执行结果如下：</strong></p>
<p><img src="/Images/image-20211114223702314.png" srcset="/img/loading.gif" lazyload alt="image-20211114223702314"></p>
<h4 id="重新建表加载数据"><a href="#重新建表加载数据" class="headerlink" title="重新建表加载数据"></a>重新建表加载数据</h4><p>重新创建Hive表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表已存在就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> singer;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> singer(<br> <span class="hljs-keyword">id</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手id</span><br> <span class="hljs-keyword">name</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手名称</span><br> country <span class="hljs-keyword">string</span>,<span class="hljs-comment">--国家</span><br> province <span class="hljs-keyword">string</span>,<span class="hljs-comment">--省份</span><br> gender <span class="hljs-keyword">string</span>,<span class="hljs-comment">--性别</span><br> works <span class="hljs-keyword">string</span><span class="hljs-comment">--作品</span><br>)<br><span class="hljs-comment">--指定列的分隔符为||</span><br><span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'|'</span>;<br></code></pre></td></tr></table></figure>

<p>在Hive中重新加载数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/part-m-00000'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> singer;<br></code></pre></td></tr></table></figure>

<p>查看结果:</p>
<p><img src="/Images/image-20211114223716318.png" srcset="/img/loading.gif" lazyload alt="image-20211114223716318"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>在ETL阶段可以直接对数据进行分隔符的替换，通过替换分隔符将多字节分隔符更改为单字节分隔符，就可以解决数据加载的问题，但是这种方式有对应的优缺点，并不是所有的场景适用于该方法。</p>
<p><strong>优点</strong>：实现方式较为简单，基于字符串替换即可</p>
<p><strong>缺点</strong>：无法满足情况2的需求</p>
<h3 id="解决方案二：RegexSerDe正则加载"><a href="#解决方案二：RegexSerDe正则加载" class="headerlink" title="解决方案二：RegexSerDe正则加载"></a>解决方案二：RegexSerDe正则加载</h3><h4 id="方案概述-1"><a href="#方案概述-1" class="headerlink" title="方案概述"></a>方案概述</h4><p>面对情况一和情况二的问题，Hive中提供了一种特殊的方式来解决，Hive提供了一种特殊的Serde来加载特殊数据的问题，使用正则匹配来加载数据，匹配每一列的数据。</p>
<p>官网地址：<a href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted%23GettingStarted-ApacheWeblogData" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/GettingStarted#GettingStarted-ApacheWeblogData</a></p>
<p><img src="/Images/image-20211114223729261.png" srcset="/img/loading.gif" lazyload alt="image-20211114223729261"></p>
<h4 id="什么是SerDe"><a href="#什么是SerDe" class="headerlink" title="什么是SerDe?"></a>什么是SerDe?</h4><p><strong>Hive的SerDe提供了序列化和反序列化两个功能</strong>，SerDe是英文Serialize和Deserilize的组合缩写，用于实现将Hive中的对象进行序列化和将数据进行反序列化。</p>
<p><strong>Serialize就是序列化</strong>，用于将Hive中使用的java object转换成能写入hdfs的字节序列，或者其他系统能识别的流文件。Hive中的insert语句用于将数据写入HDFS，所以就会调用序列化实现。Hive中的调用过程如下：</p>
<p><img src="/Images/image-20211114223740391.png" srcset="/img/loading.gif" lazyload alt="image-20211114223740391"></p>
<p><strong>Deserilize就是反序列化</strong>，用于将字符串或者二进制数据流转换成Hive能识别的java object对象。所有Hive中的Select语句在查询数据时，需要将HDFS中的数据解析为Hive中对象，就需要进行反序列化。Hive可以方便的将数据加载到表中而不需要对数据进行转换，这样在处理海量数据时可以节省大量的时间。Hive中的调用过程如下：</p>
<p><img src="/Images/image-20211114223802469.png" srcset="/img/loading.gif" lazyload alt="image-20211114223802469"></p>
<h4 id="Hive中包含的SerDe"><a href="#Hive中包含的SerDe" class="headerlink" title="Hive中包含的SerDe"></a>Hive中包含的SerDe</h4><p>官网地址：<a href="https://cwiki.apache.org/confluence/display/Hive/SerDe" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/SerDe</a></p>
<p><img src="/Images/image-20211114223811975.png" srcset="/img/loading.gif" lazyload alt="image-20211114223811975"></p>
<p>Hive中默认提供了多种SerDe用于解析和加载不同类型的数据文件，常用的有<strong>ORCSerde 、RegexSerde、JsonSerDe</strong>等。</p>
<h4 id="RegexSerDe的功能"><a href="#RegexSerDe的功能" class="headerlink" title="RegexSerDe的功能"></a>RegexSerDe的功能</h4><p>RegexSerde是Hive中专门为了满足复杂数据场景所提供的正则加载和解析数据的接口，使用RegexSerde可以指定正则表达式加载数据，根据正则表达式匹配每一列数据。上述过程中遇到的情况一和情况二的问题，都可以通过RegexSerDe使用正则表达式来加载实现。</p>
<h4 id="RegexSerDe解决多字节分隔符"><a href="#RegexSerDe解决多字节分隔符" class="headerlink" title="RegexSerDe解决多字节分隔符"></a>RegexSerDe解决多字节分隔符</h4><p>分析数据格式，构建正则表达式:</p>
<p>原始数据格式:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">01||周杰伦||中国||台湾||男||七里香<br></code></pre></td></tr></table></figure>

<p>正则表达式定义每一列:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">([0-9]*)\\|\\|(.*)\\|\\|(.*)\\|\\|(.*)\\|\\|(.*)\\|\\|(.*)<br></code></pre></td></tr></table></figure>

<p>正则校验:</p>
<p><img src="/Images/image-20211114211105077.png" srcset="/img/loading.gif" lazyload alt="image-20211114211105077"></p>
<p>基于正则表达式，使用RegexSerde建表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表已存在就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> singer;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> singer(<br> <span class="hljs-keyword">id</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手id</span><br> <span class="hljs-keyword">name</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手名称</span><br> country <span class="hljs-keyword">string</span>,<span class="hljs-comment">--国家</span><br> province <span class="hljs-keyword">string</span>,<span class="hljs-comment">--省份</span><br> gender <span class="hljs-keyword">string</span>,<span class="hljs-comment">--性别</span><br> works <span class="hljs-keyword">string</span><span class="hljs-comment">--作品</span><br>)<br><span class="hljs-comment">--指定使用RegexSerde加载数据</span><br><span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> SERDE <span class="hljs-string">'org.apache.hadoop.hive.serde2.RegexSerDe'</span><br><span class="hljs-comment">--指定正则表达式</span><br><span class="hljs-keyword">WITH</span> SERDEPROPERTIES (<br>  <span class="hljs-string">"input.regex"</span> = <span class="hljs-string">"([0-9]*)\\|\\|([^&#125;]*)\\|\\|([^&#125;]*)\\|\\|([^&#125;]*)\\|\\|([^&#125;]*)\\|\\|([^&#125;]*)"</span><br>);<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/test01.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> singer;<br></code></pre></td></tr></table></figure>

<p>查看数据结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> singer;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114223834053.png" srcset="/img/loading.gif" lazyload alt="image-20211114223834053"></p>
<p><strong>每一列的数据都被正常的加载，没有错位</strong></p>
<h4 id="RegexSerDe解决数据中包含分割符"><a href="#RegexSerDe解决数据中包含分割符" class="headerlink" title="RegexSerDe解决数据中包含分割符"></a>RegexSerDe解决数据中包含分割符</h4><p>分析数据格式，构建正则表达式:</p>
<p>原始数据格式:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">192.168.88.100 [08/Nov/2020:10:44:33 +0800] "GET /hpsk_sdk/index.html HTTP/1.1" 200 328<br></code></pre></td></tr></table></figure>

<p>正则表达式定义每一列:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">([^ ]*) ([^&#125;]*) ([^ ]*) ([^ ]*) ([^ ]*) ([0-9]*) ([^ ]*)<br></code></pre></td></tr></table></figure>

<p>正则校验:</p>
<p><img src="/Images/image-20211114211321911.png" srcset="/img/loading.gif" lazyload alt="image-20211114211321911"></p>
<p>基于正则表达式，使用RegexSerde建表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表存在，就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> apachelog;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> apachelog(<br> ip <span class="hljs-keyword">string</span>,      <span class="hljs-comment">--IP地址</span><br> stime <span class="hljs-keyword">string</span>,    <span class="hljs-comment">--时间</span><br> mothed <span class="hljs-keyword">string</span>,  <span class="hljs-comment">--请求方式</span><br> <span class="hljs-keyword">url</span> <span class="hljs-keyword">string</span>,     <span class="hljs-comment">--请求地址</span><br> <span class="hljs-keyword">policy</span> <span class="hljs-keyword">string</span>,  <span class="hljs-comment">--请求协议</span><br> stat <span class="hljs-keyword">string</span>,    <span class="hljs-comment">--请求状态</span><br> <span class="hljs-keyword">body</span> <span class="hljs-keyword">string</span>     <span class="hljs-comment">--字节大小</span><br>)<br><span class="hljs-comment">--指定使用RegexSerde加载数据</span><br><span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> SERDE <span class="hljs-string">'org.apache.hadoop.hive.serde2.RegexSerDe'</span><br><span class="hljs-comment">--指定正则表达式</span><br><span class="hljs-keyword">WITH</span> SERDEPROPERTIES (<br>  <span class="hljs-string">"input.regex"</span> = <span class="hljs-string">"([^ ]*) ([^&#125;]*) ([^ ]*) ([^ ]*) ([^ ]*) ([0-9]*) ([^ ]*)"</span><br>);<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/apache_web_access.log'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> apachelog;<br></code></pre></td></tr></table></figure>

<p>查看数据结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> ip,stime,<span class="hljs-keyword">url</span>,stat,<span class="hljs-keyword">body</span> <span class="hljs-keyword">from</span> apachelog;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114223848070.png" srcset="/img/loading.gif" lazyload alt="image-20211114223848070"></p>
<p>时间字段不再被分割为两个字段，整体作为一个字段被加载</p>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>RegexSerde使用简单，对于各种复杂的数据场景，都可以通过正则定义匹配每行中的每个字段，基本上可以满足大多数场景的需求，工作中推荐使用该方式来实现对于复杂数据的加载。</p>
<h3 id="解决方案三：自定义InputFormat"><a href="#解决方案三：自定义InputFormat" class="headerlink" title="解决方案三：自定义InputFormat"></a>解决方案三：自定义InputFormat</h3><h4 id="方案概述-2"><a href="#方案概述-2" class="headerlink" title="方案概述"></a>方案概述</h4><p>Hive中也允许使用自定义InputFormat来解决以上问题，通过在自定义InputFormat，来自定义解析逻辑实现读取每一行的数据。</p>
<h4 id="自定义InputFormat"><a href="#自定义InputFormat" class="headerlink" title="自定义InputFormat"></a>自定义InputFormat</h4><p>自定义InputFormat继承自TextInputFormat，读取数据时将每条数据中的”||”全部替换成“|”</p>
<p>自定义InputFormat：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.hadoop.io.LongWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.Text;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapred.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> UserInputFormat</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO 用于实现自定义InputFormat，读取每行数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Create</span> By     Itcast</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInputFormat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TextInputFormat</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RecordReader&lt;LongWritable, Text&gt; <span class="hljs-title">getRecordReader</span><span class="hljs-params">(InputSplit genericSplit, JobConf job,Reporter reporter)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        reporter.setStatus(genericSplit.toString());<br>        UserRecordReader reader = <span class="hljs-keyword">new</span> UserRecordReader(job,(FileSplit)genericSplit);<br>        <span class="hljs-keyword">return</span> reader;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="自定义RecordReader"><a href="#自定义RecordReader" class="headerlink" title="自定义RecordReader"></a>自定义RecordReader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.logging.Log;<br><span class="hljs-keyword">import</span> org.apache.commons.logging.LogFactory;<br><span class="hljs-keyword">import</span> org.apache.hadoop.conf.Configuration;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.FSDataInputStream;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.FileSystem;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.Path;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.Seekable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.LongWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.Text;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.compress.*;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapred.FileSplit;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapred.LineRecordReader;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapred.RecordReader;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> UserRecordReader</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO 用于自定义读取器，在自定义InputFormat中使用，将读取到的每行数据中的||替换为|</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Create</span> By     Itcast</span><br><span class="hljs-comment"> */</span><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRecordReader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordReader</span>&lt;<span class="hljs-title">LongWritable</span>, <span class="hljs-title">Text</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Log LOG = LogFactory.getLog(LineRecordReader<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;<br>    <span class="hljs-keyword">int</span> maxLineLength;<br>    <span class="hljs-keyword">private</span> CompressionCodecFactory compressionCodecs = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> start;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> pos;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> end;<br>    <span class="hljs-keyword">private</span> LineReader in;<br>    <span class="hljs-keyword">private</span> Seekable filePosition;<br>    <span class="hljs-keyword">private</span> CompressionCodec codec;<br>    <span class="hljs-keyword">private</span> Decompressor decompressor;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserRecordReader</span><span class="hljs-params">(Configuration job, FileSplit split)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">this</span>.maxLineLength = job.getInt(<span class="hljs-string">"mapred.linerecordreader.maxlength"</span>, Integer.MAX_VALUE);<br>        start = split.getStart();<br>        end = start + split.getLength();<br>        <span class="hljs-keyword">final</span> Path file = split.getPath();<br>        compressionCodecs = <span class="hljs-keyword">new</span> CompressionCodecFactory(job);<br>        codec = compressionCodecs.getCodec(file);<br>        FileSystem fs = file.getFileSystem(job);<br>        FSDataInputStream fileIn = fs.open(split.getPath());<br>        <span class="hljs-keyword">if</span> (isCompressedInput()) &#123;<br>            decompressor = CodecPool.getDecompressor(codec);<br>            <span class="hljs-keyword">if</span> (codec <span class="hljs-keyword">instanceof</span> SplittableCompressionCodec) &#123;<br>                <span class="hljs-keyword">final</span> SplitCompressionInputStream cIn = ((SplittableCompressionCodec) codec)<br>                        .createInputStream(fileIn, decompressor, start, end,<br>                                SplittableCompressionCodec.READ_MODE.BYBLOCK);<br>                in = <span class="hljs-keyword">new</span> LineReader(cIn, job);<br>                start = cIn.getAdjustedStart();<br>                end = cIn.getAdjustedEnd();<br>                filePosition = cIn; <span class="hljs-comment">// take pos from compressed stream</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                in = <span class="hljs-keyword">new</span> LineReader(codec.createInputStream(fileIn, decompressor), job);<br>                filePosition = fileIn;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            fileIn.seek(start);<br>            in = <span class="hljs-keyword">new</span> LineReader(fileIn, job);<br>            filePosition = fileIn;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (start != <span class="hljs-number">0</span>) &#123;<br>            start += in.readLine(<span class="hljs-keyword">new</span> Text(), <span class="hljs-number">0</span>, maxBytesToConsume(start));<br>        &#125;<br>        <span class="hljs-keyword">this</span>.pos = start;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCompressedInput</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (codec != <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">maxBytesToConsume</span><span class="hljs-params">(<span class="hljs-keyword">long</span> pos)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> isCompressedInput() ? Integer.MAX_VALUE : (<span class="hljs-keyword">int</span>) Math.min(Integer.MAX_VALUE, end - pos);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getFilePosition</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">long</span> retVal;<br>        <span class="hljs-keyword">if</span> (isCompressedInput() &amp;&amp; <span class="hljs-keyword">null</span> != filePosition) &#123;<br>            retVal = filePosition.getPos();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            retVal = pos;<br>        &#125;<br>        <span class="hljs-keyword">return</span> retVal;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> LongWritable <span class="hljs-title">createKey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LongWritable();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Text <span class="hljs-title">createValue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Text();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Read a line.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">next</span><span class="hljs-params">(LongWritable key, Text value)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">while</span> (getFilePosition() &lt;= end) &#123;<br>            key.set(pos);<br>            <span class="hljs-keyword">int</span> newSize = in.readLine(value, maxLineLength, Math.max(maxBytesToConsume(pos), maxLineLength));<br>            String str = value.toString().replaceAll(<span class="hljs-string">"\\|\\|"</span>, <span class="hljs-string">"\\|"</span>);<br>            value.set(str);<br>            pos += newSize;<br>            <span class="hljs-keyword">if</span> (newSize == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (newSize &lt; maxLineLength) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>            LOG.info(<span class="hljs-string">"Skipped line of size "</span> + newSize + <span class="hljs-string">" at pos "</span> + (pos - newSize));<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> <span class="hljs-title">getProgress</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">if</span> (start == end) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0f</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> Math.min(<span class="hljs-number">1.0f</span>, (getFilePosition() - start) / (<span class="hljs-keyword">float</span>) (end - start));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getPos</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">return</span> pos;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-keyword">null</span>) &#123;<br>                in.close();<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (decompressor != <span class="hljs-keyword">null</span>) &#123;<br>                CodecPool.returnDecompressor(decompressor);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LineReader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">hadoop</span>.<span class="hljs-title">util</span>.<span class="hljs-title">LineReader</span> </span>&#123;<br>        LineReader(InputStream in) &#123;<br>            <span class="hljs-keyword">super</span>(in);<br>        &#125;<br><br>        LineReader(InputStream in, <span class="hljs-keyword">int</span> bufferSize) &#123;<br>            <span class="hljs-keyword">super</span>(in, bufferSize);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LineReader</span><span class="hljs-params">(InputStream in, Configuration conf)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>            <span class="hljs-keyword">super</span>(in, conf);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="基于自定义Input创建表"><a href="#基于自定义Input创建表" class="headerlink" title="基于自定义Input创建表"></a>基于自定义Input创建表</h4><p>将开发好的InputFormat打成jar包，放入Hive的lib目录中</p>
<p><img src="/Images/image-20211114223923045.png" srcset="/img/loading.gif" lazyload alt="image-20211114223923045"></p>
<p>在Hive中，将jar包添加到环境变量中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">add jar /export/server/hive-3.1.2-bin/lib/HiveUserInputFormat.jar;<br></code></pre></td></tr></table></figure>

<p>该方法可以实现临时添加，如果希望永久生效，重启Hive即可</p>
<p>创建表，指定自定义的InputFormat读取数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--如果表已存在就删除表</span><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> singer;<br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> singer(<br> <span class="hljs-keyword">id</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手id</span><br> <span class="hljs-keyword">name</span> <span class="hljs-keyword">string</span>,<span class="hljs-comment">--歌手名称</span><br> country <span class="hljs-keyword">string</span>,<span class="hljs-comment">--国家</span><br> province <span class="hljs-keyword">string</span>,<span class="hljs-comment">--省份</span><br> gender <span class="hljs-keyword">string</span>,<span class="hljs-comment">--性别</span><br> works <span class="hljs-keyword">string</span><span class="hljs-comment">--作品</span><br>)<br><span class="hljs-comment">--指定使用分隔符为|</span><br><span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'|'</span><br><span class="hljs-keyword">stored</span> <span class="hljs-keyword">as</span> <br><span class="hljs-comment">--指定使用自定义的类实现解析</span><br>inputformat <span class="hljs-string">'bigdata.itcast.cn.hive.mr.UserInputFormat'</span> <br>outputformat <span class="hljs-string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>;<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/test01.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> singer;<br></code></pre></td></tr></table></figure>

<p>查看结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> singer;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114223939747.png" srcset="/img/loading.gif" lazyload alt="image-20211114223939747"></p>
<p>数据正常匹配，没有出现错位。</p>
<h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><p>当数据文件中出现多字节分隔符或者数据中包含了分隔符时，会导致数据加载与实际表的字段不匹配的问题，基于这个问题提供了三种方案：替换分隔符、正则加载及自定义InputFormat来实现，其中替换分隔符无法解决数据中存在分隔符的问题，自定义InputFormat的开发成本较高，所以整体推荐使用正则加载的方式来实现对于特殊数据的处理。</p>
<h2 id="URL解析函数及侧视图"><a href="#URL解析函数及侧视图" class="headerlink" title="URL解析函数及侧视图"></a>URL解析函数及侧视图</h2><h3 id="URL的基本组成"><a href="#URL的基本组成" class="headerlink" title="URL的基本组成"></a>URL的基本组成</h3><p>在对URL进行解析时，先了解URL的基本组成部分，再根据实际的需求从URL中获取对应的部分，例如一条URL由以下几个部分组成：</p>
<p><img src="/Images/image-20211114223952228.png" srcset="/img/loading.gif" lazyload alt="image-20211114223952228"></p>
<p><strong>PROTOCOL：协议类型</strong></p>
<p>通信协议类型，一般也叫作Schema，常见的有http、https等；</p>
<p><strong>HOST：域名</strong></p>
<p>一般为服务器的域名主机名或ip地址</p>
<p><strong>PATH：访问路径</strong></p>
<p>访问路径目录，由“&#x2F;”隔开的字符串，表示的是主机上的目录或文件地址</p>
<p><strong>QUERY：参数数据</strong></p>
<p>查询参数，此项为可选项，可以给动态网页传递参数，用“&amp;”隔开，每个参数的名和值用“&#x3D;”隔开</p>
<h3 id="Hive中的URL解析函数"><a href="#Hive中的URL解析函数" class="headerlink" title="Hive中的URL解析函数"></a>Hive中的URL解析函数</h3><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>Hive中为了实现对URL的解析，专门提供了解析URL的函数<strong>parse_url</strong>和<strong>parse_url_tuple</strong>，在<strong>show functions</strong>中可以看到对应函数</p>
<p><img src="/Images/image-20211114224006000.png" srcset="/img/loading.gif" lazyload alt="image-20211114224006000"></p>
<p>准备数据:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /<span class="hljs-built_in">export</span>/data/url.txt<br></code></pre></td></tr></table></figure>

<p>添加以下数据内容:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">1	http://facebook.com/path/p1.php?query=1<br>2	http://tongji.baidu.com/news/index.jsp?uuid=frank<br>3	http://www.jdwz.com/index?source=baidu<br>4	http://www.itcast.cn/index?source=alibaba<br></code></pre></td></tr></table></figure>

<p>创建数据库:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*创建数据库*/</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> db_function;<br><span class="hljs-comment">/*切换数据库*/</span><br><span class="hljs-keyword">use</span> db_function;<br></code></pre></td></tr></table></figure>

<p>创建表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*创建数据表*/</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_url(<br>   <span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span>,<br>   <span class="hljs-keyword">url</span> <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>加载数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*加载数据*/</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/url.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_url;<br></code></pre></td></tr></table></figure>

<p>查看数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*查询数据*/</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224022517.png" srcset="/img/loading.gif" lazyload alt="image-20211114224022517"></p>
<h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><p>基于当前的数据，实现对URL进行分析，从URL中获取每个ID对应HOST、PATH以及QUERY，最终实现效果如下：</p>
<p><img src="/Images/image-20211114224033397.png" srcset="/img/loading.gif" lazyload alt="image-20211114224033397"></p>
<h3 id="parse-url"><a href="#parse-url" class="headerlink" title="parse_url"></a>parse_url</h3><p>功能:</p>
<p>parse_url函数是Hive中提供的最基本的url解析函数，可以根据指定的参数，从URL解析出对应的参数值进行返回，函数为普通的一对一函数类型。</p>
<p>语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">parse_url(url, partToExtract[, key]) - extracts a part from a URL<br>  Parts: HOST, PATH, QUERY, REF, PROTOCOL, AUTHORITY, FILE, USERINFO key<br></code></pre></td></tr></table></figure>

<p>parse_url在使用时需要指定两个参数</p>
<p>第一个参数：url：指定要解析的URL</p>
<p>第二个参数：key：指定要解析的内容</p>
<p>示例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> parse_url(<span class="hljs-string">'http://facebook.com/path/p1.php?query=1'</span>, <span class="hljs-string">'HOST'</span>) <span class="hljs-keyword">FROM</span> src <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;<br>'facebook.com'<br><br><span class="hljs-keyword">SELECT</span> parse_url(<span class="hljs-string">'http://facebook.com/path/p1.php?query=1'</span>, <span class="hljs-string">'QUERY'</span>) <span class="hljs-keyword">FROM</span> src <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;<br>'query=1'<br><br><span class="hljs-keyword">SELECT</span> parse_url(<span class="hljs-string">'http://facebook.com/path/p1.php?query=1'</span>, <span class="hljs-string">'QUERY'</span>, <span class="hljs-string">'query'</span>) <span class="hljs-keyword">FROM</span> src <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;<br>'1'<br></code></pre></td></tr></table></figure>

<p>测试:</p>
<p>查询tb_url中每个url的HOST:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>,<span class="hljs-keyword">url</span>,parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>) <span class="hljs-keyword">as</span> host <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224046036.png" srcset="/img/loading.gif" lazyload alt="image-20211114224046036"></p>
<p>查询tb_url中每个url的PATH:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>,<span class="hljs-keyword">url</span>,parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"PATH"</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224056780.png" srcset="/img/loading.gif" lazyload alt="image-20211114224056780"></p>
<p>查询tb_url中每个url的QUERY:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>,<span class="hljs-keyword">url</span>,parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"QUERY"</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224107944.png" srcset="/img/loading.gif" lazyload alt="image-20211114224107944"></p>
<p>实现需求:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>   <span class="hljs-keyword">id</span>,<br>   parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>) <span class="hljs-keyword">as</span> host,<br>   parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"PATH"</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">path</span>,<br>   parse_url(<span class="hljs-keyword">url</span>,<span class="hljs-string">"QUERY"</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">query</span><br><span class="hljs-keyword">from</span><br>  tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224124584.png" srcset="/img/loading.gif" lazyload alt="image-20211114224124584"></p>
<h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h3><p>使用parse_url函数每次只能解析一个参数，导致需要经过多个函数调用才能构建多列，开发角度较为麻烦，实现过程性能也相对较差，需要对同一列做多次计算处理，我们希望能实现调用一次函数，就可以将多个参数进行解析，得到多列结果。</p>
<h3 id="parse-url-tuple"><a href="#parse-url-tuple" class="headerlink" title="parse_url_tuple"></a>parse_url_tuple</h3><p>功能:</p>
<p>parse_url_tuple函数是Hive中提供的基于parse_url的url解析函数，可以通过一次指定多个参数，从URL解析出多个参数的值进行返回多列，函数为特殊的一对多函数类型，即通常所说的UDTF函数类型。</p>
<p>语法:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">parse_url_tuple(url, partname1, partname2, ..., partnameN) - extracts N (N&gt;=1) parts from a URL.<br>It takes a URL and one or multiple partnames, and returns a tuple. All the input parameters and output column types are string.<br>Partname: HOST, PATH, QUERY, REF, PROTOCOL, AUTHORITY, FILE, USERINFO, QUERY:&lt;KEY_NAME&gt;<br></code></pre></td></tr></table></figure>

<p>parse_url在使用时可以指定多个参数</p>
<p>第一个参数：url：指定要解析的URL</p>
<p>第二个参数：key1：指定要解析的内容1</p>
<p>……</p>
<p>第N个参数：keyN：指定要解析的内容N</p>
<p>示例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> b.* <span class="hljs-keyword">FROM</span> src <span class="hljs-keyword">LATERAL</span> <span class="hljs-keyword">VIEW</span> parse_url_tuple(fullurl, <span class="hljs-string">'HOST'</span>, <span class="hljs-string">'PATH'</span>, <span class="hljs-string">'QUERY'</span>, <span class="hljs-string">'QUERY:id'</span>) b <span class="hljs-keyword">as</span> host, <span class="hljs-keyword">path</span>, <span class="hljs-keyword">query</span>, query_id <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">SELECT</span> parse_url_tuple(a.fullurl, <span class="hljs-string">'HOST'</span>, <span class="hljs-string">'PATH'</span>, <span class="hljs-string">'QUERY'</span>, <span class="hljs-string">'REF'</span>, <span class="hljs-string">'PROTOCOL'</span>, <span class="hljs-string">'FILE'</span>,  <span class="hljs-string">'AUTHORITY'</span>, <span class="hljs-string">'USERINFO'</span>, <span class="hljs-string">'QUERY:k1'</span>) <span class="hljs-keyword">as</span> (ho, pa, qu, re, pr, fi, au, us, qk1) <span class="hljs-keyword">from</span> src a;<br></code></pre></td></tr></table></figure>

<p>测试:</p>
<p>查询tb_url中每个url的HOST、PATH:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>) <span class="hljs-keyword">as</span> (host,<span class="hljs-keyword">path</span>) <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224142342.png" srcset="/img/loading.gif" lazyload alt="image-20211114224142342"></p>
<p>查询tb_url中每个url的PROTOCOL、HOST、QUERY:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"PROTOCOL"</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>) <span class="hljs-keyword">as</span> (protocol,host,<span class="hljs-keyword">path</span>) <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224152430.png" srcset="/img/loading.gif" lazyload alt="image-20211114224152430"></p>
<p>实现需求:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>,<span class="hljs-string">"QUERY"</span>) <span class="hljs-keyword">as</span> (host,<span class="hljs-keyword">path</span>,<span class="hljs-keyword">query</span>) <span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224201944.png" srcset="/img/loading.gif" lazyload alt="image-20211114224201944"></p>
<p>问题:</p>
<p>当前实现的过程中，通过parse_url_tuple实现了通过调用一个函数，就可以从URL中解析得到多个参数的值，但是将原表的字段放在一起查询时，会出现以下问题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <br><span class="hljs-keyword">id</span>,<br>parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>,<span class="hljs-string">"QUERY"</span>) <span class="hljs-keyword">as</span> (host,<span class="hljs-keyword">path</span>,<span class="hljs-keyword">query</span>) <br><span class="hljs-keyword">from</span> tb_url;<br><br>0: jdbc:hive2://node1:10000&gt; select <br>. . . . . . . . . . . . . .&gt; id,<br>. . . . . . . . . . . . . .&gt; parse_url_tuple(url,"HOST","PATH","QUERY") as (host,path,query) <br>. . . . . . . . . . . . . .&gt; from tb_url;<br>Error: Error while compiling statement: FAILED: SemanticException 3:52 AS clause has an invalid number of aliases. Error encountered near token 'path' (state=42000,code=40000)<br></code></pre></td></tr></table></figure>


<h2 id="UDTF函数的问题"><a href="#UDTF函数的问题" class="headerlink" title="UDTF函数的问题"></a>UDTF函数的问题</h2><p>Hive中的一对多的UDTF函数可以实现高效的数据转换，但是也存在着一些使用中的问题，UDTF函数对于很多场景下有使用限制，例如：<strong>select时不能包含其他字段、不能嵌套调用、不能与group by等放在一起调用</strong>等等。</p>
<p>UDTF函数的调用方式，主要有以下两种方式：</p>
<p><strong>方式一：直接在select后单独使用</strong></p>
<p><strong>方式二：与Lateral View放在一起使用</strong></p>
<h2 id="Lateral-View侧视图"><a href="#Lateral-View侧视图" class="headerlink" title="Lateral View侧视图"></a>Lateral View侧视图</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>Lateral View是一种特殊的语法，主要用于搭配UDTF类型功能的函数一起使用，用于解决UDTF函数的一些查询限制的问题。侧视图的原理是将UDTF的结果构建成一个类似于视图的表，然后将原表中的每一行和UDTF函数输出的每一行进行连接，生成一张新的虚拟表。这样就避免了UDTF的使用限制问题。使用lateral view时也可以对UDTF产生的记录设置字段名称，产生的字段可以用于group by、order by 、limit等语句中，不需要再单独嵌套一层子查询。一般只要使用UDTF，就会固定搭配lateral view使用。</p>
<p>官方链接：<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LateralView" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LateralView</a></p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">lateralView: LATERAL VIEW udtf(expression) tableAlias AS columnAlias (',' columnAlias)*<br>fromClause: FROM baseTable (lateralView)*<br></code></pre></td></tr></table></figure>

<p>基本语法如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> …… <span class="hljs-keyword">from</span> tabelA <span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> UDTF(xxx) 别名 <span class="hljs-keyword">as</span> col1,col2,col3……<br></code></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><strong>单个lateral view调用</strong>，实现上述需求中的应用:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.id <span class="hljs-keyword">as</span> <span class="hljs-keyword">id</span>,<br>  b.host <span class="hljs-keyword">as</span> host,<br>  b.path <span class="hljs-keyword">as</span> <span class="hljs-keyword">path</span>,<br>  b.query <span class="hljs-keyword">as</span> <span class="hljs-keyword">query</span><br><span class="hljs-keyword">from</span> tb_url a<br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>,<span class="hljs-string">"QUERY"</span>) b <span class="hljs-keyword">as</span> host,<span class="hljs-keyword">path</span>,<span class="hljs-keyword">query</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224216134.png" srcset="/img/loading.gif" lazyload alt="image-20211114224216134"></p>
<p><strong>多lateral view调用</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.id <span class="hljs-keyword">as</span> <span class="hljs-keyword">id</span>,<br>  b.host <span class="hljs-keyword">as</span> host,<br>  b.path <span class="hljs-keyword">as</span> <span class="hljs-keyword">path</span>,<br>  c.protocol <span class="hljs-keyword">as</span> protocol,<br>  c.query <span class="hljs-keyword">as</span> <span class="hljs-keyword">query</span><br><span class="hljs-keyword">from</span> tb_url a<br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"HOST"</span>,<span class="hljs-string">"PATH"</span>) b <span class="hljs-keyword">as</span> host,<span class="hljs-keyword">path</span><br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> parse_url_tuple(<span class="hljs-keyword">url</span>,<span class="hljs-string">"PROTOCOL"</span>,<span class="hljs-string">"QUERY"</span>) c <span class="hljs-keyword">as</span> protocol,<span class="hljs-keyword">query</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224228411.png" srcset="/img/loading.gif" lazyload alt="image-20211114224228411"></p>
<h3 id="Outer-Lateral-View"><a href="#Outer-Lateral-View" class="headerlink" title="Outer Lateral View"></a>Outer Lateral View</h3><p>如果UDTF不产生数据时，这时侧视图与原表关联的结果将为空，如下图所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">id</span>,<br>  <span class="hljs-keyword">url</span>,<br>  col1<br><span class="hljs-keyword">from</span> tb_url<br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> <span class="hljs-keyword">explode</span>(<span class="hljs-built_in">array</span>()) et <span class="hljs-keyword">as</span> col1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224240158.png" srcset="/img/loading.gif" lazyload alt="image-20211114224240158"></p>
<p><strong>如果加上outer关键字以后，就会保留原表数据，类似于outer join</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">id</span>,<br>  <span class="hljs-keyword">url</span>,<br>  col1<br><span class="hljs-keyword">from</span> tb_url<br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> <span class="hljs-keyword">outer</span> <span class="hljs-keyword">explode</span>(<span class="hljs-built_in">array</span>()) et <span class="hljs-keyword">as</span> col1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114213423112.png" srcset="/img/loading.gif" lazyload alt="image-20211114213423112"></p>
<h2 id="行列转换应用与实现"><a href="#行列转换应用与实现" class="headerlink" title="行列转换应用与实现"></a>行列转换应用与实现</h2><h3 id="行转列：多行转多列"><a href="#行转列：多行转多列" class="headerlink" title="行转列：多行转多列"></a>行转列：多行转多列</h3><h4 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h4><p>原始数据表:</p>
<p><img src="/Images/image-20211114213514117.png" srcset="/img/loading.gif" lazyload alt="image-20211114213514117"></p>
<p>目标结果表:</p>
<p><img src="/Images/image-20211114213527319.png" srcset="/img/loading.gif" lazyload alt="image-20211114213527319"></p>
<h4 id="case-when判断"><a href="#case-when判断" class="headerlink" title="case when判断"></a>case when判断</h4><p>功能:用于实现对数据的判断，根据条件，不同的情况返回不同的结果，类似于Java中的switch case 功能</p>
<p>语法:<br>语法一:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">CASE <br>WHEN 条件1 THEN VALUE1<br>WHEN 条件2 THEN VALUE2<br>……<br>WHEN 条件N THEN VALUEN<br>ELSE 默认值<br><span class="hljs-keyword">END</span><br></code></pre></td></tr></table></figure>

<p>语法二:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">CASE 列<br>WHEN V1 THEN VALUE1<br>WHEN V2 THEN VALUE2<br>……<br>WHEN VN THEN VALUEN<br>ELSE 默认值<br><span class="hljs-keyword">END</span><br></code></pre></td></tr></table></figure>

<p>测试:</p>
<p>语法一：当id &lt; 2显示a，当id &#x3D; 2 显示b ,其他的显示c:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">id</span>,<br>  <span class="hljs-keyword">case</span><br>  <span class="hljs-keyword">when</span> <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'a'</span><br>  <span class="hljs-keyword">when</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'b'</span><br>  <span class="hljs-keyword">else</span> <span class="hljs-string">'c'</span><br>  <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> caseName<br><span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114213653388.png" srcset="/img/loading.gif" lazyload alt="image-20211114213653388"></p>
<p>语法二：当id &#x3D;1 显示a，当id &#x3D; 2 显示b ,其他的显示c</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">id</span>,<br>  <span class="hljs-keyword">case</span> <span class="hljs-keyword">id</span><br>  <span class="hljs-keyword">when</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'a'</span><br>  <span class="hljs-keyword">when</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'b'</span><br>  <span class="hljs-keyword">else</span> <span class="hljs-string">'c'</span><br>  <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> caseName<br><span class="hljs-keyword">from</span> tb_url;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114213723616.png" srcset="/img/loading.gif" lazyload alt="image-20211114213723616"></p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>创建原始数据表，加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><span class="hljs-comment">--建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> row2col1(<br>   col1 <span class="hljs-keyword">string</span>,<br>   col2 <span class="hljs-keyword">string</span>,<br>   col3 <span class="hljs-built_in">int</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br><span class="hljs-comment">--加载数据到表中</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/r2c1.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> row2col1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114213808120.png" srcset="/img/loading.gif" lazyload alt="image-20211114213808120"></p>
<p>SQL实现转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  col1 <span class="hljs-keyword">as</span> col1,<br>  <span class="hljs-keyword">max</span>(<span class="hljs-keyword">case</span> col2 <span class="hljs-keyword">when</span> <span class="hljs-string">'c'</span> <span class="hljs-keyword">then</span> col3 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> c,<br>  <span class="hljs-keyword">max</span>(<span class="hljs-keyword">case</span> col2 <span class="hljs-keyword">when</span> <span class="hljs-string">'d'</span> <span class="hljs-keyword">then</span> col3 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> d,<br>  <span class="hljs-keyword">max</span>(<span class="hljs-keyword">case</span> col2 <span class="hljs-keyword">when</span> <span class="hljs-string">'e'</span> <span class="hljs-keyword">then</span> col3 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">as</span> e<br><span class="hljs-keyword">from</span><br>  row2col1<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span><br>  col1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114213831290.png" srcset="/img/loading.gif" lazyload alt="image-20211114213831290"></p>
<h3 id="行转列：多行转单列"><a href="#行转列：多行转单列" class="headerlink" title="行转列：多行转单列"></a>行转列：多行转单列</h3><h4 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h4><p>原始数据表</p>
<p><img src="/Images/image-20211114213912266.png" srcset="/img/loading.gif" lazyload alt="image-20211114213912266"></p>
<p>目标数据表</p>
<p><img src="/Images/image-20211114213924878.png" srcset="/img/loading.gif" lazyload alt="image-20211114213924878"></p>
<h4 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h4><p>功能：用于实现字符串拼接，不可指定分隔符</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">concat(element1,element2,element3……)<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">concat</span>(<span class="hljs-string">"it"</span>,<span class="hljs-string">"cast"</span>,<span class="hljs-string">"And"</span>,<span class="hljs-string">"dsjprs"</span>);<br>+<span class="hljs-comment">-----------------+</span><br>| itcastAndheima  |<br>+<span class="hljs-comment">-----------------+</span><br></code></pre></td></tr></table></figure>

<p>特点：如果任意一个元素为null，结果就为null</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">concat</span>(<span class="hljs-string">"it"</span>,<span class="hljs-string">"cast"</span>,<span class="hljs-string">"And"</span>,<span class="hljs-literal">null</span>);<br>+<span class="hljs-comment">-------+</span><br>| NULL  |<br>+<span class="hljs-comment">-------+</span><br></code></pre></td></tr></table></figure>


<h4 id="concat-ws"><a href="#concat-ws" class="headerlink" title="concat_ws"></a>concat_ws</h4><p>功能：用于实现字符串拼接，可以指定分隔符</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">concat_ws(SplitChar，element1，element2……)<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">concat_ws</span>(<span class="hljs-string">"-"</span>,<span class="hljs-string">"dsjprs_null"</span>,<span class="hljs-string">"And"</span>,<span class="hljs-string">"dsjprs"</span>);<br>+<span class="hljs-comment">-------------------+</span><br>| itcast-And-heima  |<br>+<span class="hljs-comment">-------------------+</span><br></code></pre></td></tr></table></figure>

<p>特点：任意一个元素不为null，结果就不为null</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">concat_ws</span>(<span class="hljs-string">"-"</span>,<span class="hljs-string">"dsjprs_null"</span>,<span class="hljs-string">"And"</span>,<span class="hljs-literal">null</span>);<br>+<span class="hljs-comment">-------------+</span><br>| dsjprs_null-And  |<br>+<span class="hljs-comment">-------------+</span><br></code></pre></td></tr></table></figure>


<h4 id="collect-list"><a href="#collect-list" class="headerlink" title="collect_list"></a>collect_list</h4><p>功能：用于将一列中的多行合并为一行，不进行去重</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">collect_list（colName）<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> collect_list(col1) <span class="hljs-keyword">from</span> row2col1;<br>+<span class="hljs-comment">----------------------------+</span><br>| ["a","a","a","b","b","b"]  |<br>+<span class="hljs-comment">----------------------------+</span><br></code></pre></td></tr></table></figure>


<h4 id="concat-set"><a href="#concat-set" class="headerlink" title="concat_set"></a>concat_set</h4><p>功能：用于将一列中的多行合并为一行，并进行去重</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">collect_set（colName）<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> collect_set(col1) <span class="hljs-keyword">from</span> row2col1;<br>+<span class="hljs-comment">------------+</span><br>| ["b","a"]  |<br>+<span class="hljs-comment">------------+</span><br></code></pre></td></tr></table></figure>


<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>创建原始数据表，加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> row2col2(<br>   col1 <span class="hljs-keyword">string</span>,<br>   col2 <span class="hljs-keyword">string</span>,<br>   col3 <span class="hljs-built_in">int</span><br>)<span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br><br><span class="hljs-comment">--加载数据到表中</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/r2c2.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> row2col2;<br></code></pre></td></tr></table></figure>

<p>SQL实现转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  col1,<br>  col2,<br>  <span class="hljs-keyword">concat_ws</span>(<span class="hljs-string">','</span>, collect_list(<span class="hljs-keyword">cast</span>(col3 <span class="hljs-keyword">as</span> <span class="hljs-keyword">string</span>))) <span class="hljs-keyword">as</span> col3<br><span class="hljs-keyword">from</span><br>  row2col2<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span><br>  col1, col2;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224259624.png" srcset="/img/loading.gif" lazyload alt="image-20211114224259624"></p>
<h3 id="列转行：多列转多行"><a href="#列转行：多列转多行" class="headerlink" title="列转行：多列转多行"></a>列转行：多列转多行</h3><h4 id="需求-4"><a href="#需求-4" class="headerlink" title="需求"></a>需求</h4><p>原始数据表</p>
<p><img src="/Images/image-20211114214447675.png" srcset="/img/loading.gif" lazyload alt="image-20211114214447675"></p>
<p>目标结果表</p>
<p><img src="/Images/image-20211114214459904.png" srcset="/img/loading.gif" lazyload alt="image-20211114214459904"></p>
<h4 id="union"><a href="#union" class="headerlink" title="union"></a>union</h4><p>功能：将多个select语句结果合并为一个，且结果去重且排序</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">select_statement <br>UNION [DISTINCT] <br>select_statement <br>UNION [DISTINCT] <br>select_statement ...<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>,<span class="hljs-string">'c'</span> <br><span class="hljs-keyword">union</span> <br><span class="hljs-keyword">select</span> <span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span> <br><span class="hljs-keyword">union</span>  <br><span class="hljs-keyword">select</span> <span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114214558885.png" srcset="/img/loading.gif" lazyload alt="image-20211114214558885"></p>
<h4 id="union-all"><a href="#union-all" class="headerlink" title="union all"></a>union all</h4><p>功能：将多个select语句结果合并为一个，且结果不去重不排序</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">select_statement UNION ALL select_statement UNION ALL select_statement ...<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>,<span class="hljs-string">'c'</span> <br><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <br><span class="hljs-keyword">select</span> <span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span> <br><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>  <br><span class="hljs-keyword">select</span> <span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114214659330.png" srcset="/img/loading.gif" lazyload alt="image-20211114214659330"></p>
<h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h4><p>创建原始数据表，加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> col2row1<br>(<br>  col1 <span class="hljs-keyword">string</span>,<br>  col2 <span class="hljs-built_in">int</span>,<br>  col3 <span class="hljs-built_in">int</span>,<br>  col4 <span class="hljs-built_in">int</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br><br><span class="hljs-comment">--加载数据</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/c2r1.txt'</span>  <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> col2row1;<br></code></pre></td></tr></table></figure>

<p>SQL实现转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> col1, <span class="hljs-string">'c'</span> <span class="hljs-keyword">as</span> col2, col2 <span class="hljs-keyword">as</span> col3 <span class="hljs-keyword">from</span> col2row1<br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br><span class="hljs-keyword">select</span> col1, <span class="hljs-string">'d'</span> <span class="hljs-keyword">as</span> col2, col3 <span class="hljs-keyword">as</span> col3 <span class="hljs-keyword">from</span> col2row1<br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br><span class="hljs-keyword">select</span> col1, <span class="hljs-string">'e'</span> <span class="hljs-keyword">as</span> col2, col4 <span class="hljs-keyword">as</span> col3 <span class="hljs-keyword">from</span> col2row1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114214744245.png" srcset="/img/loading.gif" lazyload alt="image-20211114214744245"></p>
<h3 id="列转行：单列转多行"><a href="#列转行：单列转多行" class="headerlink" title="列转行：单列转多行"></a>列转行：单列转多行</h3><h4 id="需求-5"><a href="#需求-5" class="headerlink" title="需求"></a>需求</h4><p>原始数据表</p>
<p><img src="/Images/image-20211114214816790.png" srcset="/img/loading.gif" lazyload alt="image-20211114214816790"></p>
<p>目标结果表</p>
<p><img src="/Images/image-20211114214826353.png" srcset="/img/loading.gif" lazyload alt="image-20211114214826353"></p>
<h4 id="explode"><a href="#explode" class="headerlink" title="explode"></a>explode</h4><p>功能：用于将一个集合或者数组中的每个元素展开，将每个元素变成一行</p>
<p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explode( Map | Array)<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">explode</span>(<span class="hljs-keyword">split</span>(<span class="hljs-string">"a,b,c,d"</span>,<span class="hljs-string">","</span>));<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114214910809.png" srcset="/img/loading.gif" lazyload alt="image-20211114214910809"></p>
<h4 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h4><p>创建原始数据表，加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> col2row2(<br>   col1 <span class="hljs-keyword">string</span>,<br>   col2 <span class="hljs-keyword">string</span>,<br>   col3 <span class="hljs-keyword">string</span><br>)<span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br><br><br><span class="hljs-comment">--加载数据</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/c2r2.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> col2row2;<br></code></pre></td></tr></table></figure>

<p>SQL实现转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  col1,<br>  col2,<br>  lv.col3 <span class="hljs-keyword">as</span> col3<br><span class="hljs-keyword">from</span><br>  col2row2<br>    <span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span><br>  <span class="hljs-keyword">explode</span>(<span class="hljs-keyword">split</span>(col3, <span class="hljs-string">','</span>)) lv <span class="hljs-keyword">as</span> col3;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114215000062.png" srcset="/img/loading.gif" lazyload alt="image-20211114215000062"></p>
<h2 id="JSON数据处理"><a href="#JSON数据处理" class="headerlink" title="JSON数据处理"></a>JSON数据处理</h2><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>JSON数据格式是数据存储及数据处理中最常见的结构化数据格式之一，很多场景下公司都会将数据以JSON格式存储在HDFS中，当构建数据仓库时，需要对JSON格式的数据进行处理和分析，那么就需要在Hive中对JSON格式的数据进行解析读取。</p>
<p><img src="/Images/image-20211114215115525.png" srcset="/img/loading.gif" lazyload alt="image-20211114215115525"></p>
<p>每条数据都以JSON形式存在，每条数据中都包含4个字段，分别为<strong>设备名称【device】、设备类型【deviceType】、信号强度【signal】和信号发送时间【time】，</strong>将这四个字段解析出来，在Hive表中以每一列的形式存储，最终得到以下Hive表：</p>
<p><img src="/Images/image-20211114224350878.png" srcset="/img/loading.gif" lazyload alt="image-20211114224350878"></p>
<h3 id="处理方式"><a href="#处理方式" class="headerlink" title="处理方式"></a>处理方式</h3><p>Hive中为了实现JSON格式的数据解析，提供了两种解析JSON数据的方式，在实际工作场景下，可以根据不同数据，不同的需求来选择合适的方式对JSON格式数据进行处理。</p>
<p><strong>方式一：使用JSON函数进行处理</strong></p>
<p>Hive中提供了两个专门用于解析JSON字符串的函数：<strong>get_json_object、json_tuple</strong>，这两个函数都可以实现将JSON数据中的每个字段独立解析出来，构建成表。</p>
<p><strong>方式二：使用Hive内置的JSON Serde加载数据</strong></p>
<p>Hive中除了提供JSON的解析函数以外，还提供了一种专门用于<strong>加载JSON文件的Serde</strong>来实现对JSON文件中数据的解析，在创建表时指定Serde，加载文件到表中，会自动解析为对应的表格式。</p>
<h3 id="JSON函数：get-json-object"><a href="#JSON函数：get-json-object" class="headerlink" title="JSON函数：get_json_object"></a>JSON函数：get_json_object</h3><h4 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h4><p> 用于解析JSON字符串，可以从JSON字符串中返回指定的某个对象列的值</p>
<h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">get_json_object(json_txt, path) - Extract a json object from path<br></code></pre></td></tr></table></figure>

<p><strong>参数:</strong></p>
<ul>
<li>第一个参数：指定要解析的JSON字符串</li>
<li>第二个参数：指定要返回的字段，通过**$.columnName**的方式来指定path</li>
<li>特点：每次只能返回JSON对象中一列的值</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_json_test1 (<br>  <span class="hljs-keyword">json</span> <span class="hljs-keyword">string</span><br>);<br></code></pre></td></tr></table></figure>

<p>加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--加载数据</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/device.json'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224420611.png" srcset="/img/loading.gif" lazyload alt="image-20211114224420611"></p>
<p>获取设备名称字段:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-keyword">json</span>,<br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.device"</span>) <span class="hljs-keyword">as</span> device<br><span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224431358.png" srcset="/img/loading.gif" lazyload alt="image-20211114224431358"></p>
<p>获取设备名称及信号强度字段:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-comment">--获取设备名称</span><br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.device"</span>) <span class="hljs-keyword">as</span> device,<br>       <span class="hljs-comment">--获取设备信号强度</span><br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.signal"</span>) <span class="hljs-keyword">as</span> signal<br><span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114215458862.png" srcset="/img/loading.gif" lazyload alt="image-20211114215458862"></p>
<p>实现需求:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-comment">--获取设备名称</span><br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.device"</span>) <span class="hljs-keyword">as</span> device,<br>       <span class="hljs-comment">--获取设备类型</span><br>         get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.deviceType"</span>) <span class="hljs-keyword">as</span> deviceType,<br>       <span class="hljs-comment">--获取设备信号强度</span><br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.signal"</span>) <span class="hljs-keyword">as</span> signal,<br>       <span class="hljs-comment">--获取时间</span><br>       get_json_object(<span class="hljs-keyword">json</span>,<span class="hljs-string">"$.time"</span>) <span class="hljs-keyword">as</span> stime<br><span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224444747.png" srcset="/img/loading.gif" lazyload alt="image-20211114224444747"></p>
<h3 id="JSON函数：json-tuple"><a href="#JSON函数：json-tuple" class="headerlink" title="JSON函数：json_tuple"></a>JSON函数：json_tuple</h3><h4 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h4><p>用于实现JSON字符串的解析，可以通过指定多个参数来解析JSON返回多列的值</p>
<h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">json_tuple(jsonStr, p1, p2, ..., pn) <br>like get_json_object, but it takes multiple names and return a tuple<br></code></pre></td></tr></table></figure>

<p><strong>参数:</strong></p>
<ul>
<li>第一个参数：指定要解析的JSON字符串</li>
<li>第二个参数：指定要返回的第1个字段</li>
<li>……</li>
<li>第N+1个参数：指定要返回的第N个字段</li>
</ul>
<p><strong>特点:</strong></p>
<ul>
<li>功能类似于get_json_object，但是可以调用一次返回多列的值。属于UDTF类型函数</li>
<li>返回的每一列都是字符串类型</li>
<li>一般搭配lateral view使用</li>
</ul>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><p>获取设备名称及信号强度字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-comment">--返回设备名称及信号强度</span><br>       json_tuple(<span class="hljs-keyword">json</span>,<span class="hljs-string">"device"</span>,<span class="hljs-string">"signal"</span>) <span class="hljs-keyword">as</span> (device,signal)<br><span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224457855.png" srcset="/img/loading.gif" lazyload alt="image-20211114224457855"></p>
<p>实现需求，单独使用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-comment">--解析所有字段</span><br>       json_tuple(<span class="hljs-keyword">json</span>,<span class="hljs-string">"device"</span>,<span class="hljs-string">"deviceType"</span>,<span class="hljs-string">"signal"</span>,<span class="hljs-string">"time"</span>) <span class="hljs-keyword">as</span> (device,deviceType,signal,stime)<br><span class="hljs-keyword">from</span> tb_json_test1;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224517816.png" srcset="/img/loading.gif" lazyload alt="image-20211114224517816"></p>
<p>实现需求，搭配侧视图</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       <span class="hljs-keyword">json</span>,device,deviceType,signal,stime<br><span class="hljs-keyword">from</span> tb_json_test1<br><span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> json_tuple(<span class="hljs-keyword">json</span>,<span class="hljs-string">"device"</span>,<span class="hljs-string">"deviceType"</span>,<span class="hljs-string">"signal"</span>,<span class="hljs-string">"time"</span>) b<br><span class="hljs-keyword">as</span> device,deviceType,signal,stime;<br></code></pre></td></tr></table></figure>


<h3 id="JSONSerde"><a href="#JSONSerde" class="headerlink" title="JSONSerde"></a>JSONSerde</h3><h4 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h4><p>上述解析JSON的过程中是将数据作为一个JSON字符串加载到表中，再通过JSON解析函数对JSON字符串进行解析，灵活性比较高，但是对于如果整个文件就是一个JSON文件，在使用起来就相对比较麻烦。</p>
<p>Hive中为了简化对于JSON文件的处理，内置了一种专门用于解析JSON文件的Serde解析器，<strong>在创建表时，只要指定使用JSONSerde解析表的文件，就会自动将JSON文件中的每一列进行解析</strong>。</p>
<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--创建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_json_test2 (<br>   device <span class="hljs-keyword">string</span>,<br>   deviceType <span class="hljs-keyword">string</span>,<br>   signal <span class="hljs-keyword">double</span>,<br>   <span class="hljs-string">`time`</span> <span class="hljs-keyword">string</span><br> )<br><span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> SERDE <span class="hljs-string">'org.apache.hive.hcatalog.data.JsonSerDe'</span><br><span class="hljs-keyword">STORED</span> <span class="hljs-keyword">AS</span> TEXTFILE;<br></code></pre></td></tr></table></figure>

<p>加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/device.json'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_json_test2;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tb_json_test2;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114224530257.png" srcset="/img/loading.gif" lazyload alt="image-20211114224530257"></p>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><p>不论是Hive中的JSON函数还是自带的JSONSerde，都可以实现对于JSON数据的解析，工作中一般根据数据格式以及对应的需求来实现解析。</p>
<p>如果数据中<strong>每一行只有个别字段是JSON格式字符串，就可以使用JSON函数来实现处理</strong>，但是如果数据加载的文件整体就是JSON文件，<strong>每一行数据就是一个JSON数据，那么建议直接使用JSONSerde</strong>来实现处理最为方便。</p>
<h2 id="窗口函数应用实例"><a href="#窗口函数应用实例" class="headerlink" title="窗口函数应用实例"></a>窗口函数应用实例</h2><h3 id="连续登陆用户"><a href="#连续登陆用户" class="headerlink" title="连续登陆用户"></a>连续登陆用户</h3><h4 id="需求-6"><a href="#需求-6" class="headerlink" title="需求"></a>需求</h4><p>当前有一份用户登录数据如下图所示，数据中有两个字段，分别是userId和loginTime。</p>
<p><img src="/Images/image-20211114220003409.png" srcset="/img/loading.gif" lazyload alt="image-20211114220003409"></p>
<p>userId表示唯一的用户ID，唯一标识一个用户，loginTime表示用户的登录日期，例如第一条数据就表示A在2021年3月22日登录了。</p>
<p>现在需要对用户的登录次数进行统计，得到连续登陆N（N&gt;&#x3D;2）天的用户。例如统计连续两天的登录的用户，需要返回A和C，因为A在22&#x2F;23&#x2F;24都登录了，所以肯定是连续两天登录，C在22和23号登录了，所以也是连续两天登录的。例如统计连续三天的登录的用户，只能返回A，因为只有A是连续三天登录的。</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>基于以上的需求根据数据寻找规律，要想得到连续登陆用户，必须找到两个相同用户ID的行之间登陆日期之间的关系。例如：统计连续登陆两天的用户，只要用户ID相等，并且登陆日期之间相差1天即可。基于这个规律，我们有两种方案可以实现该需求。</p>
<p><strong>方案一：实现表中的数据自连接，构建笛卡尔积，在结果中找到符合条件的id即可</strong></p>
<p><strong>方案二：使用窗口函数来实现</strong></p>
<h4 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h4><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_login(<br>  userid <span class="hljs-keyword">string</span>,<br>  logintime <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>创建数据：vim &#x2F;export&#x2F;data&#x2F;login.log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">A       2021-03-22<br>B       2021-03-22<br>C       2021-03-22<br>A       2021-03-23<br>C       2021-03-23<br>A       2021-03-24<br>B       2021-03-24<br></code></pre></td></tr></table></figure>

<p>加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/login.log'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_login;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tb_login;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220150130.png" srcset="/img/loading.gif" lazyload alt="image-20211114220150130"></p>
<h3 id="方案一：自连接过滤实现"><a href="#方案一：自连接过滤实现" class="headerlink" title="方案一：自连接过滤实现"></a>方案一：自连接过滤实现</h3><p>构建笛卡尔积</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.userid <span class="hljs-keyword">as</span> a_userid,<br>  a.logintime <span class="hljs-keyword">as</span> a_logintime,<br>  b.userid <span class="hljs-keyword">as</span> b_userid,<br>  b.logintime <span class="hljs-keyword">as</span> b_logintime<br><span class="hljs-keyword">from</span> tb_login a,tb_login b;<br></code></pre></td></tr></table></figure>

<p>查看数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs sql">+<span class="hljs-comment">-----------+--------------+-----------+--------------+</span><br>| A_USERID  | A_LOGINTIME  | B_USERID  | B_LOGINTIME  |<br>+<span class="hljs-comment">-----------+--------------+-----------+--------------+</span><br>| A         | 2021-03-22   | A         | 2021-03-22   |<br>| B         | 2021-03-22   | A         | 2021-03-22   |<br>| C         | 2021-03-22   | A         | 2021-03-22   |<br>| A         | 2021-03-23   | A         | 2021-03-22   |<br>| C         | 2021-03-23   | A         | 2021-03-22   |<br>| A         | 2021-03-24   | A         | 2021-03-22   |<br>| B         | 2021-03-24   | A         | 2021-03-22   |<br>| A         | 2021-03-22   | B         | 2021-03-22   |<br>| B         | 2021-03-22   | B         | 2021-03-22   |<br>| C         | 2021-03-22   | B         | 2021-03-22   |<br>| A         | 2021-03-23   | B         | 2021-03-22   |<br>| C         | 2021-03-23   | B         | 2021-03-22   |<br>| A         | 2021-03-24   | B         | 2021-03-22   |<br>| B         | 2021-03-24   | B         | 2021-03-22   |<br>| A         | 2021-03-22   | C         | 2021-03-22   |<br>| B         | 2021-03-22   | C         | 2021-03-22   |<br>| C         | 2021-03-22   | C         | 2021-03-22   |<br>| A         | 2021-03-23   | C         | 2021-03-22   |<br>| C         | 2021-03-23   | C         | 2021-03-22   |<br>| A         | 2021-03-24   | C         | 2021-03-22   |<br>| B         | 2021-03-24   | C         | 2021-03-22   |<br>| A         | 2021-03-22   | A         | 2021-03-23   |<br>| B         | 2021-03-22   | A         | 2021-03-23   |<br>| C         | 2021-03-22   | A         | 2021-03-23   |<br>| A         | 2021-03-23   | A         | 2021-03-23   |<br>| C         | 2021-03-23   | A         | 2021-03-23   |<br>| A         | 2021-03-24   | A         | 2021-03-23   |<br>| B         | 2021-03-24   | A         | 2021-03-23   |<br>| A         | 2021-03-22   | C         | 2021-03-23   |<br>| B         | 2021-03-22   | C         | 2021-03-23   |<br>| C         | 2021-03-22   | C         | 2021-03-23   |<br>| A         | 2021-03-23   | C         | 2021-03-23   |<br>| C         | 2021-03-23   | C         | 2021-03-23   |<br>| A         | 2021-03-24   | C         | 2021-03-23   |<br>| B         | 2021-03-24   | C         | 2021-03-23   |<br>| A         | 2021-03-22   | A         | 2021-03-24   |<br>| B         | 2021-03-22   | A         | 2021-03-24   |<br>| C         | 2021-03-22   | A         | 2021-03-24   |<br>| A         | 2021-03-23   | A         | 2021-03-24   |<br>| C         | 2021-03-23   | A         | 2021-03-24   |<br>| A         | 2021-03-24   | A         | 2021-03-24   |<br>| B         | 2021-03-24   | A         | 2021-03-24   |<br>| A         | 2021-03-22   | B         | 2021-03-24   |<br>| B         | 2021-03-22   | B         | 2021-03-24   |<br>| C         | 2021-03-22   | B         | 2021-03-24   |<br>| A         | 2021-03-23   | B         | 2021-03-24   |<br>| C         | 2021-03-23   | B         | 2021-03-24   |<br>| A         | 2021-03-24   | B         | 2021-03-24   |<br>| B         | 2021-03-24   | B         | 2021-03-24   |<br>+<span class="hljs-comment">-----------+--------------+-----------+--------------+</span><br></code></pre></td></tr></table></figure>

<p>保存为表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_login_tmp <span class="hljs-keyword">as</span><br><span class="hljs-keyword">select</span><br>  a.userid <span class="hljs-keyword">as</span> a_userid,<br>  a.logintime <span class="hljs-keyword">as</span> a_logintime,<br>  b.userid <span class="hljs-keyword">as</span> b_userid,<br>  b.logintime <span class="hljs-keyword">as</span> b_logintime<br><span class="hljs-keyword">from</span> tb_login a,tb_login b;<br></code></pre></td></tr></table></figure>

<p>过滤数据：用户id相同并且登陆日期相差1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a_userid,a_logintime,b_userid,b_logintime<br><span class="hljs-keyword">from</span> tb_login_tmp<br><span class="hljs-keyword">where</span> a_userid = b_userid<br><span class="hljs-keyword">and</span> <span class="hljs-keyword">cast</span>(<span class="hljs-keyword">substr</span>(a_logintime,<span class="hljs-number">9</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>) - <span class="hljs-number">1</span> = <span class="hljs-keyword">cast</span>(<span class="hljs-keyword">substr</span>(b_logintime,<span class="hljs-number">9</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220333750.png" srcset="/img/loading.gif" lazyload alt="image-20211114220333750"></p>
<p>统计连续登陆两天的用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  <span class="hljs-keyword">distinct</span> a_userid<br><span class="hljs-keyword">from</span> tb_login_tmp<br><span class="hljs-keyword">where</span> a_userid = b_userid<br><span class="hljs-keyword">and</span> <span class="hljs-keyword">cast</span>(<span class="hljs-keyword">substr</span>(a_logintime,<span class="hljs-number">9</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>) - <span class="hljs-number">1</span> = <span class="hljs-keyword">cast</span>(<span class="hljs-keyword">substr</span>(b_logintime,<span class="hljs-number">9</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220407806.png" srcset="/img/loading.gif" lazyload alt="image-20211114220407806"></p>
<h3 id="方案二：窗口函数实现"><a href="#方案二：窗口函数实现" class="headerlink" title="方案二：窗口函数实现"></a>方案二：窗口函数实现</h3><p><strong>窗口函数lead</strong></p>
<p>功能：用于从当前数据中基于当前行的数据向后偏移取值</p>
<p>语法：lead(colName，N，defautValue)</p>
<p>colName：取哪一列的值</p>
<p>N：向后偏移N行</p>
<p>defaultValue：如果取不到返回的默认值</p>
<p><strong>分析</strong></p>
<p>当前数据中记录了每个用户每一次登陆的日期，一个用户在一天只有1条信息，我们可以基于用户的登陆信息，找到如下规律：</p>
<p>连续两天登陆 ： 用户下次登陆时间 &#x3D; 本次登陆以后的第二天</p>
<p>连续三天登陆 ： 用户下下次登陆时间 &#x3D; 本次登陆以后的第三天</p>
<p>……依次类推。</p>
<p>可以对用户ID进行分区，按照登陆时间进行排序，通过lead函数计算出用户下次登陆时间，通过日期函数计算出登陆以后第二天的日期，如果相等即为连续两天登录。</p>
<p><strong>统计连续2天登录</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  userid,<br>  logintime,<br>  <span class="hljs-comment">--本次登陆日期的第二天</span><br>  <span class="hljs-keyword">date_add</span>(logintime,<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> nextday,<br>  <span class="hljs-comment">--按照用户id分区，按照登陆日期排序，取下一次登陆时间，取不到就为0</span><br>  <span class="hljs-keyword">lead</span>(logintime,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> logintime) <span class="hljs-keyword">as</span> nextlogin<br><span class="hljs-keyword">from</span> tb_login;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220522834.png" srcset="/img/loading.gif" lazyload alt="image-20211114220522834"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> t1 <span class="hljs-keyword">as</span> (<br>  <span class="hljs-keyword">select</span><br>    userid,<br>    logintime,<br>    <span class="hljs-comment">--本次登陆日期的第二天</span><br>      <span class="hljs-keyword">date_add</span>(logintime,<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> nextday,<br>    <span class="hljs-comment">--按照用户id分区，按照登陆日期排序，取下一次登陆时间，取不到就为0</span><br>     <span class="hljs-keyword">lead</span>(logintime,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> logintime) <span class="hljs-keyword">as</span> nextlogin<br><span class="hljs-keyword">from</span> tb_login )<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> userid <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> nextday = nextlogin;<br></code></pre></td></tr></table></figure>

<p><strong>统计连续3天登录</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  userid,<br>  logintime,<br>  <span class="hljs-comment">--本次登陆日期的第三天</span><br>  <span class="hljs-keyword">date_add</span>(logintime,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> nextday,<br>  <span class="hljs-comment">--按照用户id分区，按照登陆日期排序，取下下一次登陆时间，取不到就为0</span><br>  <span class="hljs-keyword">lead</span>(logintime,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> logintime) <span class="hljs-keyword">as</span> nextlogin<br><span class="hljs-keyword">from</span> tb_login;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220600373.png" srcset="/img/loading.gif" lazyload alt="image-20211114220600373"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> t1 <span class="hljs-keyword">as</span> (<br><span class="hljs-keyword">select</span><br>  userid,<br>  logintime,<br>  <span class="hljs-comment">--本次登陆日期的第三天</span><br>  <span class="hljs-keyword">date_add</span>(logintime,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> nextday,<br>  <span class="hljs-comment">--按照用户id分区，按照登陆日期排序，取下下一次登陆时间，取不到就为0</span><br>  <span class="hljs-keyword">lead</span>(logintime,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> logintime) <span class="hljs-keyword">as</span> nextlogin<br><span class="hljs-keyword">from</span> tb_login )<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> userid <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> nextday = nextlogin;<br></code></pre></td></tr></table></figure>

<p>统计连续<strong>N天</strong>登录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  userid,<br>  logintime,<br>  <span class="hljs-comment">--本次登陆日期的第N天</span><br>  <span class="hljs-keyword">date_add</span>(logintime,N<span class="hljs-number">-1</span>) <span class="hljs-keyword">as</span> nextday,<br>  <span class="hljs-comment">--按照用户id分区，按照登陆日期排序，取下下一次登陆时间，取不到就为0</span><br>  <span class="hljs-keyword">lead</span>(logintime,N<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> logintime) <span class="hljs-keyword">as</span> nextlogin<br><span class="hljs-keyword">from</span> tb_login;<br></code></pre></td></tr></table></figure>

<h3 id="级联累加求和"><a href="#级联累加求和" class="headerlink" title="级联累加求和"></a>级联累加求和</h3><h4 id="需求-7"><a href="#需求-7" class="headerlink" title="需求"></a>需求</h4><p>当前有一份消费数据如下，记录了每个用户在每个月的所有消费记录，数据表中一共有三列：</p>
<p><img src="/Images/image-20211114220711717.png" srcset="/img/loading.gif" lazyload alt="image-20211114220711717"></p>
<p><strong>userId</strong>：用户唯一id，唯一标识一个用户</p>
<p><strong>mth</strong>：用户消费的月份，一个用户可以在一个月多次消费</p>
<p><strong>money</strong>：用户每次消费的金额</p>
<p>现在需要基于用户每个月的多次消费的记录进行分析，统计得到每个用户在每个月的消费总金额以及当前累计消费总金额，最后结果如下：</p>
<p><img src="/Images/image-20211114220730880.png" srcset="/img/loading.gif" lazyload alt="image-20211114220730880"></p>
<p>以用户A为例：</p>
<p>​    A在2021年1月份，共四次消费，分别消费5元、15元、8元、5元，所以本月共消费33元，累计消费33元。</p>
<p>​    A在2021年2月份，共两次消费，分别消费4元、6元，所以本月共消费10元，累计消费43元。</p>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>如果要实现以上需求，首先要统计出每个用户每个月的消费总金额，分组实现集合，但是需要按照用户ID，将该用户这个月之前的所有月份的消费总金额进行累加实现。该需求可以通过两种方案来实现：</p>
<p><strong>方案一：分组统计每个用户每个月的消费金额，然后构建自连接，根据条件分组聚合</strong> </p>
<p><strong>方案二：分组统计每个用户每个月的消费金额，然后使用窗口聚合函数实现</strong></p>
<h4 id="建表-1"><a href="#建表-1" class="headerlink" title="建表"></a>建表</h4><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_money(<br>  userid <span class="hljs-keyword">string</span>,<br>  mth <span class="hljs-keyword">string</span>,<br>  money <span class="hljs-built_in">int</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>创建数据：vim &#x2F;export&#x2F;data&#x2F;money.tsv</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">A	2021-01	5<br>A	2021-01	15<br>B	2021-01	5<br>A	2021-01	8<br>B	2021-01	25<br>A	2021-01	5<br>A	2021-02	4<br>A	2021-02	6<br>B	2021-02	10<br>B	2021-02	5<br>A	2021-03	7<br>B	2021-03	9<br>A	2021-03	11<br>B	2021-03	6<br></code></pre></td></tr></table></figure>

<p>加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/money.tsv'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_money;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tb_money;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220923993.png" srcset="/img/loading.gif" lazyload alt="image-20211114220923993"></p>
<p>统计得到每个用户每个月的消费总金额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_money_mtn <span class="hljs-keyword">as</span><br><span class="hljs-keyword">select</span><br>  userid,<br>  mth,<br>  <span class="hljs-keyword">sum</span>(money) <span class="hljs-keyword">as</span> m_money<br><span class="hljs-keyword">from</span> tb_money<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> userid,mth;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114220950286.png" srcset="/img/loading.gif" lazyload alt="image-20211114220950286"></p>
<h4 id="方案一：自连接分组聚合"><a href="#方案一：自连接分组聚合" class="headerlink" title="方案一：自连接分组聚合"></a>方案一：自连接分组聚合</h4><p>基于每个用户每个月的消费总金额进行自连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.userid <span class="hljs-keyword">as</span> auserid,<br>  a.mth <span class="hljs-keyword">as</span> amth,<br>  a.m_money <span class="hljs-keyword">as</span> am_money,<br>  b.userid <span class="hljs-keyword">as</span> buserid,<br>  b.mth <span class="hljs-keyword">as</span> bmth,<br>  b.m_money <span class="hljs-keyword">as</span> bm_money<br><span class="hljs-keyword">from</span> tb_money_mtn a <span class="hljs-keyword">join</span> tb_money_mtn b <span class="hljs-keyword">on</span> a.userid = b.userid;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221040025.png" srcset="/img/loading.gif" lazyload alt="image-20211114221040025"></p>
<p>将每个月之前月份的数据过滤出来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.userid <span class="hljs-keyword">as</span> auserid,<br>  a.mth <span class="hljs-keyword">as</span> amth,<br>  a.m_money <span class="hljs-keyword">as</span> am_money,<br>  b.userid <span class="hljs-keyword">as</span> buserid,<br>  b.mth <span class="hljs-keyword">as</span> bmth,<br>  b.m_money <span class="hljs-keyword">as</span> bm_money<br><span class="hljs-keyword">from</span> tb_money_mtn a <span class="hljs-keyword">join</span> tb_money_mtn b <span class="hljs-keyword">on</span> a.userid = b.userid<br><span class="hljs-keyword">where</span> a.mth &gt;= b.mth;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221125763.png" srcset="/img/loading.gif" lazyload alt="image-20211114221125763"></p>
<p>对每个用户每个月的金额进行分组，聚合之前月份的消费金额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>  a.userid <span class="hljs-keyword">as</span> auserid,<br>  a.mth <span class="hljs-keyword">as</span> amth,<br>  a.m_money <span class="hljs-keyword">as</span> am_money,<br>  <span class="hljs-keyword">sum</span>(b.m_money) <span class="hljs-keyword">as</span> t_money<br><span class="hljs-keyword">from</span> tb_money_mtn a <span class="hljs-keyword">join</span> tb_money_mtn b <span class="hljs-keyword">on</span> a.userid = b.userid<br><span class="hljs-keyword">where</span> a.mth &gt;= b.mth<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> a.userid,a.mth,a.m_money;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221158312.png" srcset="/img/loading.gif" lazyload alt="image-20211114221158312"></p>
<h4 id="方案二：窗口函数实现-1"><a href="#方案二：窗口函数实现-1" class="headerlink" title="方案二：窗口函数实现"></a>方案二：窗口函数实现</h4><p><strong>窗口函数sum</strong></p>
<p>功能：用于实现基于窗口的数据求和</p>
<p>语法：sum(colName) <strong>over</strong> (<strong>partition by</strong> col <strong>order by</strong> col)</p>
<p>colName：对某一列的值进行求和</p>
<p><strong>分析</strong></p>
<p>基于每个用户每个月的消费金额，可以通过窗口函数对用户进行分区，按照月份排序，然后基于聚合窗口，从每个分区的第一行累加到当前和，即可得到累计消费金额。</p>
<p><strong>统计每个用户每个月消费金额及累计总金额</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>    userid,<br>    mth,<br>    m_money,<br>    <span class="hljs-keyword">sum</span>(m_money) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> userid <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> mth) <span class="hljs-keyword">as</span> t_money<br><span class="hljs-keyword">from</span> tb_money_mtn;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221241877.png" srcset="/img/loading.gif" lazyload alt="image-20211114221241877"></p>
<h2 id="分组TopN"><a href="#分组TopN" class="headerlink" title="分组TopN"></a>分组TopN</h2><h4 id="需求-8"><a href="#需求-8" class="headerlink" title="需求"></a>需求</h4><p>工作中经常需要实现TopN的需求，例如热门商品Top10、热门话题Top20、热门搜索Top10、地区用户Top10等等，TopN是大数据业务分析中最常见的需求。</p>
<p>​    </p>
<p>普通的TopN只要基于数据进行排序，然后基于排序后的结果取前N个即可，相对简单，但是在TopN中有一种特殊的TopN计算，叫做分组TopN。</p>
<p>分组TopN指的是基于数据进行分组，从每个组内取TopN，不再基于全局取TopN。如果要实现分组取TopN就相对麻烦。</p>
<p>例如：现在有一份数据如下，记录这所有员工的信息：</p>
<p><img src="/Images/image-20211114221350344.png" srcset="/img/loading.gif" lazyload alt="image-20211114221350344"></p>
<p>如果现在有一个需求：查询每个部门薪资最高的员工的薪水，这个可以直接基于表中数据分组查询得到</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> deptno,<span class="hljs-keyword">max</span>(salary) <span class="hljs-keyword">from</span> tb_emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> deptno;<br></code></pre></td></tr></table></figure>

<h4 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h4><p>根据上述需求，这种情况下是无法根据group by分组聚合实现的，因为分组聚合只能实现返回一条聚合的结果，但是需求中需要每个部门返回薪资最高的前两名，有两条结果，这时候就需要用到窗口函数中的分区来实现了。</p>
<h4 id="建表-2"><a href="#建表-2" class="headerlink" title="建表"></a>建表</h4><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--切换数据库</span><br><span class="hljs-keyword">use</span> db_function;<br><br><span class="hljs-comment">--建表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_emp(<br>   empno <span class="hljs-keyword">string</span>,<br>   ename <span class="hljs-keyword">string</span>,<br>   job <span class="hljs-keyword">string</span>,<br>   managerid <span class="hljs-keyword">string</span>,<br>   hiredate <span class="hljs-keyword">string</span>,<br>   salary <span class="hljs-keyword">double</span>,<br>   bonus <span class="hljs-keyword">double</span>,<br>   deptno <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>创建数据：vim &#x2F;export&#x2F;data&#x2F;emp.txt</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">7369	SMITH	CLERK		7902	1980-12-17	800.00		20<br>7499	ALLEN	SALESMAN	7698	1981-2-20	1600.00	300.00	30<br>7521	WARD	SALESMAN	7698	1981-2-22	1250.00	500.00	30<br>7566	JONES	MANAGER		7839	1981-4-2	2975.00		20<br>7654	MARTIN	SALESMAN	7698	1981-9-28	1250.00	1400.00	30<br>7698	BLAKE	MANAGER		7839	1981-5-1	2850.00		30<br>7782	CLARK	MANAGER		7839	1981-6-9	2450.00		10<br>7788	SCOTT	ANALYST		7566	1987-4-19	3000.00		20<br>7839	KING	PRESIDENT			1981-11-17	5000.00		10<br>7844	TURNER	SALESMAN	7698	1981-9-8	1500.00	0.00	30<br>7876	ADAMS	CLERK		7788	1987-5-23	1100.00		20<br>7900	JAMES	CLERK		7698	1981-12-3	950.00		30<br>7902	FORD	ANALYST		7566	1981-12-3	3000.00		20<br>7934	MILLER	CLERK		7782	1982-1-23	1300.00		10<br></code></pre></td></tr></table></figure>

<p>加载数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/emp.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> tb_emp;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> empno,ename,salary,deptno <span class="hljs-keyword">from</span> tb_emp;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221547744.png" srcset="/img/loading.gif" lazyload alt="image-20211114221547744"></p>
<h4 id="实现-4"><a href="#实现-4" class="headerlink" title="实现"></a>实现</h4><p><strong>TopN函数：row_number、rank、dense_rank</strong></p>
<p><strong>row_number：对每个分区的数据进行编号，如果值相同，继续编号</strong></p>
<p><strong>rank：对每个分区的数据进行编号，<em>如果值相同</em>，<em>编号相同</em>，但留下空位</strong></p>
<p><strong>dense_rank：对每个分区的数据进行编号，如果值相同，编号相同，<em>不留下空位</em></strong></p>
<p>基于row_number实现，按照部门分区，每个部门内部按照薪水降序排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>       empno,<br>       ename,<br>       salary,<br>       deptno,<br>       row_number() <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> deptno <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> salary <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> rn<br><span class="hljs-keyword">from</span> tb_emp;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221652051.png" srcset="/img/loading.gif" lazyload alt="image-20211114221652051"></p>
<p>过滤每个部门的薪资最高的前两名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">with</span> t1 <span class="hljs-keyword">as</span> (<br><span class="hljs-keyword">select</span><br>       empno,<br>       ename,<br>       salary,<br>       deptno,<br>       row_number() <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> deptno <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> salary <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> rn<br><span class="hljs-keyword">from</span> tb_emp )<br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> rn &lt; <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114221718697.png" srcset="/img/loading.gif" lazyload alt="image-20211114221718697"></p>
<h2 id="拉链表的设计与实现"><a href="#拉链表的设计与实现" class="headerlink" title="拉链表的设计与实现"></a>拉链表的设计与实现</h2><h3 id="数据同步问题"><a href="#数据同步问题" class="headerlink" title="数据同步问题"></a>数据同步问题</h3><h4 id="数据同步的场景"><a href="#数据同步的场景" class="headerlink" title="数据同步的场景"></a>数据同步的场景</h4><p>Hive在实际工作中主要用于构建离线数据仓库，定期的从各种数据源中同步采集数据到Hive中，经过分层转换提供数据应用。例如，每天需要从MySQL中同步最新的订单信息、用户信息、店铺信息等到数据仓库中，进行订单分析、用户分析。</p>
<p>例如：MySQL中有一张用户表：tb_user，每个用户注册完成以后，就会在用户表中新增该用户的信息，记录该用户的id、手机号码、用户名、性别、地址等信息。</p>
<p><img src="/Images/image-20211114221748307.png" srcset="/img/loading.gif" lazyload alt="image-20211114221748307"></p>
<p>每天都会有用户注册，产生新的用户信息，我们每天都需要将MySQL中的用户数据同步到Hive数据仓库中，在做用户分析时，需要对用户的信息做统计分析，例如统计新增用户的个数、总用户个数、用户性别分布、地区分布、运营商分布等指标。</p>
<h4 id="数据同步的问题"><a href="#数据同步的问题" class="headerlink" title="数据同步的问题"></a>数据同步的问题</h4><p>在实现数据仓库数据同步的过程中，我们必须保证Hive中的数据与MySQL中的数据是一致的，这样才能确保我们最终分析出来的结果是准确的，没有问题的，但是在实现同步的过程中，这里会面临一个问题：<strong>如果MySQL中的数据发生了修改，Hive中如何存储被修改的数据？</strong></p>
<p>例如以下情况</p>
<p><strong>2021-01-01：MySQL中有10条用户信息</strong></p>
<p><img src="/Images/image-20211114221926040.png" srcset="/img/loading.gif" lazyload alt="image-20211114221926040"></p>
<p><strong>2021-01-02：Hive进行数据分析，将MySQL中的数据同步</strong></p>
<p><img src="/Images/image-20211114221908152.png" srcset="/img/loading.gif" lazyload alt="image-20211114221908152"></p>
<p><strong>2021-01-02：MySQL中新增2条用户注册数据，并且有1条用户数据发生更新</strong></p>
<p><img src="/Images/image-20211114221944404.png" srcset="/img/loading.gif" lazyload alt="image-20211114221944404"></p>
<p>新增两条用户数据<strong>011</strong>和<strong>012</strong></p>
<p>008的addr发生了更新，<strong>从gz更新为sh</strong></p>
<p><strong>2021-01-03：Hive需要对2号的数据进行同步更新处理</strong></p>
<p><strong>问题：新增的数据会直接加载到Hive表中，但是更新的数据如何存储在Hive表中？</strong></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>方案一：在Hive中用新的addr覆盖008的老的addr，直接更新</strong></p>
<p><img src="/Images/image-20211114222036829.png" srcset="/img/loading.gif" lazyload alt="image-20211114222036829"></p>
<p><strong>优点</strong>：实现最简单，使用起来最方便</p>
<p><strong>缺点</strong>：没有历史状态，008的地址是1月2号在sh，但是1月2号之前是在gz的，如果要查询008的1月2号之前的addr就无法查询，也不能使用sh代替</p>
<p><strong>方案二：每次数据改变，根据日期构建一份全量的快照表，每天一张表</strong></p>
<p>2021-01-02：Hive中有一张表tb_user_2021-01-02</p>
<p><img src="/Images/image-20211114222108551.png" srcset="/img/loading.gif" lazyload alt="image-20211114222108551"></p>
<p>2021-01-03：Hive中有一张表tb_user_2021-01-03</p>
<p><img src="/Images/image-20211114222134103.png" srcset="/img/loading.gif" lazyload alt="image-20211114222134103"></p>
<p><strong>优点</strong>：记录了所有数据在不同时间的状态 </p>
<p><strong>缺点</strong>：冗余存储了很多没有发生变化的数据，导致存储的数据量过大 </p>
<p><strong>方案三：构建拉链表，通过时间标记发生变化的数据的每种状态的时间周期</strong></p>
<p><img src="/Images/image-20211114222202952.png" srcset="/img/loading.gif" lazyload alt="image-20211114222202952"></p>
<h3 id="拉链表的设计"><a href="#拉链表的设计" class="headerlink" title="拉链表的设计"></a>拉链表的设计</h3><h4 id="功能与应用场景"><a href="#功能与应用场景" class="headerlink" title="功能与应用场景"></a>功能与应用场景</h4><p>拉链表专门用于解决在数据仓库中数据发生变化如何实现数据存储的问题，如果直接覆盖历史状态，会导致无法查询历史状态，如果将所有数据单独切片存储，会导致存储大量非更新数据的问题。</p>
<p>拉链表的设计是将更新的数据进行状态记录，没有发生更新的数据不进行状态存储，用于存储所有数据在不同时间上的所有状态，通过时间进行标记每个状态的生命周期，查询时，根据需求可以获取指定时间范围状态的数据，默认用9999-12-31等最大值来表示最新状态。</p>
<h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p>整体实现过程一般分为三步，第一步先增量采集所有新增数据【增加的数据和发生变化的数据】放入一张增量表。第二步创建一张临时表，用于将老的拉链表与增量表进行合并。第三步，最后将临时表的数据覆盖写入拉链表中。例如：</p>
<p>当前MySQL中的数据：</p>
<p><img src="/Images/image-20211114222244363.png" srcset="/img/loading.gif" lazyload alt="image-20211114222244363"></p>
<p>当前Hive数据仓库中拉链表的数据：</p>
<p><img src="/Images/image-20211114222254888.png" srcset="/img/loading.gif" lazyload alt="image-20211114222254888"></p>
<p><strong>step1</strong>：增量采集变化数据，放入增量表中</p>
<p><img src="/Images/image-20211114222306581.png" srcset="/img/loading.gif" lazyload alt="image-20211114222306581"></p>
<p><strong>step2</strong>：构建临时表，将Hive中的拉链表与临时表的数据进行合并</p>
<p><img src="/Images/image-20211114222325013.png" srcset="/img/loading.gif" lazyload alt="image-20211114222325013"></p>
<p><strong>step3</strong>：将临时表的数据覆盖写入拉链表中</p>
<p><img src="/Images/image-20211114222351004.png" srcset="/img/loading.gif" lazyload alt="image-20211114222351004"></p>
<h3 id="拉链表的实现"><a href="#拉链表的实现" class="headerlink" title="拉链表的实现"></a>拉链表的实现</h3><h4 id="数据准备-1"><a href="#数据准备-1" class="headerlink" title="数据准备"></a>数据准备</h4><p>创建dw层拉链表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--创建数据库</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> db_zipper;<br><span class="hljs-keyword">use</span> db_zipper;<br><br><span class="hljs-comment">--创建拉链表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dw_zipper(<br>  userid <span class="hljs-keyword">string</span>,<br>  phone <span class="hljs-keyword">string</span>,<br>  nick <span class="hljs-keyword">string</span>,<br>  gender <span class="hljs-built_in">int</span>,<br>  addr <span class="hljs-keyword">string</span>,<br>  starttime <span class="hljs-keyword">string</span>,<br>  endtime <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>构建模拟数据：vim &#x2F;export&#x2F;data&#x2F;zipper.txt</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">001	186xxxx1234	laoda	0	sh	2021-01-01	9999-12-31<br>002	186xxxx1235	laoer	1	bj	2021-01-01	9999-12-31<br>003	186xxxx1236	laosan	0	sz	2021-01-01	9999-12-31<br>004	186xxxx1237	laosi	1	gz	2021-01-01	9999-12-31<br>005	186xxxx1238	laowu	0	sh	2021-01-01	9999-12-31<br>006	186xxxx1239	laoliu	1	bj	2021-01-01	9999-12-31<br>007	186xxxx1240	laoqi	0	sz	2021-01-01	9999-12-31<br>008	186xxxx1241	laoba	1	gz	2021-01-01	9999-12-31<br>009	186xxxx1242	laojiu	0	sh	2021-01-01	9999-12-31<br>010	186xxxx1243	laoshi	1	bj	2021-01-01	9999-12-31<br></code></pre></td></tr></table></figure>

<p>加载拉链表数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--加载模拟数据</span><br><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/zipper.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> dw_zipper;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> userid,nick,addr,starttime,endtime <span class="hljs-keyword">from</span> dw_zipper;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114222513160.png" srcset="/img/loading.gif" lazyload alt="image-20211114222513160"></p>
<h4 id="增量采集"><a href="#增量采集" class="headerlink" title="增量采集"></a>增量采集</h4><p>创建ods层增量表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ods_zipper_update(<br>  userid <span class="hljs-keyword">string</span>,<br>  phone <span class="hljs-keyword">string</span>,<br>  nick <span class="hljs-keyword">string</span>,<br>  gender <span class="hljs-built_in">int</span>,<br>  addr <span class="hljs-keyword">string</span>,<br>  starttime <span class="hljs-keyword">string</span>,<br>  endtime <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>创建模拟数据：vim &#x2F;export&#x2F;data&#x2F;update.txt</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">008	186xxxx1241	laoba	1	sh	2021-01-02	9999-12-31<br>011	186xxxx1244	laoshi	1	jx	2021-01-02	9999-12-31<br>012	186xxxx1245	laoshi	0	zj	2021-01-02	9999-12-31<br></code></pre></td></tr></table></figure>

<p>加载更新数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/export/data/update.txt'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> ods_zipper_update;<br></code></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> userid,nick,addr,starttime,endtime <span class="hljs-keyword">from</span> ods_zipper_update;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114222952774.png" srcset="/img/loading.gif" lazyload alt="image-20211114222952774"></p>
<h4 id="合并数据"><a href="#合并数据" class="headerlink" title="合并数据"></a>合并数据</h4><p>创建临时表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tmp_zipper(<br>  userid <span class="hljs-keyword">string</span>,<br>  phone <span class="hljs-keyword">string</span>,<br>  nick <span class="hljs-keyword">string</span>,<br>  gender <span class="hljs-built_in">int</span>,<br>  addr <span class="hljs-keyword">string</span>,<br>  starttime <span class="hljs-keyword">string</span>,<br>  endtime <span class="hljs-keyword">string</span><br>) <span class="hljs-keyword">row</span> <span class="hljs-keyword">format</span> <span class="hljs-keyword">delimited</span> <span class="hljs-keyword">fields</span> <span class="hljs-keyword">terminated</span> <span class="hljs-keyword">by</span> <span class="hljs-string">'\t'</span>;<br></code></pre></td></tr></table></figure>

<p>合并拉链表与增量表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> overwrite <span class="hljs-keyword">table</span> tmp_zipper<br><span class="hljs-keyword">select</span><br>  userid,<br>  phone,<br>  nick,<br>  gender,<br>  addr,<br>  starttime,<br>  endtime<br><span class="hljs-keyword">from</span> ods_zipper_update<br><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br><span class="hljs-comment">--查询原来拉链表的所有数据，并将这次需要更新的数据的endTime更改为更新值的startTime</span><br><span class="hljs-keyword">select</span><br>  a.userid,<br>  a.phone,<br>  a.nick,<br>  a.gender,<br>  a.addr,<br>  a.starttime,<br>  <span class="hljs-comment">--如果这条数据没有更新或者这条数据不是要更改的数据，就保留原来的值，否则就改为新数据的开始时间-1</span><br>  <span class="hljs-keyword">if</span>(b.userid <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> a.endtime &lt; <span class="hljs-string">'9999-12-31'</span>, a.endtime , <span class="hljs-keyword">date_sub</span>(b.starttime,<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> endtime<br><span class="hljs-keyword">from</span> dw_zipper a  <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> ods_zipper_update b<br><span class="hljs-keyword">on</span> a.userid = b.userid ;<br></code></pre></td></tr></table></figure>

<p><img src="/Images/image-20211114223041730.png" srcset="/img/loading.gif" lazyload alt="image-20211114223041730"></p>
<h4 id="生成最新拉链表"><a href="#生成最新拉链表" class="headerlink" title="生成最新拉链表"></a>生成最新拉链表</h4><p>覆盖拉链表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> overwrite <span class="hljs-keyword">table</span> dw_zipper<br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> tmp_zipper;<br></code></pre></td></tr></table></figure>




                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Hive/" class="category-chain-item">Hive</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Hive/" class="print-no-link">#Hive</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Hive 应用案列</div>
      <div>https://flepeng.github.io/045-Hive-24-案例-Hive-应用案列/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lepeng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年1月24日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/045-Hive-31-%E5%AD%97%E6%AE%B5-Hive-%E8%BF%90%E7%AE%97%E7%AC%A6/" title="Hive 运算符">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Hive 运算符</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/045-Hive-22-%E4%BD%BF%E7%94%A8-Hive-web%E7%95%8C%E9%9D%A2%E6%96%B9%E5%BC%8F/" title="Hive web界面方式">
                        <span class="hidden-mobile">Hive web界面方式</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"flepeng/hexo-blog-comment","repo-id":"R_kgDOL0qaig","category":"Announcements","category-id":"DIC_kwDOL0qais4CfBIv","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
